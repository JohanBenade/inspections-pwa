{% extends "base.html" %}

{% block title %}Cycle {{ cycle.cycle_number }} - {{ cycle.project_name }}{% endblock %}

{% block content %}
{% set floor_names = {0: 'Ground Floor', 1: '1st Floor', 2: '2nd Floor', 3: '3rd Floor'} %}
<style>
    .rich-notes p { margin: 0 0 2px 0; }
    .rich-notes ul { list-style-type: disc; margin-left: 20px; }
    .rich-notes ol { list-style-type: decimal; margin-left: 20px; }
    .rich-notes li { margin: 0 0 1px 0; }
</style>

<div class="max-w-4xl mx-auto">
    <a href="{{ url_for('cycles.list_cycles') }}" class="text-blue-600 hover:underline text-sm">
        &larr; Back to Cycles
    </a>

    <div class="flex justify-between items-start mt-2 mb-6 flex-wrap gap-3">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-900">Cycle {{ cycle.cycle_number }}</h1>
                {% if cycle.status == 'active' %}
                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded">Active</span>
                {% else %}
                <span class="text-sm bg-gray-100 text-gray-600 px-2 py-1 rounded">Closed</span>
                {% endif %}
            </div>
            <p class="text-gray-600">{{ cycle.project_name }} - {{ cycle.phase_name }}</p>
            {% if cycle.block %}
            <p class="text-sm text-blue-600">
                {{ cycle.block }}{% if cycle.floor is not none %} - {{ floor_names.get(cycle.floor, 'Floor ' ~ cycle.floor) }}{% endif %}
                {% if cycle.unit_start and cycle.unit_end %} | Units {{ cycle.unit_start }} to {{ cycle.unit_end }}{% endif %}
            </p>
            {% elif cycle.unit_start and cycle.unit_end %}
            <p class="text-sm text-blue-600">Units: {{ cycle.unit_start }} to {{ cycle.unit_end }}</p>
            {% endif %}
            <p class="text-sm text-gray-500">Created by {{ cycle.created_by_name }} on {{ cycle.created_at[:10] }}</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('cycles.edit_cycle', cycle_id=cycle.id) }}"
               class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit Cycle
            </a>
            <a href="{{ url_for('cycles.manage_units', cycle_id=cycle.id) }}"
               class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
                Manage Units
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="p-3 rounded-lg border {% if category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-green-50 border-green-200 text-green-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% set active_units = units|rejectattr('unit_id', 'in', excluded_unit_ids)|list %}
    {% set total_defects = active_units|sum(attribute='open_defects') %}
    {% set reviewed_count = active_units|selectattr('inspection_status', 'equalto', 'reviewed')|list|length %}
    {% set submitted_count = active_units|selectattr('inspection_status', 'equalto', 'submitted')|list|length %}
    {% set approved_count = active_units|selectattr('inspection_status', 'equalto', 'certified')|list|length + active_units|selectattr('inspection_status', 'equalto', 'pending_followup')|list|length %}
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">{{ active_units|length }}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Units</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-2xl font-bold {% if total_defects > 0 %}text-red-600{% else %}text-green-600{% endif %}">{{ total_defects }}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Open Defects</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-2xl font-bold text-orange-600">{{ excluded|length }}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Exclusions</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-2xl font-bold text-green-600">{{ reviewed_count + submitted_count + approved_count }}/{{ active_units|length }}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Complete</div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-4 border-b">
            <h2 class="font-semibold text-gray-900">Unit Summary</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Inspector</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Defects</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for unit in active_units %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-800">{{ unit.unit_number }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ unit.inspector_name or 'Not assigned' }}</td>
                        <td class="px-4 py-3">
                            {% if unit.open_defects and unit.open_defects > 0 %}
                            <span class="text-sm text-red-600 font-medium">{{ unit.open_defects }}</span>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.inspection_status == 'reviewed' %}
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">Reviewed</span>
                            {% elif unit.inspection_status == 'submitted' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                            {% elif unit.inspection_status == 'in_progress' %}
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">In Progress</span>
                            {% elif unit.inspection_status == 'certified' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Certified</span>
                            {% elif unit.inspection_status == 'pending_followup' %}
                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Pending</span>
                            {% else %}
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">Not Started</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            {% if unit.inspection_id %}
                            <a href="{{ url_for('inspection.inspect', inspection_id=unit.inspection_id) }}"
                               class="text-xs text-blue-600 hover:underline">Review</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if cycle.general_notes %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <h3 class="font-medium text-blue-800 mb-2">General Notes</h3>
        <div class="text-sm text-blue-700 rich-notes" style="white-space: pre-line;">{{ cycle.general_notes | safe }}</div>
    </div>
    {% endif %}

    {% if cycle.exclusion_notes %}
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
        <h3 class="font-medium text-orange-800 mb-2">Exclusion Notes</h3>
        <div class="text-sm text-orange-700 rich-notes" style="white-space: pre-line;">{{ cycle.exclusion_notes | safe }}</div>
    </div>
    {% endif %}

    {% if area_notes %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
        <h3 class="font-medium text-yellow-800 mb-2">Area Notes</h3>
        <div class="space-y-1">
            {% for note in area_notes %}
            <div class="text-sm">
                <span class="font-medium text-yellow-800">{{ note.area_name }}:</span>
                <span class="text-yellow-700">{{ note.note }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if excluded %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
        <a href="javascript:void(0)"
           onclick="var c=document.getElementById('excluded-list');var ch=this.querySelector('.exc-chv');c.classList.toggle('hidden');ch.classList.toggle('rotate-90');return false"
           ontouchend="event.preventDefault();this.click()"
           class="flex items-center gap-2 select-none"
           style="text-decoration:none">
            <svg class="exc-chv w-4 h-4 text-gray-400 transform transition-transform duration-200 flex-shrink-0"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <h3 class="font-medium text-gray-800">Excluded Items ({{ excluded|length }})</h3>
        </a>
        <div id="excluded-list" class="hidden mt-2 space-y-1">
            {% for item in excluded %}
            <div class="text-sm text-gray-700">
                {{ item.area_name }} / {{ item.category_name }} /
                {% if item.parent_description %}{{ item.parent_description }} / {% endif %}
                {{ item.item_description }}
                {% if item.reason %}<span class="text-gray-500">- {{ item.reason }}</span>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="border-t pt-4 mt-2 flex items-center gap-4">
        {% if cycle.status == 'active' %}
        {% if session.get('role') in ['manager', 'admin'] %}
        <form method="POST" action="{{ url_for('cycles.close_cycle', cycle_id=cycle.id) }}" class="inline">
            <button type="submit" class="text-sm text-orange-600 hover:text-orange-800"
                    onclick="return confirm('Close this cycle? No more inspections can be added.')">
                Close Cycle
            </button>
        </form>
        {% endif %}
        {% else %}
        <form method="POST" action="{{ url_for('cycles.reopen_cycle', cycle_id=cycle.id) }}" class="inline">
            <button type="submit" class="text-sm text-green-600 hover:text-green-800">Reopen Cycle</button>
        </form>
        {% endif %}
        {% if not has_inspections %}
        <form method="POST" action="{{ url_for('cycles.delete_cycle', cycle_id=cycle.id) }}" class="inline">
            <button type="submit" class="text-sm text-red-600 hover:text-red-800"
                    onclick="return confirm('Delete Cycle {{ cycle.cycle_number }}? This cannot be undone.')">
                Delete Cycle
            </button>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}
