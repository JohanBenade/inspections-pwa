{% extends "base.html" %}

{% block title %}Cycle {{ cycle.cycle_number }} - {{ cycle.project_name }}<!-- Custom Confirm Modal -->
<div id="confirm-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-40" onclick="closeConfirm()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 relative">
            <h3 class="text-lg font-semibold text-gray-900 mb-2" id="confirm-title"></h3>
            <p class="text-sm text-gray-600 mb-6" id="confirm-message"></p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirm()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Cancel
                </button>
                <button id="confirm-action" onclick="doConfirm()"
                        class="px-4 py-2 text-sm font-medium text-white rounded-lg">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
var pendingFormId = null;

function showUnitConfirm(formId, unitNum, excluding) {
    pendingFormId = formId;
    document.getElementById("confirm-title").textContent = (excluding ? "Exclude" : "Include") + " Unit " + unitNum;
    document.getElementById("confirm-message").textContent = excluding
        ? "This unit will be removed from the active cycle. You can include it again later."
        : "This unit will be added back to the active cycle.";
    var btn = document.getElementById("confirm-action");
    btn.textContent = excluding ? "Exclude" : "Include";
    btn.className = "px-4 py-2 text-sm font-medium text-white rounded-lg " + (excluding ? "bg-red-600 hover:bg-red-700" : "bg-green-600 hover:bg-green-700");
    document.getElementById("confirm-modal").classList.remove("hidden");
}

function closeConfirm() {
    document.getElementById("confirm-modal").classList.add("hidden");
    pendingFormId = null;
}

function doConfirm() {
    if (pendingFormId) {
        document.getElementById(pendingFormId).submit();
    }
    closeConfirm();
}

document.getElementById("confirm-action").addEventListener("click", doConfirm);
</script>
{% endblock %}

{% block content %}
{% set floor_names = {0: 'Ground Floor', 1: '1st Floor', 2: '2nd Floor', 3: '3rd Floor'} %}
<style>
    .rich-notes p { margin: 0 0 2px 0; }
    .rich-notes ul { list-style-type: disc; margin-left: 20px; }
    .rich-notes ol { list-style-type: decimal; margin-left: 20px; }
    .rich-notes li { margin: 0 0 1px 0; }
</style>

<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('cycles.list_cycles') }}" class="text-blue-600 hover:underline text-sm">
            &larr; Back to Cycles
        </a>
        <div class="flex justify-between items-start mt-2">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    Inspection Cycle {{ cycle.cycle_number }}
                    {% if cycle.status == 'active' %}
                    <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded ml-2">Active</span>
                    {% else %}
                    <span class="text-sm bg-gray-100 text-gray-600 px-2 py-1 rounded ml-2">Closed</span>
                    {% endif %}
                </h1>
                <p class="text-gray-600">{{ cycle.project_name }} - {{ cycle.phase_name }}</p>
                <p class="text-sm text-gray-500">Created by {{ cycle.created_by_name }} on {{ cycle.created_at[:10] }}</p>
                {% if cycle.block %}
                <p class="text-sm text-blue-600">
                    {{ cycle.block }}{% if cycle.floor is not none %} - {{ floor_names.get(cycle.floor, 'Floor ' ~ cycle.floor) }}{% endif %}
                    {% if cycle.unit_start and cycle.unit_end %} | Units {{ cycle.unit_start }} to {{ cycle.unit_end }}{% endif %}
                </p>
                {% elif cycle.unit_start and cycle.unit_end %}
                <p class="text-sm text-blue-600">Units: {{ cycle.unit_start }} to {{ cycle.unit_end }}</p>
                {% endif %}
            </div>
            <div class="flex gap-2">
                {% if cycle.status == 'active' %}
                <a href="{{ url_for('cycles.edit_cycle', cycle_id=cycle.id) }}" 
                   class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200">
                    Edit
                </a>
                <form method="POST" action="{{ url_for('cycles.close_cycle', cycle_id=cycle.id) }}" class="inline">
                    <button type="submit" class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg hover:bg-orange-200"
                            onclick="return confirm('Close this cycle? No more inspections can be added.')">
                        Close Cycle
                    </button>
                </form>
                {% else %}
                <form method="POST" action="{{ url_for('cycles.reopen_cycle', cycle_id=cycle.id) }}" class="inline">
                    <button type="submit" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200">
                        Reopen Cycle
                    </button>
                </form>
                {% endif %}
                {% if not has_inspections %}
                <form method="POST" action="{{ url_for('cycles.delete_cycle', cycle_id=cycle.id) }}" class="inline">
                    <button type="submit" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200"
                            onclick="return confirm('Delete Cycle {{ cycle.cycle_number }}? This cannot be undone.')">
                        Delete
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="p-3 rounded-lg border {% if category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-green-50 border-green-200 text-green-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- General Notes -->
    {% if cycle.general_notes %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 class="font-medium text-blue-800 mb-2">General Notes</h3>
        <div class="text-sm text-blue-700 rich-notes" style="white-space: pre-line;">{{ cycle.general_notes | safe }}</div>
    </div>
    {% endif %}

    <!-- Exclusion Notes -->
    {% if cycle.exclusion_notes %}
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
        <h3 class="font-medium text-orange-800 mb-2">Exclusion Notes</h3>
        <div class="text-sm text-orange-700 rich-notes" style="white-space: pre-line;">{{ cycle.exclusion_notes | safe }}</div>
    </div>
    {% endif %}

    <!-- Area Notes -->
    {% if area_notes %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <h3 class="font-medium text-yellow-800 mb-2">Area Notes</h3>
        <div class="space-y-1">
            {% for note in area_notes %}
            <div class="text-sm">
                <span class="font-medium text-yellow-800">{{ note.area_name }}:</span>
                <span class="text-yellow-700">{{ note.note }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Excluded Items -->
    {% if excluded %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
        <a href="javascript:void(0)"
           onclick="var c=document.getElementById('excluded-list');var ch=this.querySelector('.exc-chv');c.classList.toggle('hidden');ch.classList.toggle('rotate-90');return false"
           ontouchend="event.preventDefault();this.click()"
           class="flex items-center gap-2 select-none"
           style="text-decoration:none">
            <svg class="exc-chv w-4 h-4 text-gray-400 transform transition-transform duration-200 flex-shrink-0"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <h3 class="font-medium text-gray-800">Excluded Items ({{ excluded|length }})</h3>
        </a>
        <div id="excluded-list" class="hidden mt-2 space-y-1">
            {% for item in excluded %}
            <div class="text-sm text-gray-700">
                {{ item.area_name }} / {{ item.category_name }} / 
                {% if item.parent_description %}{{ item.parent_description }} / {% endif %}
                {{ item.item_description }}
                {% if item.reason %}<span class="text-gray-500">- {{ item.reason }}</span>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Units Grid with Inspector Assignment -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
            {% set active_units = units|rejectattr('unit_id', 'in', excluded_unit_ids)|list %}
            <h2 class="font-semibold">Units ({{ active_units|length }}{% if excluded_unit_ids %} of {{ units|length }}{% endif %})</h2>
            {% set assigned_count = assignment_map|length %}
            {% if assigned_count > 0 %}
            <span class="text-sm text-gray-500">{{ assigned_count }} assigned</span>
            {% endif %}
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Defects</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for unit in units %}
                    {% set is_excluded = unit.unit_id in excluded_unit_ids %}
                    <tr class="{% if is_excluded %}bg-gray-100 opacity-60{% else %}hover:bg-gray-50{% endif %}">
                        <td class="px-4 py-3">
                            <span class="font-medium {% if is_excluded %}text-gray-400 line-through{% else %}text-gray-800{% endif %}">{{ unit.unit_number }}</span>
                            {% if is_excluded %}<span class="text-xs text-gray-400 ml-1">(excluded)</span>{% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                {% if cycle.status == 'active' %}
                                <select name="inspector_id"
                                        hx-post="{{ url_for('cycles.assign_inspector', cycle_id=cycle.id) }}"
                                        hx-include="this"
                                        hx-vals='{"unit_id": "{{ unit.unit_id }}"}'
                                        hx-target="#assign-status-{{ unit.unit_number }}"
                                        hx-swap="innerHTML"
                                        class="text-sm border border-gray-300 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500">
                                    <option value="">-- Assign --</option>
                                    {% for insp in inspectors %}
                                    <option value="{{ insp.id }}" 
                                        {% if assignment_map.get(unit.unit_id) == insp.id %}selected
                                        {% elif unit.inspector_name == insp.name and not assignment_map.get(unit.unit_id) %}selected{% endif %}>
                                        {{ insp.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <span id="assign-status-{{ unit.unit_number }}"></span>
                                {% else %}
                                <span class="text-sm text-gray-600">{{ unit.inspector_name or 'Not assigned' }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.inspection_status == 'submitted' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                            {% elif unit.inspection_status == 'reviewed' %}
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">Reviewed</span>
                            {% elif unit.inspection_status == 'in_progress' %}
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">In Progress</span>
                            {% elif unit.inspection_status == 'certified' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Certified</span>
                            {% elif unit.inspection_status == 'pending_followup' %}
                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Pending</span>
                            {% else %}
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">Not Started</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.open_defects and unit.open_defects > 0 %}
                            <span class="text-sm text-red-600 font-medium">{{ unit.open_defects }}</span>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                {% if unit.inspection_id %}
                                <a href="{{ url_for('inspection.inspect', inspection_id=unit.inspection_id) }}"
                                   class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100">
                                    Review
                                </a>
                                {% endif %}
                                {% if cycle.status == 'active' and not unit.inspection_id %}
                                <form id="exclude-form-{{ unit.unit_number }}" method="POST" 
                                      action="{{ url_for('cycles.toggle_unit_exclusion', cycle_id=cycle.id) }}" class="inline">
                                    <input type="hidden" name="unit_id" value="{{ unit.unit_id }}">
                                    {% if is_excluded %}
                                    <button type="button"
                                            onclick="showUnitConfirm('exclude-form-{{ unit.unit_number }}', '{{ unit.unit_number }}', false)"
                                            class="text-xs text-green-600 hover:text-green-800 underline">
                                        Include
                                    </button>
                                    {% else %}
                                    <button type="button"
                                            onclick="showUnitConfirm('exclude-form-{{ unit.unit_number }}', '{{ unit.unit_number }}', true)"
                                            class="text-xs text-red-600 hover:text-red-800 underline">
                                        Exclude
                                    </button>
                                    {% endif %}
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
