{% extends "base.html" %}

{% block title %}Manage Units - Cycle {{ cycle.cycle_number }}{% endblock %}

{% block content %}
{% set floor_names = {0: 'Ground Floor', 1: '1st Floor', 2: '2nd Floor', 3: '3rd Floor'} %}

<div class="max-w-4xl mx-auto">
    <!-- Back -->
    <a href="{{ url_for('cycles.view_cycle', cycle_id=cycle.id) }}" class="text-blue-600 hover:underline text-sm">
        &larr; Back to Cycle {{ cycle.cycle_number }}
    </a>

    <!-- Header -->
    <div class="mt-2 mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Manage Units</h1>
        <p class="text-gray-600">
            Cycle {{ cycle.cycle_number }}{% if cycle.block %} - {{ cycle.block }}{% if cycle.floor is not none %}, {{ floor_names.get(cycle.floor, 'Floor ' ~ cycle.floor) }}{% endif %}{% endif %}
        </p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="p-3 rounded-lg border {% if category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-green-50 border-green-200 text-green-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Add Unit -->
    {% if cycle.status == "active" %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 class="font-medium text-blue-800 mb-3">Add Unit to Cycle</h3>
        <form method="POST" action="{{ url_for('cycles.add_unit', cycle_id=cycle.id) }}">
            <div class="flex flex-wrap items-end gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Unit Number</label>
                    <input type="text" name="unit_number" required placeholder="e.g. 057"
                           class="w-24 text-sm border border-gray-300 rounded px-3 py-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Block</label>
                    <input type="text" name="block" value="{{ unit_defaults.block or '' }}"
                           class="w-28 text-sm border border-gray-300 rounded px-3 py-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Floor</label>
                    <select name="floor" class="text-sm border border-gray-300 rounded px-3 py-2 focus:ring-1 focus:ring-blue-500">
                        <option value="0" {% if unit_defaults.floor == 0 %}selected{% endif %}>Ground Floor</option>
                        <option value="1" {% if unit_defaults.floor == 1 %}selected{% endif %}>1st Floor</option>
                        <option value="2" {% if unit_defaults.floor == 2 %}selected{% endif %}>2nd Floor</option>
                        <option value="3" {% if unit_defaults.floor == 3 %}selected{% endif %}>3rd Floor</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Type</label>
                    <input type="text" name="unit_type" value="{{ unit_defaults.unit_type or '4-Bed' }}"
                           class="w-24 text-sm border border-gray-300 rounded px-3 py-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                    Add Unit
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Units Table -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
            {% set active_units = units|rejectattr('unit_id', 'in', excluded_unit_ids)|list %}
            <h2 class="font-semibold text-gray-900">Units ({{ active_units|length }}{% if excluded_unit_ids %} of {{ units|length }}{% endif %})</h2>
            {% set assigned_count = assignment_map|length %}
            {% if assigned_count > 0 %}
            <span class="text-sm text-gray-500">{{ assigned_count }} assigned</span>
            {% endif %}
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Assign Inspector</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for unit in units %}
                    {% set is_excluded = unit.unit_id in excluded_unit_ids %}
                    <tr class="{% if is_excluded %}bg-gray-100 opacity-60{% else %}hover:bg-gray-50{% endif %}">
                        <td class="px-4 py-3">
                            <span class="font-medium {% if is_excluded %}text-gray-400 line-through{% else %}text-gray-800{% endif %}">{{ unit.unit_number }}</span>
                            {% if is_excluded %}<span class="text-xs text-gray-400 ml-1">(excluded)</span>{% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                {% if cycle.status == 'active' %}
                                <select name="inspector_id"
                                        hx-post="{{ url_for('cycles.assign_inspector', cycle_id=cycle.id) }}"
                                        hx-include="this"
                                        hx-vals='{"unit_id": "{{ unit.unit_id }}"}'
                                        hx-target="#assign-status-{{ unit.unit_number }}"
                                        hx-swap="innerHTML"
                                        class="text-sm border border-gray-300 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500">
                                    <option value="">-- Assign --</option>
                                    {% for insp in inspectors %}
                                    <option value="{{ insp.id }}"
                                        {% if assignment_map.get(unit.unit_id) == insp.id %}selected
                                        {% elif unit.inspector_name == insp.name and not assignment_map.get(unit.unit_id) %}selected{% endif %}>
                                        {{ insp.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <span id="assign-status-{{ unit.unit_number }}"></span>
                                {% else %}
                                <span class="text-sm text-gray-600">{{ unit.inspector_name or 'Not assigned' }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.inspection_status == 'submitted' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                            {% elif unit.inspection_status == 'reviewed' %}
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">Reviewed</span>
                            {% elif unit.inspection_status == 'in_progress' %}
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">In Progress</span>
                            {% elif unit.inspection_status == 'certified' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Certified</span>
                            {% elif unit.inspection_status == 'pending_followup' %}
                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Pending</span>
                            {% else %}
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">Not Started</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            {% if cycle.status == 'active' and not unit.inspection_id %}
                            <form id="exclude-form-{{ unit.unit_number }}" method="POST"
                                  action="{{ url_for('cycles.toggle_unit_exclusion', cycle_id=cycle.id) }}" class="inline">
                                <input type="hidden" name="unit_id" value="{{ unit.unit_id }}">
                                {% if is_excluded %}
                                <button type="button"
                                        onclick="showUnitConfirm('exclude-form-{{ unit.unit_number }}', '{{ unit.unit_number }}', false)"
                                        class="text-xs text-green-600 hover:text-green-800 underline">
                                    Include
                                </button>
                                {% else %}
                                <button type="button"
                                        onclick="showUnitConfirm('exclude-form-{{ unit.unit_number }}', '{{ unit.unit_number }}', true)"
                                        class="text-xs text-red-600 hover:text-red-800 underline">
                                    Exclude
                                </button>
                                {% endif %}
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="confirm-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-40" onclick="closeConfirm()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 relative">
            <h3 class="text-lg font-semibold text-gray-900 mb-2" id="confirm-title"></h3>
            <p class="text-sm text-gray-600 mb-6" id="confirm-message"></p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirm()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Cancel
                </button>
                <button id="confirm-action" onclick="doConfirm()"
                        class="px-4 py-2 text-sm font-medium text-white rounded-lg">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
var pendingFormId = null;

function showUnitConfirm(formId, unitNum, excluding) {
    pendingFormId = formId;
    document.getElementById("confirm-title").textContent = (excluding ? "Exclude" : "Include") + " Unit " + unitNum;
    document.getElementById("confirm-message").textContent = excluding
        ? "This unit will be removed from the active cycle. You can include it again later."
        : "This unit will be added back to the active cycle.";
    var btn = document.getElementById("confirm-action");
    btn.textContent = excluding ? "Exclude" : "Include";
    btn.className = "px-4 py-2 text-sm font-medium text-white rounded-lg " + (excluding ? "bg-red-600 hover:bg-red-700" : "bg-green-600 hover:bg-green-700");
    document.getElementById("confirm-modal").classList.remove("hidden");
}

function closeConfirm() {
    document.getElementById("confirm-modal").classList.add("hidden");
    pendingFormId = null;
}

function doConfirm() {
    if (pendingFormId) {
        document.getElementById(pendingFormId).submit();
    }
    closeConfirm();
}
</script>
{% endblock %}
