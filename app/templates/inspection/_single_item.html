{# Single inspection item partial - Inspect-First Flow #}
{# Required context: item, inspection, area, is_followup #}
{# Optional context: force_expanded (default false) - set by add/remove defect endpoints #}
{# NOTE: This template renders CONTENT ONLY. The wrapper <div id="item-{id}"> lives in area.html #}

{% set is_parent = item.parent_item_id is none and item.depth == 0 %}
{% set has_children = item.child_count > 0 %}
{% set is_child = item.parent_item_id is not none %}
{% set parent_not_installed = item.parent_status == 'not_installed' %}
{% set parent_pending = is_child and item.parent_status in [none, 'pending'] %}
{% set is_skipped = item.status == 'skipped' %}
{% set has_defect = item.has_open_defect %}
{% set show_as_defect = is_followup and has_defect %}
{% set has_chips = item.inspection_defects|length > 0 %}
{% set expanded = force_expanded|default(false) or (item.status == 'not_to_standard' and not has_chips) %}

{% if not is_skipped %}
<div class="p-3 {% if is_child %}pl-8 bg-gray-50{% endif %} {% if parent_not_installed or parent_pending %}opacity-40{% endif %} {% if item.status == 'not_to_standard' or (show_as_defect and item.status != 'ok') %}bg-red-50 border-l-4 border-red-400{% elif item.status == 'not_installed' %}bg-yellow-50 border-l-4 border-yellow-400{% elif item.status == 'ok' %}bg-green-50 border-l-4 border-green-400{% endif %}">

    {# Item description #}
    <div class="flex justify-between items-start mb-2">
        <div class="flex-1">
            {% if is_child %}<span class="text-gray-400 mr-1">-</span>{% endif %}
            <span class="text-sm {% if is_parent %}font-semibold{% else %}font-medium{% endif %} text-gray-800">
                {{ item.item_description }}
            </span>
        </div>
    </div>

    {# Previous defect info for followup cycles #}
    {% if show_as_defect %}
    <div class="mb-3 p-2 bg-red-100 rounded border border-red-200">
        <div class="text-xs font-medium text-red-800 mb-1">Previous defect (Cycle {{ item.defect_cycle }}):</div>
        <div class="text-sm text-red-700">{{ item.defect_comment or 'No comment' }}</div>
    </div>
    {% endif %}

    {# === BUTTONS === #}
    {% if is_parent and has_children %}
    {# Parent with children: Installed / Not Installed #}
    <div class="flex flex-wrap gap-2">
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">{% if show_as_defect %}Rectified{% else %}Installed{% endif %}</button>
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'not_installed' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">{% if show_as_defect %}Still Missing{% else %}Not Installed{% endif %}</button>
    </div>

    {% elif parent_not_installed %}
    <div class="text-xs text-gray-400 italic">Parent not installed</div>

    {% elif parent_pending %}
    <div class="text-xs text-gray-400 italic">Mark parent as Installed first</div>

    {% elif show_as_defect %}
    {# Followup: Rectified / Still Defective #}
    <div class="flex flex-wrap gap-2">
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">Rectified</button>
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "not_to_standard", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'not_to_standard' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">Still Defective</button>
    </div>

    {% else %}
    {# === INSPECT-FIRST FLOW === #}
    <div class="flex flex-wrap gap-2">
        {% if item.status == 'not_to_standard' %}
        <span class="px-3 py-2 rounded text-xs font-medium bg-red-500 text-white inline-flex items-center">N.T.S.</span>
        {% else %}
        {# Inspect button: pending/ok/ni items - always available to recover #}
        <a href="javascript:void(0)" id="inspect-btn-{{ item.id }}"
           onclick="var p=document.getElementById('inspect-panel-{{ item.id }}');p.style.display='block';this.style.display='none';var pills=p.querySelector('[hx-get]');if(pills&&!pills.dataset.loaded){htmx.trigger(pills,'loadPills');pills.dataset.loaded='1'}"
           ontouchend="event.preventDefault();this.click()"
           class="px-3 py-2 rounded text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 inline-flex items-center justify-center flex-1 text-center"
           style="text-decoration:none;min-height:38px">Inspect</a>
        {% endif %}
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">OK</button>
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'not_installed' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-yellow-100{% endif %}">N/I</button>
    </div>
    {% endif %}

    {# === DEFECT INPUT AREAS === #}

    {# NTS items (non-followup): chips + expandable input with Done/Add more #}
    {% if item.status == 'not_to_standard' and not show_as_defect %}
    <div class="mt-2 defect-input-wrapper" data-add-url="{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}" data-area-id="{{ area.id }}" data-item-id="item-{{ item.id }}">
        {% if has_chips %}
        <div class="flex flex-wrap gap-1.5 mb-2">
            {% for d in item.inspection_defects %}
            <span class="inline-flex items-center gap-1 px-2.5 py-1.5 bg-red-100 text-red-800 rounded text-xs font-medium">{{ d.description }}<button type="button" hx-delete="{{ url_for('inspection.remove_defect', inspection_id=inspection.id, item_id=item.id, defect_id=d.id) }}?area_id={{ area.id }}" hx-target="#item-{{ item.id }}" hx-swap="innerHTML" hx-confirm="Remove this defect?" class="ml-0.5 text-red-500 hover:text-red-700 font-bold" style="line-height:1">&times;</button></span>
            {% endfor %}
        </div>
        {% endif %}
        <div id="defect-expand-{{ item.id }}" {% if not expanded %}style="display:none"{% endif %}>
            <div class="flex gap-2">
                <input type="text" id="defect-input-{{ item.id }}" placeholder="Describe the defect..." autocomplete="off" class="flex-1 px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps" onkeydown="if(event.key==='Enter'){event.preventDefault();this.nextElementSibling.click()}">
                <button type="button" onclick="var inp=document.getElementById('defect-input-{{ item.id }}');var desc=inp.value.trim();if(!desc)return;htmx.ajax('POST','{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}',{target:'#item-{{ item.id }}',swap:'innerHTML',values:{description:desc,area_id:'{{ area.id }}'}})" class="px-3 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 flex-shrink-0">Add</button>
            </div>
            <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}" hx-trigger="load" hx-swap="innerHTML"></div>
            {% if has_chips %}
            <a href="javascript:void(0)" onclick="document.getElementById('defect-expand-{{ item.id }}').style.display='none';document.getElementById('defect-addmore-{{ item.id }}').style.display='inline-block'" class="inline-block mt-2 text-sm font-medium text-blue-600" style="text-decoration:none;padding:6px 0">Done</a>
            {% endif %}
        </div>
        {% if has_chips %}
        <a href="javascript:void(0)" id="defect-addmore-{{ item.id }}" {% if expanded %}style="display:none"{% endif %} onclick="document.getElementById('defect-expand-{{ item.id }}').style.display='block';this.style.display='none'" class="inline-block mt-1 text-sm font-medium text-blue-600" style="text-decoration:none;padding:6px 0">+ Add more</a>
        {% endif %}
    </div>

    {# Followup NTS/NI items: defect input (always expanded) #}
    {% elif item.status in ['not_to_standard', 'not_installed'] and show_as_defect %}
    <div class="mt-2 defect-input-wrapper" data-add-url="{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}" data-area-id="{{ area.id }}" data-item-id="item-{{ item.id }}">
        {% if has_chips %}
        <div class="flex flex-wrap gap-1.5 mb-2">
            {% for d in item.inspection_defects %}
            <span class="inline-flex items-center gap-1 px-2.5 py-1.5 bg-red-100 text-red-800 rounded text-xs font-medium">{{ d.description }}<button type="button" hx-delete="{{ url_for('inspection.remove_defect', inspection_id=inspection.id, item_id=item.id, defect_id=d.id) }}?area_id={{ area.id }}" hx-target="#item-{{ item.id }}" hx-swap="innerHTML" hx-confirm="Remove this defect?" class="ml-0.5 text-red-500 hover:text-red-700 font-bold" style="line-height:1">&times;</button></span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="flex gap-2">
            <input type="text" id="defect-input-{{ item.id }}" placeholder="Describe defect..." autocomplete="off" class="flex-1 px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps" onkeydown="if(event.key==='Enter'){event.preventDefault();this.nextElementSibling.click()}">
            <button type="button" onclick="var inp=document.getElementById('defect-input-{{ item.id }}');var desc=inp.value.trim();if(!desc)return;htmx.ajax('POST','{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}',{target:'#item-{{ item.id }}',swap:'innerHTML',values:{description:desc,area_id:'{{ area.id }}'}})" class="px-3 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 flex-shrink-0">Add</button>
        </div>
        <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}" hx-trigger="load" hx-swap="innerHTML"></div>
    </div>

    {# Followup item marked rectified #}
    {% elif show_as_defect and item.status == 'ok' %}
    <div class="mt-2 p-2 bg-green-50 rounded border border-green-200"><span class="text-sm text-green-700 font-medium">Marked as rectified</span></div>

    {# Pending/OK/NI items (non-followup): hidden inspect panel #}
    {% elif not show_as_defect and item.status != 'not_to_standard' %}
    <div id="inspect-panel-{{ item.id }}" style="display:none" class="mt-2 defect-input-wrapper" data-add-url="{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}" data-area-id="{{ area.id }}" data-item-id="item-{{ item.id }}">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">What to look for</div>
        <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}" hx-trigger="loadPills once" hx-swap="innerHTML"></div>
        <div class="flex gap-2 mt-2">
            <input type="text" id="defect-input-{{ item.id }}" placeholder="Describe the defect..." autocomplete="off" class="flex-1 px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps" onkeydown="if(event.key==='Enter'){event.preventDefault();this.nextElementSibling.click()}">
            <button type="button" onclick="var inp=document.getElementById('defect-input-{{ item.id }}');var desc=inp.value.trim();if(!desc)return;htmx.ajax('POST','{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}',{target:'#item-{{ item.id }}',swap:'innerHTML',values:{description:desc,area_id:'{{ area.id }}'}})" class="px-3 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 flex-shrink-0">Add</button>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
