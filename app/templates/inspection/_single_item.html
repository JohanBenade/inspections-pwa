{# Single inspection item partial - Inspect-First Flow #}
{# Required context: item, inspection, area, is_followup #}
{# Optional context: force_expanded (default false) - set by add/remove defect endpoints #}
{# NOTE: This template renders CONTENT ONLY. The wrapper <div id="item-{id}"> lives in area.html #}

{% set is_parent = item.parent_item_id is none and item.depth == 0 %}
{% set has_children = item.child_count > 0 %}
{% set is_child = item.parent_item_id is not none %}
{% set parent_not_installed = item.parent_status == 'not_installed' %}
{% set parent_pending = is_child and item.parent_status in [none, 'pending'] %}
{% set is_skipped = item.status == 'skipped' %}
{% set has_prior = item.has_prior_defects|default(false) %}
{% set has_open_prior = item.has_open_prior|default(false) %}
{% set was_ni = item.was_not_installed|default(false) %}
{% set show_prior = is_followup and has_prior %}
{% set has_chips = item.inspection_defects|length > 0 %}
{% set has_current = item.current_defects|default([])|length > 0 %}
{% set expanded = force_expanded|default(false) or (item.status == 'not_to_standard' and not has_chips and not show_prior and not has_current) %}

{% if not is_skipped %}
<div class="p-3 {% if is_child %}pl-8 bg-gray-50{% endif %} {% if parent_not_installed or parent_pending %}opacity-40{% endif %} {% if show_prior and (has_open_prior or has_chips or has_current) %}bg-red-50 border-l-4 border-red-400{% elif show_prior and not has_open_prior and not has_chips and not has_current %}bg-green-50 border-l-4 border-green-400{% elif has_current %}bg-red-50 border-l-4 border-red-400{% elif item.status == 'not_to_standard' %}bg-red-50 border-l-4 border-red-400{% elif item.status == 'not_installed' %}bg-yellow-50 border-l-4 border-yellow-400{% elif item.status == 'ok' %}bg-green-50 border-l-4 border-green-400{% endif %}">

    {# Item description #}
    <div class="flex justify-between items-start mb-2">
        <div class="flex-1">
            {% if is_child %}<span class="text-gray-400 mr-1">-</span>{% endif %}
            <span class="text-sm {% if is_parent %}font-semibold{% else %}font-medium{% endif %} text-gray-800">
                {{ item.item_description }}
            </span>
        </div>
    </div>

    {# ============================================================ #}
    {# PRIOR DEFECTS SECTION (R2+ only, per-defect Clear/Undo)      #}
    {# ============================================================ #}
    {% if show_prior %}
    <div class="mb-3 p-2.5 bg-gray-100 rounded border border-gray-200">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Prior Defects</div>
        {% for pd in item.prior_defects %}
        <div class="flex items-center justify-between py-1.5 {% if not loop.last %}border-b border-gray-200{% endif %}">
            {% if pd.status == 'cleared' %}
            <div class="flex-1 mr-2">
                <span class="text-sm text-gray-400 line-through">{{ pd.comment or 'No comment' }}</span>
                <span class="ml-1.5 text-xs font-medium text-green-600">Rectified</span>
            </div>
            <button type="button"
                hx-post="{{ url_for('inspection.reopen_prior_defect', inspection_id=inspection.id, defect_id=pd.id) }}"
                hx-vals='{"area_id": "{{ area.id }}"}'
                hx-target="#item-{{ item.id }}"
                hx-swap="innerHTML"
                class="text-xs text-blue-600 hover:text-blue-800 font-medium flex-shrink-0 px-2 py-1"
                style="text-decoration:none">Undo</button>
            {% else %}
            <div class="flex-1 mr-2">
                <span class="text-sm text-gray-700">{{ pd.comment or 'No comment' }}</span>
                <span class="ml-1.5 text-xs text-gray-400">C{{ pd.cycle }}</span>
            </div>
            <button type="button"
                hx-post="{{ url_for('inspection.clear_prior_defect', inspection_id=inspection.id, defect_id=pd.id) }}"
                hx-vals='{"area_id": "{{ area.id }}"}'
                hx-target="#item-{{ item.id }}"
                hx-swap="innerHTML"
                class="text-xs font-medium text-green-700 bg-green-100 hover:bg-green-200 rounded px-2.5 py-1.5 flex-shrink-0 transition-colors"
                style="text-decoration:none">Clear</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ============================================================ #}
    {# CURRENT-CYCLE DEFECTS (from defect table, for submitted inspections) #}
    {# ============================================================ #}
    {% if has_current %}
    <div class="mb-3">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">Current Cycle Defects</div>
        <div class="flex flex-wrap gap-1.5">
            {% for cd in item.current_defects %}
            <span class="inline-flex items-center gap-1 px-2.5 py-1.5 bg-red-100 text-red-800 rounded text-xs font-medium">{{ cd.comment }}<button type="button" hx-delete="{{ url_for('inspection.delete_current_defect', inspection_id=inspection.id, defect_id=cd.id) }}?area_id={{ area.id }}" hx-target="#item-{{ item.id }}" hx-swap="innerHTML" hx-confirm="Remove this defect?" class="ml-0.5 text-red-500 hover:text-red-700 font-bold" style="line-height:1">&times;</button></span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ============================================================ #}
    {# BUTTONS SECTION                                               #}
    {# ============================================================ #}
    {% if show_prior and not was_ni %}
    {# NTS items with prior defects: NO item-level buttons.
       Clearing all defects = OK. Leaving any open = NTS.
       Status summary shown when all cleared. #}
    {% if not has_open_prior and not has_chips and not has_current %}
    <div class="flex items-center gap-1.5 text-sm text-green-700 font-medium">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        All prior defects cleared
    </div>
    {% elif has_open_prior and item.status == 'pending' %}
    {# Inspector hasn't actioned yet - show confirm button #}
    <div class="mt-2">
        <button type="button"
            hx-post="{{ url_for('inspection.confirm_defects_remain', inspection_id=inspection.id, item_id=item.id) }}"
            hx-vals='{"area_id": "{{ area.id }}"}'
            hx-target="#item-{{ item.id }}"
            hx-swap="innerHTML"
            class="px-3 py-2 rounded text-xs font-medium bg-red-100 text-red-700 hover:bg-red-200 transition-colors">
            Defects Remain
        </button>
    </div>
    {% elif has_open_prior and item.status == 'not_to_standard' %}
    <div class="flex items-center gap-1.5 text-sm text-red-600 font-medium mt-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        Defects confirmed open
    </div>
    {% endif %}

    {% elif show_prior and was_ni %}
    {# NI items: show Installed/Not Installed buttons.
       Installed = auto-clears NI defects, opens inspect panel for quality check.
       Not Installed = stays NI. #}
    <div class="flex flex-wrap gap-2 mt-2">
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "ok", "area_id": "{{ area.id }}", "clear_ni_defects": "1"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status in ['ok', 'not_to_standard'] %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">Installed</button>
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'not_installed' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">Not Installed</button>
    </div>

    {% elif is_followup and is_parent and has_children and not has_prior and item.status == 'ok' %}
    {# C2: Parent OK in C1, no own defects - children handle themselves #}
    <div class="text-xs text-green-600 italic">Carried forward - OK</div>

    {% elif is_parent and has_children %}
    {# Parent with children: Installed / Not Installed (C1 only, or C2 parent WITH defects) #}
    <div class="flex flex-wrap gap-2">
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status in ['ok', 'not_to_standard'] %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">Installed</button>
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'not_installed' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">Not Installed</button>
    </div>

    {% elif parent_not_installed %}
    <div class="text-xs text-gray-400 italic">Parent not installed</div>

    {% elif parent_pending %}
    <div class="text-xs text-gray-400 italic">Mark parent as Installed first</div>

    {% else %}
    {# === INSPECT-FIRST FLOW (C1 or C2 items without prior defects) === #}
    <div class="flex flex-wrap gap-2">
        {% if item.status == 'not_to_standard' %}
        <span class="px-3 py-2 rounded text-xs font-medium bg-red-500 text-white inline-flex items-center">N.T.S.</span>
        {% else %}
        {# Inspect button: pending/ok/ni items - always available to recover #}
        <a href="javascript:void(0)" id="inspect-btn-{{ item.id }}"
           onclick="var p=document.getElementById('inspect-panel-{{ item.id }}');p.style.display='block';this.style.display='none';var pills=p.querySelector('[hx-get]');if(pills&&!pills.dataset.loaded){htmx.trigger(pills,'loadPills');pills.dataset.loaded='1'}"
           ontouchend="event.preventDefault();this.click()"
           class="px-3 py-2 rounded text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 inline-flex items-center justify-center flex-1 text-center"
           style="text-decoration:none;min-height:38px">Inspect</a>
        {% endif %}
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status in ['ok', 'not_to_standard'] %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">OK</button>
        <button type="button" hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}" hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}' hx-target="#item-{{ item.id }}" hx-swap="innerHTML" class="px-3 py-2 rounded text-xs font-medium transition-colors {% if item.status == 'not_installed' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-yellow-100{% endif %}">N/I</button>
    </div>
    {% endif %}

    {# ============================================================ #}
    {# DEFECT INPUT AREAS                                            #}
    {# ============================================================ #}

    {# Current defect chips + input for items with prior or current defects (R2) #}
    {% if show_prior or has_current %}
    <div class="mt-2 defect-input-wrapper" data-add-url="{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}" data-area-id="{{ area.id }}" data-item-id="item-{{ item.id }}">
        {% if has_chips %}
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">New defects found</div>
        <div class="flex flex-wrap gap-1.5 mb-2">
            {% for d in item.inspection_defects %}
            <span class="inline-flex items-center gap-1 px-2.5 py-1.5 bg-red-100 text-red-800 rounded text-xs font-medium">{{ d.description }}<button type="button" hx-delete="{{ url_for('inspection.remove_defect', inspection_id=inspection.id, item_id=item.id, defect_id=d.id) }}?area_id={{ area.id }}" hx-target="#item-{{ item.id }}" hx-swap="innerHTML" hx-confirm="Remove this defect?" class="ml-0.5 text-red-500 hover:text-red-700 font-bold" style="line-height:1">&times;</button></span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="flex gap-2">
            <input type="text" id="defect-input-{{ item.id }}" placeholder="Add new defect found..." autocomplete="off" class="flex-1 px-3 py-2 border-2 border-gray-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps" onkeydown="if(event.key==='Enter'){event.preventDefault();this.nextElementSibling.click()}">
            <button type="button" onclick="var inp=document.getElementById('defect-input-{{ item.id }}');var desc=inp.value.trim();if(!desc)return;htmx.ajax('POST','{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}',{target:'#item-{{ item.id }}',swap:'innerHTML',values:{description:desc,area_id:'{{ area.id }}'}})" class="px-3 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 flex-shrink-0">Add</button>
        </div>
        <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}" hx-trigger="load" hx-swap="innerHTML"></div>
    </div>

    {# NTS items (non-followup, no prior/current defects): chips + expandable input with Done/Add more #}
    {% elif item.status == 'not_to_standard' and not has_current %}
    <div class="mt-2 defect-input-wrapper" data-add-url="{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}" data-area-id="{{ area.id }}" data-item-id="item-{{ item.id }}">
        {% if has_chips %}
        <div class="flex flex-wrap gap-1.5 mb-2">
            {% for d in item.inspection_defects %}
            <span class="inline-flex items-center gap-1 px-2.5 py-1.5 bg-red-100 text-red-800 rounded text-xs font-medium">{{ d.description }}<button type="button" hx-delete="{{ url_for('inspection.remove_defect', inspection_id=inspection.id, item_id=item.id, defect_id=d.id) }}?area_id={{ area.id }}" hx-target="#item-{{ item.id }}" hx-swap="innerHTML" hx-confirm="Remove this defect?" class="ml-0.5 text-red-500 hover:text-red-700 font-bold" style="line-height:1">&times;</button></span>
            {% endfor %}
        </div>
        {% endif %}
        <div id="defect-expand-{{ item.id }}" {% if not expanded %}style="display:none"{% endif %}>
            <div class="flex gap-2">
                <input type="text" id="defect-input-{{ item.id }}" placeholder="Describe the defect..." autocomplete="off" class="flex-1 px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps" onkeydown="if(event.key==='Enter'){event.preventDefault();this.nextElementSibling.click()}">
                <button type="button" onclick="var inp=document.getElementById('defect-input-{{ item.id }}');var desc=inp.value.trim();if(!desc)return;htmx.ajax('POST','{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}',{target:'#item-{{ item.id }}',swap:'innerHTML',values:{description:desc,area_id:'{{ area.id }}'}})" class="px-3 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 flex-shrink-0">Add</button>
            </div>
            <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}" hx-trigger="load" hx-swap="innerHTML"></div>
            {% if has_chips %}
            <a href="javascript:void(0)" onclick="document.getElementById('defect-expand-{{ item.id }}').style.display='none';document.getElementById('defect-addmore-{{ item.id }}').style.display='inline-block'" class="inline-block mt-2 text-sm font-medium text-blue-600" style="text-decoration:none;padding:6px 0">Done</a>
            {% endif %}
        </div>
        {% if has_chips %}
        <a href="javascript:void(0)" id="defect-addmore-{{ item.id }}" {% if expanded %}style="display:none"{% endif %} onclick="document.getElementById('defect-expand-{{ item.id }}').style.display='block';this.style.display='none'" class="inline-block mt-1 text-sm font-medium text-blue-600" style="text-decoration:none;padding:6px 0">+ Add more</a>
        {% endif %}
    </div>

    {# Pending/OK/NI items (non-followup, no prior/current defects): hidden inspect panel #}
    {% elif not show_prior and not has_current and item.status != 'not_to_standard' %}
    <div id="inspect-panel-{{ item.id }}" style="display:none" class="mt-2 defect-input-wrapper" data-add-url="{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}" data-area-id="{{ area.id }}" data-item-id="item-{{ item.id }}">
        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">What to look for</div>
        <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}" hx-trigger="loadPills once" hx-swap="innerHTML"></div>
        <div class="flex gap-2 mt-2">
            <input type="text" id="defect-input-{{ item.id }}" placeholder="Describe the defect..." autocomplete="off" class="flex-1 px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps" onkeydown="if(event.key==='Enter'){event.preventDefault();this.nextElementSibling.click()}">
            <button type="button" onclick="var inp=document.getElementById('defect-input-{{ item.id }}');var desc=inp.value.trim();if(!desc)return;htmx.ajax('POST','{{ url_for('inspection.add_defect', inspection_id=inspection.id, item_id=item.id) }}',{target:'#item-{{ item.id }}',swap:'innerHTML',values:{description:desc,area_id:'{{ area.id }}'}})" class="px-3 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 flex-shrink-0">Add</button>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
