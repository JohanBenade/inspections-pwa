<!-- Area inspection partial - loaded via HTMX -->
<div class="space-y-6">
    {% if area_note %}
    <!-- Area-specific note from architect -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
        <span class="text-xs font-medium text-yellow-800">Note:</span>
        <span class="text-sm text-yellow-700">{{ area_note }}</span>
    </div>
    {% endif %}
    
    {% for category in categories %}
    <div class="border rounded-lg overflow-hidden {% if category.all_skipped %}opacity-60{% endif %}">
        <!-- Category Header -->
        <div class="bg-gray-100 px-4 py-3 border-b">
            <h3 class="font-semibold text-gray-800">{{ category.name }}</h3>
        </div>
        
        {% if category.all_skipped %}
        <!-- All items excluded - show message -->
        <div class="bg-orange-50 px-4 py-3 border-b">
            <span class="text-xs text-orange-600 font-medium">Excluded this cycle</span>
        </div>
        {% else %}
        <!-- Category Comment (general comment for this category) -->
        <div class="bg-gray-50 px-4 py-2 border-b">
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 font-medium">General:</span>
                <input type="text" 
                       placeholder="Add category-level comment..."
                       value="{{ category.comment.latest_comment if category.comment else '' }}"
                       class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                       hx-post="{{ url_for('inspection.update_category_comment', inspection_id=inspection.id, category_id=category.id) }}"
                       hx-vals='{"area_id": "{{ area.id }}"}'
                       hx-trigger="blur changed, keydown[key=='Enter']"
                       hx-target="#area-content"
                       name="comment">
                {% if category.comment %}
                <span class="text-xs text-green-600">Saved</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Items -->
        <div class="divide-y">
            {% for item in category.checklist %}
            {% set is_parent = item.parent_item_id is none and item.depth == 0 %}
            {% set has_children = item.child_count > 0 %}
            {% set is_child = item.parent_item_id is not none %}
            {% set parent_not_installed = item.parent_status == 'not_installed' %}
            {% set is_skipped = item.status == 'skipped' %}
            
            <div class="p-3 {% if is_child %}pl-8 bg-gray-50{% endif %} {% if parent_not_installed or is_skipped %}opacity-40{% endif %}">
                <!-- Item Description -->
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        {% if is_child %}
                        <span class="text-gray-400 mr-1">-</span>
                        {% endif %}
                        <span class="text-sm {% if is_parent %}font-semibold{% else %}font-medium{% endif %} text-gray-800">
                            {{ item.item_description }}
                        </span>
                        {% if is_skipped %}
                        <span class="text-xs text-orange-500 ml-2">(Excluded this cycle)</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if is_skipped %}
                <!-- Skipped item - no controls -->
                
                {% elif is_parent and has_children %}
                <!-- Parent item WITH children: Installed / Not Installed -->
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">
                        Installed
                    </button>
                    
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'not_installed' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">
                        Not Installed
                    </button>
                </div>
                
                <!-- Comment for not installed parent -->
                {% if item.status == 'not_installed' %}
                <div class="mt-2">
                    <input type="text" 
                           value="{{ item.comment or '' }}"
                           placeholder="Describe issue..."
                           class="w-full px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500"
                           hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                           hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                           hx-trigger="blur changed, keydown[key=='Enter']"
                           hx-target="#area-content"
                           name="comment">
                </div>
                {% endif %}
                
                {% elif parent_not_installed %}
                <!-- Child item greyed out -->
                <div class="text-xs text-gray-400 italic">Parent not installed</div>
                
                {% else %}
                <!-- Child or standalone item: full status buttons -->
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">
                        OK
                    </button>
                    
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "not_to_standard", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'not_to_standard' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">
                        N.T.S.
                    </button>
                    
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'not_installed' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-yellow-100{% endif %}">
                        N/I
                    </button>
                </div>
                
                <!-- Comment for defective items -->
                {% if item.status in ['not_to_standard', 'not_installed'] %}
                <div class="mt-2">
                    <input type="text" 
                           value="{{ item.comment or '' }}"
                           placeholder="Describe the defect... (Enter to save)"
                           class="w-full px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500"
                           hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                           hx-vals='{"status": "{{ item.status }}", "area_id": "{{ area.id }}"}'
                           hx-trigger="blur changed, keydown[key=='Enter']"
                           hx-target="#area-content"
                           name="comment">
                    {% if item.comment %}
                    <span class="text-xs text-green-600">Saved</span>
                    {% else %}
                    <span class="text-xs text-red-500">Required</span>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    // Trigger progress bar refresh
    document.body.dispatchEvent(new CustomEvent('areaUpdated'));
</script>
