<!-- Area inspection partial - loaded via HTMX -->
<div class="space-y-4">
    {% if show_filter %}
    <!-- Filter Toggle + Expand/Collapse -->
    <div class="flex justify-between items-center mb-4">
        <div class="flex gap-2">
            {% if is_followup %}
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=defects"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'defects' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                All Defects
            </button>
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=to_inspect"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'to_inspect' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                To Inspect
            </button>
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=inspected"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'inspected' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Inspected
            </button>
            {% else %}
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=all"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'all' %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                All Items
            </button>
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=defects"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'defects' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Defects Only
            </button>

            {% endif %}
        </div>
        <a href="javascript:void(0)" id="toggle-all-btn"
           onclick="var cats=document.querySelectorAll('.cat-content');var chevs=document.querySelectorAll('.cat-chevron');var btn=this;var anyHidden=false;cats.forEach(function(c){if(c.classList.contains('hidden'))anyHidden=true});cats.forEach(function(c){if(anyHidden)c.classList.remove('hidden');else c.classList.add('hidden')});chevs.forEach(function(ch){if(anyHidden)ch.classList.add('rotate-90');else ch.classList.remove('rotate-90')});btn.textContent=anyHidden?'Collapse All':'Expand All';return false"
           ontouchend="event.preventDefault();this.click()"
           class="text-sm text-blue-600 font-medium"
           style="text-decoration:none">
            Expand All
        </a>
    </div>
    {% endif %}

    {% if area_note %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
        <span class="text-xs font-medium text-yellow-800">Note:</span>
        <span class="text-sm text-yellow-700">{{ area_note.note if area_note.note else area_note }}</span>
    </div>
    {% endif %}
    
    {% for category in categories %}
    {% if category.checklist or category.all_skipped %}
    
    {% if category.all_skipped and filter_mode != 'excluded' %}
        {# Fully excluded categories hidden from All Items and Defects views #}
    {% else %}
    
    {# Count active items, marked items, and defects (from defect table + chips) for this category #}
    {% set ns = namespace(active=0, marked=0, defects=0) %}
    {% for item in category.checklist %}
        {% if item.status != 'skipped' %}
            {% set ns.active = ns.active + 1 %}
            {% if item.status not in ['pending', 'skipped'] %}
                {% set ns.marked = ns.marked + 1 %}
            {% endif %}
            {% set ns.defects = ns.defects + (item.current_defects|default([])|length) %}
            {% for pd in item.prior_defects|default([]) %}
                {% if pd.status == 'open' %}
                    {% set ns.defects = ns.defects + 1 %}
                {% endif %}
            {% endfor %}
            {% set ns.defects = ns.defects + (item.inspection_defects|default([])|length) %}
        {% endif %}
    {% endfor %}
    
    <div class="border rounded-lg overflow-hidden">
        <!-- Category Header -->
        <div class="bg-gray-100 px-4 py-3 border-b flex items-center select-none">
            <div onclick="var h=this.closest('.bg-gray-100');var c=h.nextElementSibling;var ch=this.querySelector('.cat-chevron');if(c)c.classList.toggle('hidden');if(ch)ch.classList.toggle('rotate-90')"
                 ontouchend="event.preventDefault();this.click()"
                 class="flex items-center justify-center flex-shrink-0 mr-1 cursor-pointer"
                 role="button"
                 style="width:44px;height:44px;margin:-8px 0 -8px -10px">
                <svg class="cat-chevron w-4 h-4 text-gray-400 transform transition-transform duration-200"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
            <h3 class="font-semibold text-gray-800 flex-1">{{ category.name }}</h3>
            {% if category.all_skipped %}
            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-medium ml-2">{{ category.checklist|length }} excluded</span>
            {% else %}
            <span class="flex items-center gap-2 ml-2 flex-shrink-0">
                {% if ns.active > 0 %}
                <span class="text-xs {% if ns.marked == ns.active %}text-green-600 font-medium{% else %}text-gray-500{% endif %}">
                    {{ ns.marked }}/{{ ns.active }}{% if ns.marked == ns.active %} &#10003;{% endif %}
                </span>
                {% endif %}
                {% if ns.defects > 0 %}
                <span class="text-xs text-red-600 font-medium">{{ ns.defects }} defect{% if ns.defects != 1 %}s{% endif %}</span>
                {% endif %}
            </span>
            {% endif %}
        </div>
        
        <!-- Category Content - hidden by default -->
        <div class="cat-content hidden">
            {% if category.all_skipped %}
            <!-- Excluded items list -->
            <div class="divide-y">
                {% for item in category.checklist %}
                <div class="p-3 opacity-40">
                    <span class="text-sm text-gray-600">{{ item.item_description }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Category comment -->
            <div class="bg-gray-50 px-4 py-2 border-b">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 font-medium">General:</span>
                    <input type="text" 
                           placeholder="Add category-level comment..."
                           value="{{ category.comment.latest_comment if category.comment else '' }}"
                           autocomplete="off"
                           class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 auto-caps"
                           hx-post="{{ url_for('inspection.update_category_comment', inspection_id=inspection.id, category_id=category.id) }}"
                           hx-vals='{"area_id": "{{ area.id }}"}'
                           hx-trigger="blur changed, keydown[key=='Enter']"
                           hx-target="#area-content"
                           hx-swap="innerHTML"
                           name="comment">
                    {% if category.comment %}
                    <span class="text-xs text-green-600">Saved</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Items -->
            <div class="divide-y">
                {% for item in category.checklist %}
                {% if item.status != 'skipped' %}
                <div id="item-{{ item.id }}">
                {% include 'inspection/_single_item.html' %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% endif %}
    {% endfor %}
    
    {% if not categories %}
    <div class="text-center py-8 text-gray-500">
        {% if filter_mode == 'defects' or filter_mode == 'to_inspect' %}
        No defects in this area
        {% elif filter_mode == 'inspected' %}
        No inspected items in this area
        {% else %}
        No items in this area
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    /* Progress + badge refresh on full area load */
    document.body.dispatchEvent(new CustomEvent('areaUpdated'));
</script>
