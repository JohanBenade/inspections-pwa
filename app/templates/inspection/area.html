<!-- Area inspection partial - loaded via HTMX -->
<div class="space-y-4">
    {% if show_filter %}
    <!-- Filter Toggle + Expand/Collapse -->
    <div class="flex justify-between items-center mb-4">
        <div class="flex gap-2">
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=all"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'all' %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                All Items
            </button>
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=defects"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'defects' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Defects Only
            </button>
            <button type="button"
                hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=excluded"
                hx-target="#area-content"
                hx-swap="innerHTML"
                class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                       {% if filter_mode == 'excluded' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Excluded
            </button>
        </div>
        <a href="javascript:void(0)" id="toggle-all-btn"
           onclick="var cats=document.querySelectorAll('.cat-content');var chevs=document.querySelectorAll('.cat-chevron');var btn=this;var anyHidden=false;cats.forEach(function(c){if(c.classList.contains('hidden'))anyHidden=true});cats.forEach(function(c){if(anyHidden)c.classList.remove('hidden');else c.classList.add('hidden')});chevs.forEach(function(ch){if(anyHidden)ch.classList.add('rotate-90');else ch.classList.remove('rotate-90')});btn.textContent=anyHidden?'Collapse All':'Expand All';return false"
           ontouchend="event.preventDefault();this.click()"
           class="text-sm text-blue-600 font-medium"
           style="text-decoration:none">
            Expand All
        </a>
    </div>
    {% endif %}

    {% if area_note %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
        <span class="text-xs font-medium text-yellow-800">Note:</span>
        <span class="text-sm text-yellow-700">{{ area_note.note if area_note.note else area_note }}</span>
    </div>
    {% endif %}
    
    {% for category in categories %}
    {% if category.checklist or category.all_skipped %}
    
    {% if category.all_skipped and filter_mode != 'excluded' %}
        {# Fully excluded categories hidden from All Items and Defects views #}
    {% else %}
    
    {# Count active items, marked items, and defects for this category #}
    {% set ns = namespace(active=0, marked=0, defects=0) %}
    {% for item in category.checklist %}
        {% if item.status != 'skipped' %}
            {% set ns.active = ns.active + 1 %}
            {% if item.status not in ['pending', 'skipped'] %}
                {% set ns.marked = ns.marked + 1 %}
            {% endif %}
            {% if item.status in ['not_to_standard', 'not_installed'] %}
                {% set ns.defects = ns.defects + 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    <div class="border rounded-lg overflow-hidden">
        <!-- Category Header -->
        <a href="javascript:void(0)"
           onclick="var c=this.nextElementSibling;var ch=this.querySelector('.cat-chevron');if(c)c.classList.toggle('hidden');if(ch)ch.classList.toggle('rotate-90');return false"
           ontouchend="event.preventDefault();var c=this.nextElementSibling;var ch=this.querySelector('.cat-chevron');if(c)c.classList.toggle('hidden');if(ch)ch.classList.toggle('rotate-90')"
           class="bg-gray-100 px-4 py-3 border-b flex items-center select-none block"
           role="button"
           style="text-decoration:none">
            <svg class="cat-chevron w-4 h-4 text-gray-400 transform transition-transform duration-200 mr-3 flex-shrink-0"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <h3 class="font-semibold text-gray-800 flex-1">{{ category.name }}</h3>
            {% if category.all_skipped %}
            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-medium ml-2">{{ category.checklist|length }} excluded</span>
            {% else %}
            <span class="flex items-center gap-2 ml-2 flex-shrink-0">
                {% if ns.active > 0 %}
                <span class="text-xs {% if ns.marked == ns.active %}text-green-600 font-medium{% else %}text-gray-500{% endif %}">
                    {{ ns.marked }}/{{ ns.active }}{% if ns.marked == ns.active %} &#10003;{% endif %}
                </span>
                {% endif %}
                {% if ns.defects > 0 %}
                <span class="text-xs text-red-600 font-medium">{{ ns.defects }} defect{% if ns.defects != 1 %}s{% endif %}</span>
                {% endif %}
            </span>
            {% endif %}
        </a>
        
        <!-- Category Content - hidden by default -->
        <div class="cat-content">
            {% if category.all_skipped %}
            <!-- Excluded items list -->
            <div class="divide-y">
                {% for item in category.checklist %}
                <div class="p-3 opacity-40">
                    <span class="text-sm text-gray-600">{{ item.item_description }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Category comment -->
            <div class="bg-gray-50 px-4 py-2 border-b">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 font-medium">General:</span>
                    <input type="text" 
                           placeholder="Add category-level comment..."
                           value="{{ category.comment.latest_comment if category.comment else '' }}"
                           autocomplete="off"
                           class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 auto-caps"
                           hx-post="{{ url_for('inspection.update_category_comment', inspection_id=inspection.id, category_id=category.id) }}"
                           hx-vals='{"area_id": "{{ area.id }}"}'
                           hx-trigger="blur changed, keydown[key=='Enter']"
                           hx-target="#area-content"
                           name="comment">
                    {% if category.comment %}
                    <span class="text-xs text-green-600">Saved</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Items -->
            <div class="divide-y">
                {% for item in category.checklist %}
                {% set is_parent = item.parent_item_id is none and item.depth == 0 %}
                {% set has_children = item.child_count > 0 %}
                {% set is_child = item.parent_item_id is not none %}
                {% set parent_not_installed = item.parent_status == 'not_installed' %}
                {% set is_skipped = item.status == 'skipped' %}
                {% set has_defect = item.has_open_defect %}
                {% set is_defective = item.status in ['not_to_standard', 'not_installed'] %}
                {% set show_as_defect = is_followup and has_defect %}
                
                {% if is_skipped %}
                    {# Excluded items hidden - use Excluded filter to see them #}
                {% else %}
                <div class="p-3 {% if is_child %}pl-8 bg-gray-50{% endif %} {% if parent_not_installed %}opacity-40{% endif %} {% if show_as_defect %}bg-red-50 border-l-4 border-red-400{% endif %}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            {% if is_child %}
                            <span class="text-gray-400 mr-1">-</span>
                            {% endif %}
                            <span class="text-sm {% if is_parent %}font-semibold{% else %}font-medium{% endif %} text-gray-800">
                                {{ item.item_description }}
                            </span>
                        </div>
                    </div>
                    
                    {% if show_as_defect %}
                    <div class="mb-3 p-2 bg-red-100 rounded border border-red-200">
                        <div class="text-xs font-medium text-red-800 mb-1">
                            Previous defect (Cycle {{ item.defect_cycle }}):
                        </div>
                        <div class="text-sm text-red-700">
                            {{ item.defect_comment or 'No comment' }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if is_parent and has_children %}
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                            hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                            hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}'
                            hx-target="#area-content"
                            class="px-3 py-2 rounded text-xs font-medium transition-colors
                                   {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">
                            {% if show_as_defect %}Fixed{% else %}Installed{% endif %}
                        </button>
                        
                        <button type="button"
                            hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                            hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                            hx-target="#area-content"
                            class="px-3 py-2 rounded text-xs font-medium transition-colors
                                   {% if item.status == 'not_installed' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">
                            {% if show_as_defect %}Still Missing{% else %}Not Installed{% endif %}
                        </button>
                    </div>
                    
                    {% if item.status == 'not_installed' %}
                    <div class="mt-2 defect-input-wrapper">
                        <input type="text" 
                               value="{{ item.comment or '' }}"
                               placeholder="Describe issue..."
                               autocomplete="off"
                               class="w-full px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps"
                               hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                               hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                               hx-trigger="blur changed, keydown[key=='Enter']"
                               hx-target="#area-content"
                               name="comment">
                        <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}"
                             hx-trigger="load"
                             hx-swap="innerHTML"></div>
                    </div>
                    {% endif %}
                    
                    {% elif parent_not_installed %}
                    <div class="text-xs text-gray-400 italic">Parent not installed</div>
                    
                    {% else %}
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                            hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                            hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}'
                            hx-target="#area-content"
                            class="px-3 py-2 rounded text-xs font-medium transition-colors
                                   {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">
                            {% if show_as_defect %}Fixed{% else %}OK{% endif %}
                        </button>
                        
                        <button type="button"
                            hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                            hx-vals='{"status": "not_to_standard", "area_id": "{{ area.id }}"}'
                            hx-target="#area-content"
                            class="px-3 py-2 rounded text-xs font-medium transition-colors
                                   {% if item.status == 'not_to_standard' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">
                            {% if show_as_defect %}Not Fixed{% else %}N.T.S.{% endif %}
                        </button>
                        
                        {% if not show_as_defect %}
                        <button type="button"
                            hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                            hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                            hx-target="#area-content"
                            class="px-3 py-2 rounded text-xs font-medium transition-colors
                                   {% if item.status == 'not_installed' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-yellow-100{% endif %}">
                            N/I
                        </button>
                        {% endif %}
                    </div>
                    
                    {% if item.status in ['not_to_standard', 'not_installed'] %}
                    <div class="mt-2 defect-input-wrapper">
                        <input type="text" 
                               value="{{ item.comment or '' }}"
                               placeholder="{% if show_as_defect %}Update comment or leave blank...{% else %}Describe the defect...{% endif %}"
                               autocomplete="off"
                               class="w-full px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500 auto-caps"
                               hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                               hx-vals='{"status": "{{ item.status }}", "area_id": "{{ area.id }}"}'
                               hx-trigger="blur changed, keydown[key=='Enter']"
                               hx-target="#area-content"
                               name="comment">
                        <div hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}"
                             hx-trigger="load"
                             hx-swap="innerHTML"></div>
                    </div>
                    {% else %}
                    <div class="mt-1">
                        <a href="javascript:void(0)"
                           onclick="var d=this.nextElementSibling;d.classList.toggle('hidden');if(!d.dataset.loaded){htmx.trigger(d,'loadPills');d.dataset.loaded='1'}"
                           ontouchend="event.preventDefault();this.click()"
                           class="text-xs text-gray-400 hover:text-blue-500"
                           style="text-decoration:none">
                            &#9432; common defects
                        </a>
                        <div class="hidden guide-pills"
                             data-post-url="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                             data-area-id="{{ area.id }}"
                             hx-get="{{ url_for('inspection.get_defect_suggestions', item_template_id=item.template_id) }}?mode=guide"
                             hx-trigger="loadPills once"
                             hx-swap="innerHTML">
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% endif %}
    {% endfor %}
    
    {% if not categories %}
    <div class="text-center py-8 text-gray-500">
        {% if filter_mode == 'defects' %}
        No defects in this area
        {% else %}
        No items in this area
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    // Auto-capitalize first character
    document.querySelectorAll('.auto-caps').forEach(function(input) {
        input.addEventListener('input', function(e) {
            if (this.value.length === 1) {
                this.value = this.value.charAt(0).toUpperCase();
            }
        });
    });
    
    // Auto-expand categories with active defect inputs
    document.querySelectorAll('.defect-input-wrapper').forEach(function(wrapper) {
        var catContent = wrapper.closest('.cat-content');
        var chevron = catContent ? catContent.previousElementSibling.querySelector('.cat-chevron') : null;
        if (catContent) catContent.classList.remove('hidden');
        if (chevron) chevron.classList.add('rotate-90');
    });
    
    // Auto-focus the last defect input (most recently interacted)
    var defectInputs = document.querySelectorAll('.defect-input-wrapper input[type="text"]');
    if (defectInputs.length > 0) {
        var lastEmpty = null;
        defectInputs.forEach(function(inp) {
            if (!inp.value) lastEmpty = inp;
        });
        if (lastEmpty) lastEmpty.focus();
    }
    
    // Trigger progress bar refresh
    document.body.dispatchEvent(new CustomEvent('areaUpdated'));
</script>
