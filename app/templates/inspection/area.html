<!-- Area inspection partial - loaded via HTMX -->
<div class="space-y-6">
    {% if is_followup %}
    <!-- Filter Toggle (only for Cycle 2+) -->
    <div class="flex gap-2 mb-4">
        <button type="button"
            hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=all"
            hx-target="#area-content"
            hx-swap="innerHTML"
            class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                   {% if filter_mode == 'all' %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
            All Items
        </button>
        <button type="button"
            hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}?filter=defects"
            hx-target="#area-content"
            hx-swap="innerHTML"
            class="px-3 py-1.5 rounded text-sm font-medium transition-colors
                   {% if filter_mode == 'defects' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
            Open Defects Only
        </button>
    </div>
    {% endif %}

    {% if area_note %}
    <!-- Area-specific note from architect -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
        <span class="text-xs font-medium text-yellow-800">Note:</span>
        <span class="text-sm text-yellow-700">{{ area_note.note if area_note.note else area_note }}</span>
    </div>
    {% endif %}
    
    {% for category in categories %}
    {% if category.checklist or category.all_skipped %}
    <div class="border rounded-lg overflow-hidden {% if category.all_skipped %}opacity-60{% endif %}">
        <!-- Category Header -->
        <div class="bg-gray-100 px-4 py-3 border-b">
            <h3 class="font-semibold text-gray-800">{{ category.name }}</h3>
        </div>
        
        {% if category.all_skipped %}
        <!-- All items excluded - show message -->
        <div class="bg-orange-50 px-4 py-3 border-b">
            <span class="text-xs text-orange-600 font-medium">Excluded this cycle</span>
        </div>
        {% else %}
        <!-- Category Comment (general comment for this category) -->
        <div class="bg-gray-50 px-4 py-2 border-b">
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 font-medium">General:</span>
                <input type="text" 
                       placeholder="Add category-level comment..."
                       value="{{ category.comment.latest_comment if category.comment else '' }}"
                       class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                       hx-post="{{ url_for('inspection.update_category_comment', inspection_id=inspection.id, category_id=category.id) }}"
                       hx-vals='{"area_id": "{{ area.id }}"}'
                       hx-trigger="blur changed, keydown[key=='Enter']"
                       hx-target="#area-content"
                       name="comment">
                {% if category.comment %}
                <span class="text-xs text-green-600">Saved</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Items -->
        <div class="divide-y">
            {% for item in category.checklist %}
            {% set is_parent = item.parent_item_id is none and item.depth == 0 %}
            {% set has_children = item.child_count > 0 %}
            {% set is_child = item.parent_item_id is not none %}
            {% set parent_not_installed = item.parent_status == 'not_installed' %}
            {% set is_skipped = item.status == 'skipped' %}
            {% set has_defect = item.has_open_defect %}
            {% set is_defective = item.status in ['not_to_standard', 'not_installed'] %}
            {% set show_as_defect = is_followup and has_defect %}
            
            <div class="p-3 {% if is_child %}pl-8 bg-gray-50{% endif %} {% if parent_not_installed or is_skipped %}opacity-40{% endif %} {% if show_as_defect %}bg-red-50 border-l-4 border-red-400{% endif %}">
                <!-- Item Description -->
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        {% if is_child %}
                        <span class="text-gray-400 mr-1">-</span>
                        {% endif %}
                        <span class="text-sm {% if is_parent %}font-semibold{% else %}font-medium{% endif %} text-gray-800">
                            {{ item.item_description }}
                        </span>
                        {% if is_skipped %}
                        <span class="text-xs text-orange-500 ml-2">(Excluded this cycle)</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if show_as_defect %}
                <!-- Previous defect info -->
                <div class="mb-3 p-2 bg-red-100 rounded border border-red-200">
                    <div class="text-xs font-medium text-red-800 mb-1">
                        Previous defect (Cycle {{ item.defect_cycle }}):
                    </div>
                    <div class="text-sm text-red-700">
                        {{ item.defect_comment or 'No comment' }}
                    </div>
                </div>
                {% endif %}
                
                {% if is_skipped %}
                <!-- Skipped item - no controls -->
                
                {% elif is_parent and has_children %}
                <!-- Parent item WITH children: Installed / Not Installed -->
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">
                        {% if show_as_defect %}Fixed{% else %}Installed{% endif %}
                    </button>
                    
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'not_installed' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">
                        {% if show_as_defect %}Still Missing{% else %}Not Installed{% endif %}
                    </button>
                </div>
                
                <!-- Comment for not installed parent -->
                {% if item.status == 'not_installed' %}
                <div class="mt-2">
                    <input type="text" 
                           value="{{ item.comment or '' }}"
                           placeholder="Describe issue..."
                           class="w-full px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500"
                           hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                           hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                           hx-trigger="blur changed, keydown[key=='Enter']"
                           hx-target="#area-content"
                           name="comment">
                </div>
                {% endif %}
                
                {% elif parent_not_installed %}
                <!-- Child item greyed out -->
                <div class="text-xs text-gray-400 italic">Parent not installed</div>
                
                {% else %}
                <!-- Child or standalone item: full status buttons -->
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "ok", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'ok' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-green-100{% endif %}">
                        {% if show_as_defect %}Fixed{% else %}OK{% endif %}
                    </button>
                    
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "not_to_standard", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'not_to_standard' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-red-100{% endif %}">
                        {% if show_as_defect %}Not Fixed{% else %}N.T.S.{% endif %}
                    </button>
                    
                    {% if not show_as_defect %}
                    <button type="button"
                        hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                        hx-vals='{"status": "not_installed", "area_id": "{{ area.id }}"}'
                        hx-target="#area-content"
                        class="px-3 py-2 rounded text-xs font-medium transition-colors
                               {% if item.status == 'not_installed' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-yellow-100{% endif %}">
                        N/I
                    </button>
                    {% endif %}
                </div>
                
                <!-- Comment for defective items -->
                {% if item.status in ['not_to_standard', 'not_installed'] %}
                <div class="mt-2">
                    <input type="text" 
                           value="{{ item.comment or '' }}"
                           placeholder="{% if show_as_defect %}Update comment or leave blank...{% else %}Describe the defect... (Enter to save){% endif %}"
                           class="w-full px-3 py-2 border-2 border-red-300 rounded text-sm focus:ring-2 focus:ring-red-500"
                           hx-post="{{ url_for('inspection.update_item', inspection_id=inspection.id, item_id=item.id) }}"
                           hx-vals='{"status": "{{ item.status }}", "area_id": "{{ area.id }}"}'
                           hx-trigger="blur changed, keydown[key=='Enter']"
                           hx-target="#area-content"
                           name="comment">
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<script>
    // Trigger progress bar refresh
    document.body.dispatchEvent(new CustomEvent('areaUpdated'));
</script>
