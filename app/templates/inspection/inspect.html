{% extends "base.html" %}

{% block title %}Unit {{ inspection.unit_number }} - Cycle {{ inspection.cycle_number }}


<script>
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'area-content') {
            window._scrollY = window.scrollY;
            var expanded = [];
            document.querySelectorAll('.cat-content').forEach(function(c, i) {
                if (!c.classList.contains('hidden')) expanded.push(i);
            });
            window._expandedCats = expanded;
        }
    });
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'area-content') {
            if (window._scrollY !== undefined) {
                requestAnimationFrame(function() {
                    window.scrollTo(0, window._scrollY);
                });
            }
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Sticky Header -->
    <div class="bg-white rounded-lg shadow p-4 mb-4 sticky top-0 z-10">
        <div class="flex justify-between items-start">
            <div>
                <div class="text-sm text-gray-500">
                    {{ inspection.project_name }} / {{ inspection.phase_name }}
                </div>
                <h1 class="text-xl font-bold text-gray-900">
                    Unit {{ inspection.unit_number }}
                </h1>
                <div class="text-sm text-gray-600">
                    Cycle {{ inspection.cycle_number }} - {{ inspection.inspection_date }}
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Inspector</div>
                <div class="font-medium">{{ inspection.inspector_name }}</div>
            </div>
        </div>
        
        <!-- Progress (includes submit banner at 100%) -->
        <div id="progress-bar" class="mt-4"
             hx-get="{{ url_for('inspection.get_progress', inspection_id=inspection.id) }}"
             hx-trigger="areaUpdated from:body">
            {% include 'inspection/_progress.html' %}
        </div>
    </div>

    <!-- Open Defects from Previous Cycles (Cycle 1 only) -->
    {% if is_initial %}
    {% include 'inspection/_open_defects.html' %}
    {% endif %}

    <!-- Area Tabs -->
    <div class="bg-white rounded-lg shadow mb-4">
        <div class="border-b overflow-x-auto">
            <div class="flex flex-wrap">
                {% for area in template %}
                <button class="area-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 flex items-center gap-2
                       {% if loop.first %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700{% endif %}"
                        hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=area.id) }}"
                        hx-target="#area-content"
                        hx-swap="innerHTML"
                        onclick="document.querySelectorAll('.area-tab').forEach(t => {t.classList.remove('border-blue-500', 'text-blue-600'); t.classList.add('border-transparent', 'text-gray-500')}); this.classList.add('border-blue-500', 'text-blue-600'); this.classList.remove('border-transparent', 'text-gray-500')">
                    {{ area.name }}
                    <span id="area-badge-{{ area.id }}" {% if area_defect_map.get(area.id) %}class="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full"{% endif %}>{{ area_defect_map[area.id] if area_defect_map.get(area.id) else '' }}</span>
                    {% if area_notes_map.get(area.id) %}
                    <span class="text-orange-500 text-xs">*</span>
                    {% endif %}
                </button>
                {% endfor %}
            </div>
        </div>
        
        <div id="area-badges-refresh" style="display:none"
             hx-get="{{ url_for('inspection.get_area_badges', inspection_id=inspection.id) }}"
             hx-trigger="areaUpdated from:body"
             hx-swap="none"></div>
        <div id="area-content" class="p-4"
             hx-get="{{ url_for('inspection.inspect_area', inspection_id=inspection.id, area_id=template[0].id) }}{% if is_followup %}?filter=to_inspect{% endif %}"
             hx-trigger="load">
            <div class="text-center py-8 text-gray-500">Loading...</div>
        </div>
    </div>

    <!-- Submitted status -->
    {% if inspection.status != 'in_progress' %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 text-center">
        <span class="text-green-700 font-medium">Inspection Submitted</span>
        <span class="text-green-600 text-sm ml-2">{{ inspection.submitted_at }}</span>
    </div>
    {% endif %}

    {% if current_user and current_user.role in ['manager', 'admin'] and inspection.status != 'in_progress' %}
    <div class="bg-white rounded-lg shadow p-4">
        <form method="POST" action="{{ url_for('inspection.submit_inspection', inspection_id=inspection.id) }}">
            <button type="submit" id="save-changes-btn" disabled
                    class="w-full py-3 rounded-lg font-medium bg-gray-300 text-gray-500 cursor-not-allowed">
                Save Changes
            </button>
        </form>
        <p class="text-xs text-gray-500 text-center mt-2">Make changes above to enable</p>
    </div>
    
    <script>
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.requestConfig.verb === 'post') {
                var btn = document.getElementById('save-changes-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.className = 'w-full py-3 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700';
                    btn.nextElementSibling.textContent = 'Updates defects based on current item statuses';
                }
            }
        });
    </script>
    {% endif %}
</div>

<!-- Submit Confirmation Modal -->
{% if inspection.status == 'in_progress' %}
<div id="submit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
         onclick="document.getElementById('submit-modal').classList.add('hidden')"></div>
    
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 mb-4">
                <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            
            <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Submit Inspection?</h3>
            <p class="text-sm text-gray-500 text-center mb-2">
                This will lock the inspection for review. Please confirm all items have been checked.
            </p>
            <p id="submit-defect-count" class="text-sm text-center mb-6"
               hx-get="{{ url_for('inspection.get_defect_count', inspection_id=inspection.id) }}"
               hx-trigger="areaUpdated from:body"
               hx-swap="innerHTML">
                {% if progress.defects > 0 %}
                <span class="text-red-600 font-medium">{{ progress.defects }} defect{{ 's' if progress.defects != 1 else '' }} will be raised.</span>
                {% endif %}
            </p>
            
            <div class="flex gap-3">
                <button type="button"
                        onclick="document.getElementById('submit-modal').classList.add('hidden')"
                        class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <form id="submit-form" method="POST" action="{{ url_for('inspection.submit_inspection', inspection_id=inspection.id) }}" class="flex-1">
                    <button type="submit"
                            class="w-full px-4 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
                        Confirm
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}



<script>
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'area-content') {
            window._scrollY = window.scrollY;
            var expanded = [];
            document.querySelectorAll('.cat-content').forEach(function(c, i) {
                if (!c.classList.contains('hidden')) expanded.push(i);
            });
            window._expandedCats = expanded;
        }
    });
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'area-content') {
            if (window._scrollY !== undefined) {
                requestAnimationFrame(function() {
                    window.scrollTo(0, window._scrollY);
                });
            }
        }
    });
</script>
{% endblock %}
