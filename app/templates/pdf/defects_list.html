<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ unit.unit_number }}_UNIT_INSPECTION {% if cycle %}{{ "%02d"|format(cycle.cycle_number) }}{% else %}01{% endif %}_{{ inspection_date[-4:] }}{{ inspection_date[3:5] }}{{ inspection_date[:2] }}</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm 2cm 3cm 2cm;
            
            @bottom-center {
                content: "Kevin Coetzee | Managing Director | PrArch | SACAP 24750975 , Ruan Marsh | Managing Director | PrArch | SACAP 26658940,\A Louis Barnard | Shareholder | Director\A\A " counter(page);
                font-family: Helvetica, Arial, sans-serif;
                font-size: 7pt;
                color: #888;
                white-space: pre-wrap;
                text-align: center;
                line-height: 1.8;
            }
        }
        
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            color: #000;
            font-weight: 300;
        }
        
        .letterhead {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .letterhead-table {
            width: 100%;
            border: none;
            border-collapse: collapse;
        }
        
        .letterhead-table td {
            vertical-align: top;
            border: none;
            padding: 0;
        }
        
        .logo-cell {
            width: 50%;
        }
        
        .logo-cell img {
            width: 260px;
            height: auto;
        }
        
        .tagline {
            font-size: 7pt;
            margin-top: 8px;
            color: #000;
            font-weight: bold;
            width: 260px;
            text-align: center;
        }
        
        .company-cell {
            width: 50%;
            text-align: right;
            font-size: 8pt;
            line-height: 1.5;
            font-weight: 300;
            padding-top: 15px;
        }
        
        .metadata-row {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .metadata-label {
            font-weight: 400;
            font-size: 9pt;
        }
        
        .metadata-value {
            text-align: right;
            font-weight: bold;
            font-size: 9pt;
        }
        
        .red-text {
            color: #cc0000;
        }
        
        .green-text {
            color: #228B22;
        }
        
        .blue-text {
            color: #000;
        }
        
        .summary-box {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px 15px;
            margin: 12px 0;
            font-size: 9pt;
        }
        
        .summary-box.certified {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
        }
        
        .summary-title {
            font-weight: bold;
            margin-bottom: 6px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .summary-label {
            font-weight: 300;
        }
        
        .summary-value {
            font-weight: bold;
        }
        
        .summary-value.rectified {
            color: #000;
        }
        
        .summary-value.not-rectified {
            color: #cc0000;
        }
        
        .summary-value.new-defects {
            color: #cc0000;
        }
        
        .summary-divider {
            border-top: 1px solid #ccc;
            margin: 8px 0;
        }
        
        .summary-status {
            font-weight: bold;
            font-size: 10pt;
            color: #228B22;
            margin-top: 4px;
        }
        
        .standards {
            margin: 16px 0 12px 0;
            font-size: 9pt;
        }
        
        .standards-title {
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6px;
        }
        
        .standards-title span {
            display: inline-block;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
        }
        
        .standards p {
            margin: 0 0 2px 0;
            font-weight: 300;
        }
        
        .rich-text {
            font-size: 9pt;
            font-weight: 300;
        }
        
        .rich-text p {
            margin: 0 0 2px 0;
            font-weight: 300;
        }
        
        .rich-text strong, .rich-text b {
            font-weight: 600;
        }
        
        .rich-text u {
            text-decoration: underline;
        }
        
        .rich-text ul {
            margin: 0 0 4px 20px;
            padding: 0;
            list-style-type: disc;
        }
        
        .rich-text ol {
            margin: 0 0 4px 20px;
            padding: 0;
            list-style-type: decimal;
        }
        
        .rich-text li {
            margin: 0 0 1px 0;
            font-weight: 300;
        }
        
        .defects-header {
            margin: 20px 0 12px 0;
            font-size: 9pt;
        }
        
        .defects-header-title {
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6px;
        }
        
        .defects-header-title span {
            display: inline-block;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
        }
        
        .area-section {
            margin: 15px 0;
        }
        
        .area-title {
            font-size: 9pt;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .area-title span {
            display: inline-block;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
        }
        
        .area-note {
            font-style: italic;
            color: #666;
            margin-bottom: 6px;
            font-size: 8pt;
            margin-left: 10px;
        }
        
        .category-row {
            margin-left: 12px;
            margin-bottom: 3px;
            font-weight: 400;
            font-size: 9pt;
        }
        
        .category-note {
            margin-left: 28px;
            margin-bottom: 3px;
            font-style: italic;
            color: #666;
            font-size: 8pt;
        }
        
        .defect-item {
            margin-left: 28px;
            margin-bottom: 3px;
            padding-left: 12px;
            text-indent: -12px;
            font-weight: 300;
            font-size: 9pt;
        }
        
        .defect-item.rectified {
            text-decoration: line-through;
            color: #000;
        }
        
        .defect-item .not-rectified-marker {
            color: #cc0000;
            font-weight: 400;
        }
        
        .defect-item .new-marker {
            color: #cc0000;
            font-weight: 400;
        }
        
        .defect-item .rectified-marker {
            color: #000;
            font-weight: 400;
            text-decoration: none;
        }
        
        .inspection-timeline {
            margin: 20px 0;
            font-size: 9pt;
        }
        
        .timeline-title {
            font-weight: bold;
            margin-bottom: 6px;
        }
        
        .timeline-entry {
            margin-bottom: 2px;
            font-weight: 300;
        }
        
        .timeline-entry .certified-marker {
            color: #228B22;
            font-weight: bold;
        }
        
        .inspection-details {
            margin: 20px 0;
        }
        
        .inspection-details p {
            margin: 0 0 4px 0;
            font-weight: 300;
            font-size: 9pt;
        }
        
        .detail-label {
            font-weight: bold;
        }
        
        .closing-section {
            margin-top: 25px;
            page-break-inside: avoid;
        }
        
        .closing-text {
            margin-bottom: 20px;
            line-height: 1.5;
            font-weight: 300;
            font-size: 9pt;
        }
        
        .closing-text p {
            margin: 0 0 4px 0;
        }
        
        .signature-block {
            margin-top: 12px;
        }
        
        .regards {
            margin: 0 0 8px 0;
            font-weight: 300;
            font-size: 9pt;
        }
        
        .signature-img {
            width: 140px;
            height: auto;
            display: block;
            margin-left: -5px;
        }
        
        .signatory-name {
            font-weight: 400;
            margin: 0;
            font-size: 9pt;
        }
        
        .signatory-title {
            font-size: 8pt;
            font-weight: 300;
            margin: 0;
        }

        .no-break {
            page-break-inside: avoid;
        }
    </style>
</head>
<body>
    <div class="letterhead">
        <table class="letterhead-table">
            <tr>
                <td class="logo-cell">
                    {% if logo_path %}
                    <img src="{{ logo_path }}" alt="Monograph Architects">
                    {% endif %}
                    <div class="tagline">Professional Architects | PrArch</div>
                </td>
                <td class="company-cell">
                    Physical Address | 8 Ridge Road<br/>
                    Mountain View Johannesburg<br/>
                    2192<br/>
                    <br/>
                    Postal Address | Po Box 411916,<br/>
                    Craighall, 2024<br/>
                    Tel | +27 72 597 7113<br/>
                    Email | info@monograph-architects.com<br/>
                    Website | www.monograph-architects.com<br/>
                    CIPRO | 2016/465468/07<br/>
                    VAT | 4240275745
                </td>
            </tr>
        </table>
    </div>
    
    <div class="metadata-row">
        <span class="metadata-label">ATTENTION</span>
        <span class="metadata-value">MAIN CONTRACTOR | RAUBEX</span>
    </div>
    <div class="metadata-row">
        <span class="metadata-label">RE:</span>
        <span class="metadata-value">DEFECTIVE WORKS LIST</span>
    </div>
    <div class="metadata-row">
        <span class="metadata-label">PROJECT</span>
        <span class="metadata-value">{{ project.project_name | upper }} | <span class="red-text">{{ phase.phase_name | upper }}</span></span>
    </div>
    <div class="metadata-row">
        <span class="metadata-label">DATE</span>
        <span class="metadata-value red-text">{{ inspection_date }}</span>
    </div>
    <div class="metadata-row">
        <span class="metadata-label">UNIT NO / AREA OF INSPECTION</span>
        <span class="metadata-value red-text">{{ unit.unit_number }}</span>
    </div>
    <div class="metadata-row">
        <span class="metadata-label">INSPECTION CYCLE</span>
        <span class="metadata-value red-text">{{ cycle.cycle_number if cycle else '1' }}</span>
    </div>
    
    {% if cycle_number == 1 %}
    <!-- Cycle 1 Inspection Summary Box -->
    <div class="summary-box">
        <div class="summary-title">Inspection Summary</div>
        <div class="summary-row">
            <span class="summary-label">Total items:</span>
            <span class="summary-value">{{ inspection_summary.total }}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Excluded:</span>
            <span class="summary-value">{{ inspection_summary.excluded }}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Inspected:</span>
            <span class="summary-value">{{ inspection_summary.inspected }}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Defects raised:</span>
            <span class="summary-value not-rectified">{{ inspection_summary.defects }}</span>
        </div>
    </div>
    {% elif cycle_number > 1 %}
        {% if is_certified %}
        <!-- Certification Summary Box (unit cleared) -->
        <div class="summary-box certified">
            <div class="summary-title">Certification Summary</div>
            <div class="summary-row">
                <span class="summary-label">Total defects raised:</span>
                <span class="summary-value">{{ grand_totals.raised }}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Total defects rectified:</span>
                <span class="summary-value">{{ grand_totals.rectified }}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Outstanding:</span>
                <span class="summary-value green-text">0</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-status">UNIT CLEARED &amp; CERTIFIED</div>
        </div>
        {% else %}
        <!-- Defect Summary Box (defects still open) -->
        <div class="summary-box">
            <div class="summary-title">Defect Summary</div>
            <div class="summary-row">
                <span class="summary-label">Rectified this cycle:</span>
                <span class="summary-value rectified">{{ summary.rectified }}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Not rectified:</span>
                <span class="summary-value not-rectified">{{ summary.not_rectified }}</span>
            </div>
            {% if summary.new > 0 %}
            <div class="summary-row">
                <span class="summary-label">New defects this cycle:</span>
                <span class="summary-value new-defects">{{ summary.new }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}
    {% endif %}
    
    <div class="standards">
        <div class="standards-title"><span>Standard of measurement for items on defective works list:</span></div>
        <p>Visual defects on all items shall be inspected from 1m distance and deemed defective if prominent.</p>
        <p>All items not operating as intended shall be deemed defective</p>
        <p>All items not installed or missing shall be deemed incomplete.</p>
        <p>Any critical damage to items that can affect the longevity of the item or void its warranty shall be deemed defective.</p>
        <p>Any item that does not comply to the South African National Standards and accompanying codes shall be deemed defective.</p>
    </div>
    
    {% if general_notes_html %}
    <div class="standards">
        <div class="standards-title"><span>General Notes:</span></div>
        <div class="rich-text">{{ general_notes_html | safe }}</div>
    </div>
    {% endif %}
    
    {% if exclusion_notes_html %}
    <div class="standards">
        <div class="standards-title"><span>Exclusion Notes:</span></div>
        <div class="rich-text">{{ exclusion_notes_html | safe }}</div>
    </div>
    {% endif %}
    
    {% if defects_by_area %}
    <div class="defects-header">
        <div class="defects-header-title"><span>Defective Works:</span></div>
    </div>
    {% endif %}
    
    {% for area in defects_by_area %}
    <div class="area-section">
        <div class="area-title"><span>{{ area.name }}</span></div>
        
        {% if area.note %}
        <div class="area-note">Note: {{ area.note }}</div>
        {% endif %}
        
        {% for category in area.categories %}
        {% if category.defects %}
        <div class="no-break">
            <div class="category-row">- {{ category.name }}</div>
            {% if category.note %}
            <div class="category-note">{{ category.note }}</div>
            {% endif %}
            {% for defect in category.defects %}
            <div class="defect-item {% if defect.display_status == 'rectified' %}rectified{% endif %}">
                &#8226; {% if defect.description %}{{ defect.description }}{% endif %}{% if defect.comment %} - {{ defect.comment }}{% endif %}{% if defect.display_status == 'rectified' %} <span class="rectified-marker">(Rectified)</span>{% elif defect.display_status == 'not_rectified' %} <span class="not-rectified-marker">(Not rectified)</span>{% elif defect.display_status == 'new' and cycle_number > 1 %} <span class="new-marker">(New)</span>{% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
    
    {% if inspection_timeline %}
    <div class="inspection-timeline">
        <div class="timeline-title">Inspection History</div>
        {% for entry in inspection_timeline %}
        <div class="timeline-entry">
            {% if entry.cycle_number == 1 %}
            Cycle {{ entry.cycle_number }}: {{ entry.date }} - {{ entry.inspector }} ({{ entry.raised }} defects raised)
            {% elif loop.last and is_certified %}
            Cycle {{ entry.cycle_number }}: {{ entry.date }} - {{ entry.inspector }} ({{ entry.rectified }} rectified, {{ entry.outstanding }} outstanding) - <span class="certified-marker">Certified &#10003;</span>
            {% else %}
            Cycle {{ entry.cycle_number }}: {{ entry.date }} - {{ entry.inspector }} ({{ entry.rectified }} rectified, {{ entry.outstanding }} outstanding{% if entry.raised > 0 %}, {{ entry.raised }} new{% endif %})
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="inspection-details">
        <p><span class="detail-label">Inspection Date:</span> {{ inspection_date }}</p>
        <p><span class="detail-label">Inspected By:</span> {{ inspector_name }}</p>
        <p><span class="detail-label">Certification date:</span> {% if certification_date %}{{ certification_date }}{% else %}Not Certified{% endif %}</p>
    </div>
    
    <div class="closing-section">
        <div class="closing-text">
            {% if is_certified %}
            <p>All defects have been rectified and this unit is hereby certified as complete.</p>
            {% else %}
            <p>We trust you find the above in order and will rectify any defect within the afforded contract period.</p>
            <p>We await an invitation for a follow up inspection if required.</p>
            {% endif %}
        </div>
        
        <div class="signature-block">
            <p class="regards">Kind regards,</p>
            {% if signature_path %}
            <img class="signature-img" src="{{ signature_path }}" alt="Signature">
            {% endif %}
            <p class="signatory-name">Kevin Coetzee</p>
            <p class="signatory-title">PrArch; MD</p>
        </div>
    </div>
</body>
</html>
