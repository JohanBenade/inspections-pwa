{% extends "base.html" %}
{% block title %}{{ label }}{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');
    .font-display { font-family: 'Cormorant Garamond', Georgia, serif; }
    .font-body { font-family: 'DM Sans', system-ui, sans-serif; }
    .gold-accent { color: #C8963E; }
    .bg-gold { background-color: #C8963E; }
    .section-num { font-family: 'Cormorant Garamond', serif; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.15em; color: #C8963E; text-transform: uppercase; }
    .verdict-bar { background: linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 100%); }
    .verdict-bar-warn { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #7f1d1d 100%); }
    .verdict-bar-good { background: linear-gradient(135deg, #14532d 0%, #166534 50%, #14532d 100%); }
    .verdict-bar-wait { background: linear-gradient(135deg, #78350f 0%, #92400e 50%, #78350f 100%); }
    .data-table th { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: #6B6B6B; padding: 0.6rem 0.75rem; border-bottom: 2px solid #0A0A0A; }
    .data-table td { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.85rem; padding: 0.6rem 0.75rem; border-bottom: 1px solid #e5e5e5; }
    .data-table tr:last-child td { border-bottom: none; }
    .callout { padding: 1rem 1.25rem; border-radius: 4px; font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.85rem; line-height: 1.5; }
    .callout-red { background: rgba(196,77,63,0.08); border-left: 4px solid #C44D3F; color: #1A1A1A; }
    .callout-amber { background: rgba(200,150,62,0.1); border-left: 4px solid #C8963E; color: #1A1A1A; }
    .callout-green { background: rgba(74,124,89,0.08); border-left: 4px solid #4A7C59; color: #1A1A1A; }
    .callout-blue { background: rgba(61,107,142,0.08); border-left: 4px solid #3D6B8E; color: #1A1A1A; }
    .trajectory-worse { color: #C44D3F; }
    .trajectory-same { color: #6B6B6B; }
    .trajectory-better { color: #4A7C59; }
    .section-card { background: #FAFAF8; border: 1px solid #e5e5e5; border-radius: 8px; padding: 1.5rem; }
    .section-subtitle { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.8rem; color: #9A9A9A; margin-bottom: 1.25rem; }
    .divider { height: 1px; background: #0A0A0A; margin: 0.5rem 0 1.5rem 0; }
    .group-header { font-family: 'DM Sans', sans-serif; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 0.5rem 0.75rem; }
    .group-header-blue { background: rgba(61,107,142,0.08); color: #3D6B8E; }
    .group-header-gray { background: rgba(107,107,107,0.08); color: #6B6B6B; }
</style>

<div class="font-body" style="max-width: 1280px; margin: 0 auto;">

    <!-- BREADCRUMB + TITLE -->
    <div class="mb-6">
        <a href="{{ url_for('analytics.dashboard') }}" class="text-sm gold-accent hover:underline">&larr; Dashboard</a>
        <h1 class="font-display text-3xl lg:text-4xl font-bold text-gray-900 mt-2" style="letter-spacing: -0.01em;">{{ label }}</h1>
        <div class="text-sm text-gray-400 mt-1">Inspection Analytics &middot; PPSH Phase 3 &middot; {{ summary.total_units }} units &middot; {{ summary.total_defects }} open defects &middot; {{ summary.avg_defects }} avg per unit &middot; {{ summary.defect_rate }}% defect rate</div>
    </div>

    {% if not has_data %}
    <div class="section-card text-center py-12"><p class="text-gray-400 font-display text-xl">No inspection data yet.</p></div>
    {% else %}

    <!-- ==================== VERDICT BAR ==================== -->
    {% if rectification %}
    {% set pct = rect_totals.clearance_pct if rect_totals else 0 %}
    <div class="{% if pct >= 75 %}verdict-bar-good{% elif pct >= 25 %}verdict-bar-wait{% elif pct == 0 and rect_totals.new_defects > 0 %}verdict-bar-warn{% else %}verdict-bar-wait{% endif %} rounded-lg px-6 py-5 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
                <div class="text-white text-xs font-semibold tracking-widest uppercase mb-1" style="opacity: 0.7;">Rectification Status</div>
                <div class="font-display text-white text-2xl lg:text-3xl font-bold">
                    {% if pct == 0 and rect_totals.new_defects > 0 %}Rectification Stalled
                    {% elif pct == 0 %}Awaiting Rectification
                    {% elif pct < 50 %}Rectification In Progress
                    {% elif pct < 100 %}Rectification On Track
                    {% else %}Fully Rectified{% endif %}
                </div>
            </div>
            <div class="flex flex-wrap gap-6 text-white">
                <div class="text-center"><div class="text-2xl font-bold">{{ rect_totals.prev_cleared }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">of {{ rect_totals.prev_raised }} resolved</div></div>
                <div class="text-center"><div class="text-2xl font-bold" style="{% if rect_totals.new_defects > 0 %}color: #fbbf24;{% endif %}">{{ rect_totals.new_defects }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">new defects</div></div>
                <div class="text-center"><div class="text-2xl font-bold">{{ rectification|length }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">of {{ summary.total_units }} re-inspected</div></div>
            </div>
        </div>
    </div>
    {% elif summary.max_round == 1 %}
    <div class="verdict-bar rounded-lg px-6 py-5 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
                <div class="text-white text-xs font-semibold tracking-widest uppercase mb-1" style="opacity: 0.7;">Inspection Status</div>
                <div class="font-display text-white text-2xl lg:text-3xl font-bold">Awaiting Contractor Rectification</div>
            </div>
            <div class="flex flex-wrap gap-6 text-white">
                <div class="text-center"><div class="text-2xl font-bold">{{ summary.total_defects }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">defects raised</div></div>
                <div class="text-center"><div class="text-2xl font-bold">{{ summary.total_units }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">units inspected</div></div>
                <div class="text-center"><div class="text-2xl font-bold">0</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">certified</div></div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ==================== 01 BLOCK STATUS (single grouped table) ==================== -->
    {% if units %}
    <div class="section-card mb-6">
        <div class="section-num">01 &mdash; Block Status</div>
        <div class="divider"></div>
        <div class="section-subtitle">All {{ summary.total_units }} units &middot; Median: {{ summary.median_defects }} defects</div>

        <div class="overflow-x-auto">
            <table class="w-full data-table">
                <thead>
                    <tr>
                        <th class="text-left">Unit</th>
                        <th class="text-center">Round</th>
                        <th class="text-center">Status</th>
                        {% if rectification %}
                        <th class="text-center">R1 Flagged</th>
                        <th class="text-center">Rectified</th>
                        <th class="text-center">New</th>
                        {% endif %}
                        <th class="text-center">Open Now</th>
                        <th class="text-center">Rate</th>
                        {% if rectification %}
                        <th class="text-center">Trajectory</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% if rectification %}
                    <!-- GROUP: Re-inspected units -->
                    <tr><td colspan="{% if rectification %}9{% else %}5{% endif %}" class="group-header group-header-blue">Re-inspected ({{ rectification|length }} units)</td></tr>
                    {% set rect_lookup = {} %}
                    {% for r in rectification %}
                    {% if rect_lookup.update({r.unit_number: r}) %}{% endif %}
                    {% endfor %}
                    {% for u in units if u.round_number > 1 %}
                    {% set r = rect_lookup.get(u.unit_number, {}) %}
                    <tr>
                        <td class="font-semibold">{{ u.unit_number }}</td>
                        <td class="text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-700">R{{ u.round_number }}</span></td>
                        <td class="text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold {{ u.status_colour }}">{{ u.status_label }}</span></td>
                        <td class="text-center">{{ r.get('prev_raised', '-') }}</td>
                        <td class="text-center font-semibold {% if r.get('prev_cleared', 0) > 0 %}text-emerald-600{% else %}text-red-600{% endif %}">{{ r.get('prev_cleared', '-') }}</td>
                        <td class="text-center {% if r.get('new_defects', 0) > 0 %}text-amber-600 font-semibold{% else %}text-gray-400{% endif %}">{% if r.get('new_defects', 0) > 0 %}+{{ r.new_defects }}{% else %}&mdash;{% endif %}</td>
                        <td class="text-center font-bold {% if u.defect_count > summary.median_defects %}text-red-600{% elif u.defect_count == summary.median_defects %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ u.defect_count }}</td>
                        <td class="text-center text-sm tabular-nums text-gray-500">{{ u.defect_rate }}%</td>
                        <td class="text-center font-semibold text-sm">
                            {% if r.get('total_open', 0) > r.get('prev_raised', 0) %}<span class="trajectory-worse">&#9650; Worse</span>
                            {% elif r.get('total_open', 0) == r.get('prev_raised', 0) %}<span class="trajectory-same">&#9644; Same</span>
                            {% elif r.get('total_open', 0) > 0 %}<span class="trajectory-better">&#9660; Improving</span>
                            {% else %}<span class="trajectory-better">&#10003; Clear</span>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- GROUP: Awaiting re-inspection -->
                    <tr><td colspan="9" class="group-header group-header-gray" style="border-top: 2px solid #d4d4d4;">Awaiting Re-inspection ({{ units|selectattr('round_number', 'equalto', 1)|list|length }} units)</td></tr>
                    {% endif %}

                    {% set max_defects = units[0].defect_count if units else 1 %}
                    {% for u in units if (not rectification or u.round_number == 1) %}
                    <tr>
                        <td class="font-semibold">{{ u.unit_number }}</td>
                        <td class="text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-600">R{{ u.round_number }}</span></td>
                        <td class="text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold {{ u.status_colour }}">{{ u.status_label }}</span></td>
                        {% if rectification %}
                        <td class="text-center text-gray-300">&mdash;</td>
                        <td class="text-center text-gray-300">&mdash;</td>
                        <td class="text-center text-gray-300">&mdash;</td>
                        {% endif %}
                        <td class="text-center font-bold {% if u.defect_count > summary.median_defects %}text-red-600{% elif u.defect_count == summary.median_defects %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ u.defect_count }}</td>
                        <td class="text-center text-sm tabular-nums text-gray-500">{{ u.defect_rate }}%</td>
                        {% if rectification %}
                        <td class="text-center text-gray-300">&mdash;</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if rectification and rect_callout %}
        <div class="callout {% if rect_totals.clearance_pct == 0 %}callout-red{% elif rect_totals.clearance_pct < 50 %}callout-amber{% else %}callout-green{% endif %} mt-5">
            <strong>Finding:</strong> {{ rect_callout }}
        </div>
        {% endif %}

        <div class="flex flex-wrap gap-4 text-xs text-gray-400 mt-3">
            <span>Defect colour relative to median ({{ summary.median_defects }})</span>
            <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Below</span>
            <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-amber-500"></span> At</span>
            <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-red-500"></span> Above</span>
        </div>
    </div>
    {% endif %}

    <!-- ==================== 02 WHERE TO FOCUS ==================== -->
    {% if area_data %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="section-card">
            <div class="section-num">02 &mdash; Defect Hotspots</div>
            <div class="divider"></div>
            <div class="section-subtitle">Defects by area &middot; Prioritise top areas for rectification</div>

            <div class="space-y-3">
                {% for a in area_data %}
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-800">{{ a.area }}</span>
                        <span class="text-sm font-bold tabular-nums" style="color: {{ a.colour }};">{{ a.defect_count }} <span class="font-normal text-gray-400 text-xs">({{ a.pct }}%)</span></span>
                    </div>
                    <div class="w-full rounded-full h-3" style="background: #e5e5e5;">
                        <div class="h-3 rounded-full" style="width: {{ a.bar_pct }}%; background: {{ a.colour }};"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if area_data|length >= 2 %}
            <div class="callout callout-amber mt-5">
                <strong>Focus:</strong> {{ area_data[0].area }} and {{ area_data[1].area }} account for {{ area_data[0].pct + area_data[1].pct }}% of all defects.
            </div>
            {% endif %}
        </div>

        <!-- AREA DEEP DIVE -->
        {% if area_deep_dive %}
        <div class="section-card">
            <div class="section-num">03 &mdash; Deep Dive</div>
            <div class="divider"></div>
            <div class="section-subtitle">Most common defects in highest-impact areas</div>

            {% for area in area_deep_dive %}
            <div class="{% if not loop.first %}mt-5 pt-5{% endif %}" style="{% if not loop.first %}border-top: 1px solid #e5e5e5;{% endif %}">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-1 h-6 rounded-full" style="background: {{ area.colour }};"></div>
                    <span class="font-semibold text-gray-900">{{ area.area }}</span>
                    <span class="text-xs text-gray-400">{{ area.total }} defects ({{ area.pct_of_total }}%)</span>
                </div>
                <div class="space-y-2">
                    {% for d in area.defects %}
                    <div class="flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold text-white flex-shrink-0" style="background: {{ area.colour }};">{{ loop.index }}</span>
                        <span class="text-sm text-gray-700 flex-1">{{ d.description }}</span>
                        <span class="text-sm font-bold tabular-nums" style="color: {{ area.colour }};">{{ d.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% if dd_callout %}
            <div class="callout callout-blue mt-5"><strong>Pattern:</strong> {{ dd_callout }}</div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ==================== 04 MOST COMMON ISSUES ==================== -->
    {% if top_defects %}
    <div class="section-card mb-6">
        <div class="section-num">04 &mdash; Most Common Issues</div>
        <div class="divider"></div>
        <div class="section-subtitle">Top 10 defect descriptions by frequency &middot; Median: {{ td_median }}</div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8">
            <!-- Left column: 1-5 -->
            <div>
                {% for d in top_defects[:5] %}
                <div class="flex items-center gap-3 py-2" style="border-bottom: 1px solid #f0f0f0;">
                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold flex-shrink-0 {% if loop.index <= 3 %}bg-gold text-white{% else %}bg-gray-200 text-gray-600{% endif %}">{{ loop.index }}</span>
                    <span class="text-sm text-gray-700 flex-1">{{ d.description }}</span>
                    <span class="text-sm font-bold tabular-nums {% if d.count > td_median %}text-red-600{% elif d.count == td_median %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ d.count }}</span>
                </div>
                {% endfor %}
            </div>
            <!-- Right column: 6-10 -->
            <div>
                {% for d in top_defects[5:10] %}
                <div class="flex items-center gap-3 py-2" style="border-bottom: 1px solid #f0f0f0;">
                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold flex-shrink-0 bg-gray-200 text-gray-600">{{ loop.index + 5 }}</span>
                    <span class="text-sm text-gray-700 flex-1">{{ d.description }}</span>
                    <span class="text-sm font-bold tabular-nums {% if d.count > td_median %}text-red-600{% elif d.count == td_median %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ d.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- FOOTER -->
    <div class="text-center text-xs text-gray-400 py-4 mt-2" style="border-top: 1px solid #e5e5e5;">
        Monograph Architects &middot; PPSH Phase 3 &middot; {{ label }} &middot; Generated live
    </div>

    {% endif %}
</div>
{% endblock %}
