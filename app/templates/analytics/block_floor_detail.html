{% extends "base.html" %}
{% block title %}{{ label }}{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');
    .font-display { font-family: 'Cormorant Garamond', Georgia, serif; }
    .font-body { font-family: 'DM Sans', system-ui, sans-serif; }
    .gold-accent { color: #C8963E; }
    .bg-gold { background-color: #C8963E; }
    .border-gold { border-color: #C8963E; }
    .section-num { font-family: 'Cormorant Garamond', serif; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.15em; color: #C8963E; text-transform: uppercase; }
    .verdict-bar { background: linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 100%); }
    .verdict-bar-warn { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #7f1d1d 100%); }
    .verdict-bar-good { background: linear-gradient(135deg, #14532d 0%, #166534 50%, #14532d 100%); }
    .verdict-bar-wait { background: linear-gradient(135deg, #78350f 0%, #92400e 50%, #78350f 100%); }
    .kpi-card { border-left: 3px solid #C8963E; background: #FAFAF8; }
    .kpi-value { font-family: 'DM Sans', system-ui, sans-serif; font-weight: 700; font-size: 2rem; line-height: 1; letter-spacing: -0.02em; }
    .kpi-label { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.8rem; color: #6B6B6B; margin-top: 0.35rem; }
    .data-table th { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: #6B6B6B; padding: 0.6rem 0.75rem; border-bottom: 2px solid #0A0A0A; }
    .data-table td { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.85rem; padding: 0.6rem 0.75rem; border-bottom: 1px solid #e5e5e5; }
    .data-table tr:last-child td { border-bottom: none; }
    .callout { padding: 1rem 1.25rem; border-radius: 4px; font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.85rem; line-height: 1.5; }
    .callout-red { background: rgba(196,77,63,0.08); border-left: 4px solid #C44D3F; color: #1A1A1A; }
    .callout-amber { background: rgba(200,150,62,0.1); border-left: 4px solid #C8963E; color: #1A1A1A; }
    .callout-green { background: rgba(74,124,89,0.08); border-left: 4px solid #4A7C59; color: #1A1A1A; }
    .callout-blue { background: rgba(61,107,142,0.08); border-left: 4px solid #3D6B8E; color: #1A1A1A; }
    .trajectory-worse { color: #C44D3F; }
    .trajectory-same { color: #6B6B6B; }
    .trajectory-better { color: #4A7C59; }
    .section-card { background: #FAFAF8; border: 1px solid #e5e5e5; border-radius: 8px; padding: 1.5rem; }
    .section-title { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 600; color: #0A0A0A; margin-bottom: 0.15rem; }
    .section-subtitle { font-family: 'DM Sans', system-ui, sans-serif; font-size: 0.8rem; color: #9A9A9A; margin-bottom: 1.25rem; }
    .unit-grid-cell { width: 2.5rem; height: 2.5rem; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-family: 'DM Sans', sans-serif; font-size: 0.7rem; font-weight: 600; }
    .divider { height: 1px; background: #0A0A0A; margin: 0.5rem 0 1.5rem 0; }
</style>

<div class="font-body" style="max-width: 1280px; margin: 0 auto;">

    <!-- BREADCRUMB + TITLE -->
    <div class="mb-6">
        <a href="{{ url_for('analytics.dashboard') }}" class="text-sm gold-accent hover:underline">&larr; Dashboard</a>
        <h1 class="font-display text-3xl lg:text-4xl font-bold text-gray-900 mt-2" style="letter-spacing: -0.01em;">{{ label }}</h1>
        <div class="text-sm text-gray-400 mt-1">Inspection Analytics &middot; PPSH Phase 3 &middot; Round {{ summary.max_round if has_data else '-' }}</div>
    </div>

    {% if not has_data %}
    <div class="section-card text-center py-12"><p class="text-gray-400 font-display text-xl">No inspection data for this zone yet.</p></div>
    {% else %}

    <!-- ==================== VERDICT BAR ==================== -->
    {% if rectification %}
    {% set pct = rect_totals.clearance_pct if rect_totals else 0 %}
    <div class="{% if pct >= 75 %}verdict-bar-good{% elif pct >= 25 %}verdict-bar-wait{% elif pct == 0 and rect_totals.new_defects > 0 %}verdict-bar-warn{% else %}verdict-bar-wait{% endif %} rounded-lg px-6 py-5 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
                <div class="text-white text-xs font-semibold tracking-widest uppercase mb-1" style="opacity: 0.7;">Rectification Status</div>
                <div class="font-display text-white text-2xl lg:text-3xl font-bold">
                    {% if pct == 0 and rect_totals.new_defects > 0 %}
                    Rectification Stalled
                    {% elif pct == 0 %}
                    Awaiting Rectification
                    {% elif pct < 50 %}
                    Rectification In Progress
                    {% elif pct < 100 %}
                    Rectification On Track
                    {% else %}
                    Fully Rectified
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-wrap gap-6 text-white">
                <div class="text-center"><div class="text-2xl font-bold">{{ rect_totals.prev_cleared }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">of {{ rect_totals.prev_raised }} resolved</div></div>
                <div class="text-center"><div class="text-2xl font-bold" style="{% if rect_totals.new_defects > 0 %}color: #fbbf24;{% endif %}">{{ rect_totals.new_defects }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">new defects</div></div>
                <div class="text-center"><div class="text-2xl font-bold">{{ rectification|length }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">of {{ summary.total_units }} re-inspected</div></div>
            </div>
        </div>
    </div>
    {% elif summary.max_round == 1 %}
    <div class="verdict-bar rounded-lg px-6 py-5 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
                <div class="text-white text-xs font-semibold tracking-widest uppercase mb-1" style="opacity: 0.7;">Inspection Status</div>
                <div class="font-display text-white text-2xl lg:text-3xl font-bold">Awaiting Contractor Rectification</div>
            </div>
            <div class="flex flex-wrap gap-6 text-white">
                <div class="text-center"><div class="text-2xl font-bold">{{ summary.total_defects }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">defects raised</div></div>
                <div class="text-center"><div class="text-2xl font-bold">{{ summary.total_units }}</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">units inspected</div></div>
                <div class="text-center"><div class="text-2xl font-bold">0</div><div class="text-xs uppercase tracking-wider" style="opacity: 0.6;">certified</div></div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ==================== KPI CARDS ==================== -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
        <div class="kpi-card rounded-md px-4 py-3">
            <div class="kpi-value text-gray-900">{{ summary.total_units }}</div>
            <div class="kpi-label">Units Inspected</div>
        </div>
        <div class="kpi-card rounded-md px-4 py-3">
            <div class="kpi-value {% if summary.total_defects > 0 %}text-red-700{% else %}text-emerald-700{% endif %}">{{ summary.total_defects }}</div>
            <div class="kpi-label">Open Defects</div>
        </div>
        <div class="kpi-card rounded-md px-4 py-3">
            <div class="kpi-value text-gray-900">{{ summary.avg_defects }}</div>
            <div class="kpi-label">Avg / Unit <span style="color: #9A9A9A;">(med: {{ summary.median_defects }})</span></div>
        </div>
        <div class="kpi-card rounded-md px-4 py-3">
            <div class="kpi-value text-gray-900">{{ summary.defect_rate }}%</div>
            <div class="kpi-label">Defect Rate</div>
        </div>
        <div class="kpi-card rounded-md px-4 py-3">
            <div class="kpi-value gold-accent">R{{ summary.max_round }}</div>
            <div class="kpi-label">Latest Round</div>
        </div>
    </div>

    <!-- ==================== 01 RECTIFICATION SCORECARD ==================== -->
    {% if rectification %}
    <div class="section-card mb-6">
        <div class="section-num">01 &mdash; Rectification Scorecard</div>
        <div class="divider"></div>
        <div class="section-title">Contractor Performance</div>
        <div class="section-subtitle">Defect resolution for re-inspected units &middot; Round {{ summary.max_round - 1 }} &rarr; Round {{ summary.max_round }}</div>

        <!-- Big 3 stats -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="text-center py-4 rounded-lg" style="background: {% if rect_totals.clearance_pct == 0 %}rgba(196,77,63,0.08){% elif rect_totals.clearance_pct < 50 %}rgba(200,150,62,0.08){% else %}rgba(74,124,89,0.08){% endif %};">
                <div class="font-display text-4xl lg:text-5xl font-bold {% if rect_totals.clearance_pct == 0 %}text-red-700{% elif rect_totals.clearance_pct < 50 %}text-amber-700{% else %}text-emerald-700{% endif %}">{{ rect_totals.clearance_pct }}%</div>
                <div class="text-xs font-semibold uppercase tracking-wider text-gray-500 mt-1">Rectification Rate</div>
            </div>
            <div class="text-center py-4 rounded-lg" style="background: {% if rect_totals.new_defects > 0 %}rgba(200,150,62,0.08){% else %}rgba(74,124,89,0.08){% endif %};">
                <div class="font-display text-4xl lg:text-5xl font-bold {% if rect_totals.new_defects > 0 %}text-amber-700{% else %}text-emerald-700{% endif %}">{{ rect_totals.new_defects }}</div>
                <div class="text-xs font-semibold uppercase tracking-wider text-gray-500 mt-1">New Defects Found</div>
            </div>
            <div class="text-center py-4 rounded-lg" style="background: rgba(61,107,142,0.06);">
                <div class="font-display text-4xl lg:text-5xl font-bold text-gray-800">{{ rect_totals.total_open }}</div>
                <div class="text-xs font-semibold uppercase tracking-wider text-gray-500 mt-1">Total Open Now</div>
            </div>
        </div>

        <!-- Per-unit table -->
        <table class="w-full data-table">
            <thead>
                <tr>
                    <th class="text-left">Unit</th>
                    <th class="text-center">R{{ summary.max_round - 1 }} Flagged</th>
                    <th class="text-center">Rectified</th>
                    <th class="text-center">New in R{{ summary.max_round }}</th>
                    <th class="text-center">Open Now</th>
                    <th class="text-left" style="width: 160px;">Clearance</th>
                    <th class="text-center">Trajectory</th>
                </tr>
            </thead>
            <tbody>
                {% for r in rectification %}
                <tr>
                    <td class="font-semibold">{{ r.unit_number }}</td>
                    <td class="text-center">{{ r.prev_raised }}</td>
                    <td class="text-center font-semibold {% if r.prev_cleared > 0 %}text-emerald-600{% else %}text-red-600{% endif %}">{{ r.prev_cleared }}</td>
                    <td class="text-center {% if r.new_defects > 0 %}text-amber-600 font-semibold{% else %}text-gray-400{% endif %}">{% if r.new_defects > 0 %}+{{ r.new_defects }}{% else %}&mdash;{% endif %}</td>
                    <td class="text-center font-semibold {% if r.total_open > r.prev_raised %}text-red-600{% elif r.total_open > 0 %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ r.total_open }}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 rounded-full h-2" style="background: #e5e5e5;">
                                <div class="h-2 rounded-full {% if r.clearance_pct >= 75 %}bg-emerald-500{% elif r.clearance_pct >= 25 %}bg-amber-500{% else %}bg-red-400{% endif %}" style="width: {{ [r.clearance_pct, 2]|max }}%;"></div>
                            </div>
                            <span class="text-xs font-semibold tabular-nums text-gray-500 w-10 text-right">{{ r.clearance_pct }}%</span>
                        </div>
                    </td>
                    <td class="text-center font-semibold text-sm">
                        {% if r.total_open > r.prev_raised %}
                        <span class="trajectory-worse">&#9650; Worse</span>
                        {% elif r.total_open == r.prev_raised %}
                        <span class="trajectory-same">&#9644; Same</span>
                        {% elif r.total_open > 0 %}
                        <span class="trajectory-better">&#9660; Improving</span>
                        {% else %}
                        <span class="trajectory-better">&#10003; Clear</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if rectification|length > 1 %}
                <tr style="border-top: 2px solid #0A0A0A; background: #f5f3ee;">
                    <td class="font-bold">Total</td>
                    <td class="text-center font-bold">{{ rect_totals.prev_raised }}</td>
                    <td class="text-center font-bold {% if rect_totals.prev_cleared > 0 %}text-emerald-600{% else %}text-red-600{% endif %}">{{ rect_totals.prev_cleared }}</td>
                    <td class="text-center font-bold {% if rect_totals.new_defects > 0 %}text-amber-600{% else %}text-gray-400{% endif %}">{% if rect_totals.new_defects > 0 %}+{{ rect_totals.new_defects }}{% else %}&mdash;{% endif %}</td>
                    <td class="text-center font-bold {% if rect_totals.total_open > rect_totals.prev_raised %}text-red-600{% else %}text-gray-900{% endif %}">{{ rect_totals.total_open }}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 rounded-full h-2" style="background: #e5e5e5;">
                                <div class="h-2 rounded-full {% if rect_totals.clearance_pct >= 75 %}bg-emerald-500{% elif rect_totals.clearance_pct >= 25 %}bg-amber-500{% else %}bg-red-400{% endif %}" style="width: {{ [rect_totals.clearance_pct, 2]|max }}%;"></div>
                            </div>
                            <span class="text-xs font-bold tabular-nums text-gray-600 w-10 text-right">{{ rect_totals.clearance_pct }}%</span>
                        </div>
                    </td>
                    <td class="text-center font-bold text-sm">
                        {% if rect_totals.total_open > rect_totals.prev_raised %}
                        <span class="trajectory-worse">&#9650; Worse</span>
                        {% elif rect_totals.prev_cleared > 0 %}
                        <span class="trajectory-better">&#9660; Improving</span>
                        {% else %}
                        <span class="trajectory-same">&#9644; No Change</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        {% if rect_callout %}
        <div class="callout {% if rect_totals.clearance_pct == 0 %}callout-red{% elif rect_totals.clearance_pct < 50 %}callout-amber{% else %}callout-green{% endif %} mt-5">
            <strong>Finding:</strong> {{ rect_callout }}
            {% if rect_totals.total_open > rect_totals.prev_raised %}
            Total defect load increased from {{ rect_totals.prev_raised }} to {{ rect_totals.total_open }} &mdash; a {{ ((rect_totals.total_open - rect_totals.prev_raised) / rect_totals.prev_raised * 100)|round|int }}% increase.
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ==================== 02 UNIT PROGRESS MAP ==================== -->
    <div class="section-card mb-6">
        <div class="section-num">{% if rectification %}02{% else %}01{% endif %} &mdash; Unit Progress</div>
        <div class="divider"></div>
        <div class="section-title">Pipeline Overview</div>
        <div class="section-subtitle">All {{ summary.total_units }} units in this zone &middot; Colour indicates current status</div>

        <div class="flex flex-wrap gap-2 mb-4">
            {% for u in units|sort(attribute='unit_number') %}
            {% set is_reinspected = (u.round_number > 1) %}
            <div class="unit-grid-cell {% if u.insp_status == 'certified' %}bg-emerald-500 text-white{% elif is_reinspected and u.defect_count > 0 %}bg-red-100 text-red-700{% elif u.defect_count > summary.median_defects %}bg-red-50 text-red-600{% elif u.defect_count == 0 %}bg-emerald-100 text-emerald-700{% else %}bg-amber-50 text-amber-700{% endif %}" title="Unit {{ u.unit_number }}: {{ u.defect_count }} defects (R{{ u.round_number }})">
                {{ u.unit_number }}
            </div>
            {% endfor %}
        </div>
        <div class="flex flex-wrap gap-4 text-xs text-gray-500">
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded bg-emerald-500"></span> Certified</span>
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded bg-emerald-100"></span> No defects</span>
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded bg-amber-50 border border-amber-200"></span> Below median</span>
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded bg-red-50 border border-red-200"></span> Above median</span>
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded bg-red-100"></span> Re-inspected, not improving</span>
        </div>
    </div>

    <!-- ==================== 03 WHERE TO FOCUS ==================== -->
    {% if area_data %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="section-card">
            <div class="section-num">{% if rectification %}03{% else %}02{% endif %} &mdash; Defect Hotspots</div>
            <div class="divider"></div>
            <div class="section-title">Where to Focus</div>
            <div class="section-subtitle">Defects by area &middot; Prioritise top areas for rectification</div>

            <div class="space-y-3">
                {% for a in area_data %}
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-800">{{ a.area }}</span>
                        <span class="text-sm font-bold tabular-nums" style="color: {{ a.colour }};">{{ a.defect_count }} <span class="font-normal text-gray-400 text-xs">({{ a.pct }}%)</span></span>
                    </div>
                    <div class="w-full rounded-full h-3" style="background: #e5e5e5;">
                        <div class="h-3 rounded-full" style="width: {{ a.bar_pct }}%; background: {{ a.colour }};"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if area_data|length >= 2 %}
            <div class="callout callout-amber mt-5">
                <strong>Focus:</strong> {{ area_data[0].area }} and {{ area_data[1].area }} account for {{ area_data[0].pct + area_data[1].pct }}% of all defects. Prioritise these areas.
            </div>
            {% endif %}
        </div>

        <!-- AREA DEEP DIVE -->
        {% if area_deep_dive %}
        <div class="section-card">
            <div class="section-num">{% if rectification %}04{% else %}03{% endif %} &mdash; Deep Dive</div>
            <div class="divider"></div>
            <div class="section-title">Top Issues by Area</div>
            <div class="section-subtitle">Most common defects in highest-impact areas</div>

            {% for area in area_deep_dive %}
            <div class="{% if not loop.first %}mt-5 pt-5{% endif %}" style="{% if not loop.first %}border-top: 1px solid #e5e5e5;{% endif %}">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-1 h-6 rounded-full" style="background: {{ area.colour }};"></div>
                    <span class="font-semibold text-gray-900">{{ area.area }}</span>
                    <span class="text-xs text-gray-400">{{ area.total }} defects ({{ area.pct_of_total }}%)</span>
                </div>
                <div class="space-y-2">
                    {% for d in area.defects %}
                    <div class="flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold text-white flex-shrink-0" style="background: {{ area.colour }};">{{ loop.index }}</span>
                        <span class="text-sm text-gray-700 flex-1">{{ d.description }}</span>
                        <span class="text-sm font-bold tabular-nums" style="color: {{ area.colour }};">{{ d.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% if dd_callout %}
            <div class="callout callout-blue mt-5"><strong>Pattern:</strong> {{ dd_callout }}</div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ==================== 05 MOST COMMON DEFECTS ==================== -->
    {% if top_defects %}
    <div class="section-card mb-6">
        <div class="section-num">{% if rectification %}05{% else %}04{% endif %} &mdash; Defect Types</div>
        <div class="divider"></div>
        <div class="section-title">Most Common Issues</div>
        <div class="section-subtitle">Top 10 defect descriptions by frequency &middot; Median: {{ td_median }}</div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-2">
            {% for d in top_defects %}
            <div class="flex items-center gap-3 py-2" style="border-bottom: 1px solid #f0f0f0;">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold flex-shrink-0 {% if loop.index <= 3 %}bg-gold text-white{% else %}bg-gray-200 text-gray-600{% endif %}">{{ loop.index }}</span>
                <span class="text-sm text-gray-700 flex-1">{{ d.description }}</span>
                <span class="text-sm font-bold tabular-nums {% if d.count > td_median %}text-red-600{% elif d.count == td_median %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ d.count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ==================== 06 UNIT DETAIL TABLE ==================== -->
    {% if units %}
    <div class="section-card mb-6">
        <div class="section-num">{% if rectification %}06{% else %}05{% endif %} &mdash; Evidence</div>
        <div class="divider"></div>
        <div class="section-title">Unit-by-Unit Detail</div>
        <div class="section-subtitle">All units ranked worst-first &middot; Median: {{ summary.median_defects }} defects</div>

        <div class="overflow-x-auto">
            <table class="w-full data-table">
                <thead>
                    <tr>
                        <th class="text-left">Unit</th>
                        <th class="text-center">Round</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Defects</th>
                        <th class="text-center">Rate</th>
                        <th class="text-left" style="width: 35%;">Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    {% set max_defects = units[0].defect_count if units else 1 %}
                    {% for u in units %}
                    <tr>
                        <td class="font-semibold">{{ u.unit_number }}</td>
                        <td class="text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold {% if u.round_number > 1 %}bg-blue-100 text-blue-700{% else %}bg-gray-100 text-gray-600{% endif %}">R{{ u.round_number }}</span></td>
                        <td class="text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold {{ u.status_colour }}">{{ u.status_label }}</span></td>
                        <td class="text-center font-bold tabular-nums {% if u.defect_count > summary.median_defects %}text-red-600{% elif u.defect_count == summary.median_defects %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ u.defect_count }}</td>
                        <td class="text-center text-sm tabular-nums text-gray-500">{{ u.defect_rate }}%</td>
                        <td>
                            <div class="rounded-full h-2" style="background: #e5e5e5;">
                                <div class="h-2 rounded-full {% if u.defect_count > summary.median_defects %}bg-red-400{% elif u.defect_count == summary.median_defects %}bg-amber-400{% else %}bg-emerald-400{% endif %}" style="width: {{ (u.defect_count / max_defects * 100)|round }}%;"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="flex flex-wrap gap-4 text-xs text-gray-400 mt-3">
            <span>Colour relative to median ({{ summary.median_defects }})</span>
            <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span> Below</span>
            <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-amber-500"></span> At</span>
            <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-red-500"></span> Above</span>
        </div>
    </div>
    {% endif %}

    <!-- ==================== ROUND STATISTICS (collapsed) ==================== -->
    {% if rounds|length > 1 %}
    <details class="section-card mb-6">
        <summary class="cursor-pointer">
            <span class="section-num">{% if rectification %}07{% else %}06{% endif %} &mdash; Round Statistics</span>
            <span class="text-xs text-gray-400 ml-2">(click to expand)</span>
        </summary>
        <div class="divider mt-2"></div>
        <div class="section-subtitle">Independent stats per round. Unit counts differ between rounds &mdash; compare rates, not totals.</div>
        <div class="grid grid-cols-1 sm:grid-cols-{{ rounds|length }} gap-4 mt-3">
            {% for r in rounds %}
            <div class="p-4 rounded-lg {% if loop.last %}bg-blue-50{% else %}bg-gray-50{% endif %}">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Round {{ r.round_number }}</div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">Units inspected</span><span class="font-semibold">{{ r.units_inspected }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Defects raised</span><span class="font-semibold">{{ r.total_defects }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Avg per unit</span><span class="font-semibold">{{ r.avg_defects }}</span></div>
                    <div class="flex justify-between pt-2" style="border-top: 1px solid #e5e5e5;"><span class="text-gray-500">Still open</span><span class="font-semibold {% if r.still_open > 0 %}text-red-600{% else %}text-emerald-600{% endif %}">{{ r.still_open }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Cleared</span><span class="font-semibold text-emerald-600">{{ r.cleared }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Clearance rate</span><span class="font-semibold {% if r.clearance_pct >= 50 %}text-emerald-600{% else %}text-amber-600{% endif %}">{{ r.clearance_pct }}%</span></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}

    <!-- FOOTER -->
    <div class="text-center text-xs text-gray-400 py-4 mt-2" style="border-top: 1px solid #e5e5e5;">
        Monograph Architects &middot; PPSH Phase 3 &middot; {{ label }} &middot; Generated live
    </div>

    {% endif %}
</div>
{% endblock %}
