{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- Header + Cycle Selector -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h1 class="text-2xl font-bold text-gray-900">Analytics Dashboard</h1>
        {% if cycles %}
        <form method="GET" action="{{ url_for('analytics.dashboard') }}" class="flex items-center gap-2">
            <label for="cycle" class="text-sm text-gray-600 whitespace-nowrap">Cycle:</label>
            <select name="cycle" id="cycle" onchange="this.form.submit()"
                    class="block rounded-lg border-gray-300 shadow-sm text-sm px-3 py-2 bg-white border focus:ring-2 focus:ring-primary focus:border-primary">
                <option value="all" {% if selected_cycle_id == 'all' %}selected{% endif %}>All (Project Overview)</option>
                {% for c in cycles %}
                <option value="{{ c.id }}" {% if c.id == selected_cycle_id %}selected{% endif %}>
                    Cycle {{ c.cycle_number }} ({{ c.unit_start }}-{{ c.unit_end }}) {% if c.status == 'active' %} - Active{% endif %}
                </option>
                {% endfor %}
            </select>
        </form>
        {% endif %}
    </div>
    {% if context_header %}
    <div class="text-sm text-gray-500 -mt-2 mb-4">{{ context_header }}</div>
    {% endif %}

    {% if not has_data %}
    <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
        No inspection data available for the selected cycle.
    </div>
    {% else %}

    <!-- 1. SUMMARY CARDS -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold text-gray-900">{{ summary.total_units }}</div>
            <div class="text-sm text-gray-500 mt-1">units inspected</div>
            {% if is_all_view and trend_data %}<div class="text-xs mt-1"><span class="text-gray-400">{{ trend_data.b5_label }}: {{ trend_data.b5_units }}</span> <span class="text-gray-300">|</span> <span class="text-gray-400">{{ trend_data.b6_label }}: {{ trend_data.b6_units }}</span></div>{% endif %}
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold {% if summary.total_defects > 0 %}text-red-600{% else %}text-emerald-600{% endif %}">{{ summary.total_defects }}</div>
            <div class="text-sm text-gray-500 mt-1">open defects</div>
            {% if is_all_view and trend_data %}<div class="text-xs mt-1"><span class="text-gray-400">{{ trend_data.b5_label }}: {{ trend_data.b5_defects }}</span> <span class="text-gray-300">|</span> <span class="text-gray-400">{{ trend_data.b6_label }}: {{ trend_data.b6_defects }}</span> <span class="{% if trend_data.defect_change > 0 %}text-red-500{% else %}text-emerald-500{% endif %} font-semibold">{% if trend_data.defect_change > 0 %}&#9650;{% else %}&#9660;{% endif %}{{ trend_data.defect_change }}%</span></div>{% endif %}
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold text-gray-900">{{ summary.avg_defects }}</div>
            <div class="text-sm text-gray-500 mt-1">avg per unit ({{ summary.min_defects }}-{{ summary.max_defects }})</div>
            <div class="text-xs text-gray-400 mt-0.5">median: {{ summary.median_defects }}</div>
            {% if is_all_view and trend_data %}<div class="text-xs mt-1"><span class="text-gray-400">{{ trend_data.b5_label }}: {{ trend_data.b5_avg }}</span> <span class="text-gray-300">|</span> <span class="text-gray-400">{{ trend_data.b6_label }}: {{ trend_data.b6_avg }}</span> <span class="{% if trend_data.avg_change > 0 %}text-red-500{% else %}text-emerald-500{% endif %} font-semibold">{% if trend_data.avg_change > 0 %}&#9650;{% else %}&#9660;{% endif %}{{ trend_data.avg_change }}%</span></div>{% endif %}
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold {% if summary.defect_rate is defined and summary.defect_rate > 5 %}text-red-600{% elif summary.defect_rate is defined and summary.defect_rate > 3 %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ summary.defect_rate }}%</div>
            <div class="text-sm text-gray-500 mt-1">defect rate ({{ summary.items_inspected }} items)</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold {% if summary.certified_count > 0 %}text-emerald-600{% else %}text-gray-400{% endif %}">{{ summary.certified_count }}</div>
            <div class="text-sm text-gray-500 mt-1">certified (of {{ summary.total_units }})</div>
        </div>
    </div>

    {% if is_all_view and block_comparison %}
    <div class="grid grid-cols-1 lg:grid-cols-{{ block_comparison|length }} gap-4 mb-6">
        {% for b in block_comparison %}
        <div class="bg-white rounded-lg shadow p-5 border-l-4 {% if loop.index == 1 %}border-amber-500{% else %}border-blue-500{% endif %}">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">{{ b.block }}</h3>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ b.units }}</div>
                    <div class="text-xs text-gray-500">units</div>
                </div>
                <div>
                    <div class="text-2xl font-bold {% if b.defects > 400 %}text-red-600{% else %}text-amber-600{% endif %}">{{ b.defects }}</div>
                    <div class="text-xs text-gray-500">defects</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ b.avg_per_unit }}</div>
                    <div class="text-xs text-gray-500">avg/unit</div>
                </div>
            </div>
            <div class="border-t border-gray-100 my-3"></div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <div class="text-lg font-semibold {% if b.defect_rate > 7 %}text-red-600{% elif b.defect_rate > 4 %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ b.defect_rate }}%</div>
                    <div class="text-xs text-gray-500">defect rate</div>
                </div>
                <div>
                    <div class="text-lg font-semibold text-gray-700">{{ b.unit_range }}</div>
                    <div class="text-xs text-gray-500">unit range</div>
                </div>
                <div>
                    <div class="text-lg font-semibold text-gray-700">{{ b.inspection_date }}</div>
                    <div class="text-xs text-gray-500">inspected</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- INSPECTION PIPELINE -->
    {% if pipeline_data %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Inspection Pipeline</h2>
        <p class="text-sm text-gray-500 mb-4">Unit progression through inspection stages.</p>
        <div class="flex items-center justify-between max-w-2xl mx-auto">
            {% set total_units_pipeline = pipeline_data[0].count + pipeline_data[1].count + pipeline_data[2].count %}
            {% set step2_plus = pipeline_data[1].count + pipeline_data[2].count %}
            {% set step3_only = pipeline_data[2].count %}
            {% for step in pipeline_data %}
            {% if loop.index == 1 %}
                {% set step_reached = total_units_pipeline > 0 %}
            {% elif loop.index == 2 %}
                {% set step_reached = step2_plus > 0 %}
            {% else %}
                {% set step_reached = step3_only > 0 %}
            {% endif %}
            <div class="flex-1 text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full font-bold text-lg mb-2
                    {% if step_reached %}
                        {% if loop.index == 3 %}bg-emerald-500 text-white{% elif loop.index == 2 %}bg-blue-500 text-white{% else %}bg-gray-500 text-white{% endif %}
                    {% else %}bg-gray-100 text-gray-300 border-2 border-dashed border-gray-300{% endif %}">
                    {% if step_reached %}&#10003;{% else %}&mdash;{% endif %}
                </div>
                <div class="text-sm font-medium {% if step_reached %}text-gray-700{% else %}text-gray-400{% endif %}">{{ step.label }}</div>
                {% if step.date %}<div class="text-xs text-gray-400">{{ step.date }}</div>{% endif %}
                <div class="text-xs text-gray-400">{{ step.count }} units ({{ step.pct }}%)</div>
            </div>
            {% if not loop.last %}
            {% if loop.index == 1 %}
                {% set next_reached = step2_plus > 0 %}
            {% else %}
                {% set next_reached = step3_only > 0 %}
            {% endif %}
            <div class="flex-shrink-0 w-12 mt-[-2rem] {% if step_reached and next_reached %}h-0.5 bg-gray-400{% else %}border-t-2 border-dashed border-gray-300{% endif %}"></div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- PHASE 2: Area Comparison (Block vs Block) -->
    {% if is_all_view and area_compare_data and area_compare_data.datasets %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Defects by Area: Block Comparison</h2>
        <p class="text-sm text-gray-500 mb-4">Side-by-side comparison across blocks. Identifies areas where quality diverges.</p>
        <div class="relative" style="height: 350px;">
            <canvas id="areaCompareChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- DEFECT DISTRIBUTION BY AREA -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Defect Distribution by Area</h2>
        <p class="text-sm text-gray-500 mb-4">Breakdown of defects by physical area.</p>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Bars (left 3 cols) -->
            <div class="lg:col-span-3 space-y-3">
                {% for a in area_list %}
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm text-gray-800">{{ a.area }}</span>
                        <span class="text-sm font-semibold text-gray-900">{{ a.count }} <span class="text-gray-400 font-normal">({{ a.pct }}%)</span></span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: {{ a.bar_pct }}%; background: {{ a.colour }};"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Donut (right 2 cols) -->
            <div class="lg:col-span-2">
                <div class="relative" style="height: 260px;">
                    <canvas id="areaChart"></canvas>
                </div>
            </div>
        </div>
        {% if area_list|length >= 2 %}
        <div class="mt-4 p-3 bg-amber-50 border-l-3 border-amber-500 rounded text-sm text-gray-700" style="border-left: 3px solid #d97706;">
            <span class="font-semibold">Key finding:</span> {{ area_list[0].area }} and {{ area_list[1].area }} account for {{ area_list[0].pct + area_list[1].pct }}% of all defects.
        </div>
        {% endif %}
    </div>

    <!-- AREA DEEP DIVE -->
    {% if area_deep_dive %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Area Deep Dive</h2>
        <p class="text-sm text-gray-500 mb-4">Top 3 defect types in the highest-defect areas. {% if is_all_view %}Block breakdown shown per defect.{% endif %}</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {% for area in area_deep_dive %}
            <div class="border rounded-lg p-4" style="border-left: 4px solid {{ area.colour }};">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900">{{ area.area }}</h3>
                    <span class="text-sm text-gray-500">{{ area.total }} defects ({{ area.pct_of_total }}%)</span>
                </div>
                <div class="space-y-3">
                    {% for d in area.defects %}
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold text-white" style="background: {{ area.colour }};">{{ loop.index }}</span>
                                <span class="text-sm text-gray-800">{{ d.description }}</span>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">{{ d.count }}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2">
                            <div class="h-2 rounded-full" style="width: {{ d.bar_pct }}%; background: {{ area.colour }}; opacity: 0.7;"></div>
                        </div>
                        {% if is_all_view and d.b5 is defined %}
                        <div class="flex gap-3 mt-1">
                            <span class="text-xs text-amber-600 font-medium">B5: {{ d.b5 }}</span>
                            <span class="text-xs text-blue-600 font-medium">B6: {{ d.b6 }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% if dd_callout %}
        <div class="mt-4 p-3 bg-amber-50 border-l-3 rounded text-sm text-gray-700" style="border-left: 3px solid #d97706;">
            <span class="font-semibold">Key finding:</span> {{ dd_callout }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- DEFECTS BY CATEGORY (Trade) -->
    {% if category_list %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Defects by Category (Trade){% if is_all_view %}: Block Comparison{% endif %}</h2>
        <p class="text-sm text-gray-500 mb-4">Breakdown of defects by construction trade.</p>
        <div class="space-y-3">
            {% for c in category_list %}
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm text-gray-800">{{ c.category }}</span>
                    <span class="text-sm font-semibold text-gray-900">{{ c.count }} <span class="text-gray-400 font-normal">({{ c.pct }}%)</span></span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2">
                    <div class="h-2 rounded-full bg-red-400" style="width: {{ c.bar_pct }}%;"></div>
                </div>
                {% if is_all_view and c.b5 is defined %}
                <div class="flex gap-3 mt-1">
                    <span class="text-xs text-amber-600 font-medium">B5: {{ c.b5 }}</span>
                    <span class="text-xs text-blue-600 font-medium">B6: {{ c.b6 }}</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- TOP DEFECT TYPES: Block Comparison (all-view) -->
    {% if is_all_view and defect_compare %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Top Defect Types: Block Comparison</h2>
        <p class="text-sm text-gray-500 mb-4">Most common defect descriptions with per-block breakdown. Arrows show Block 6 vs Block 5 direction.</p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">#</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Defect Description</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Total</th>
                        {% for bl in defect_compare[0].block_labels %}
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">{{ bl }}</th>
                        {% endfor %}
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in defect_compare %}
                    {% set b5_cnt = d.blocks.get(d.block_labels[0], 0) if d.block_labels|length > 0 else 0 %}
                    {% set b6_cnt = d.blocks.get(d.block_labels[1], 0) if d.block_labels|length > 1 else 0 %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3 text-gray-400 text-xs">{{ loop.index }}</td>
                        <td class="py-2 px-3">{{ d.description }}</td>
                        <td class="py-2 px-3 text-center font-semibold">{{ d.total }}</td>
                        <td class="py-2 px-3 text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold bg-amber-50 text-amber-700">{{ b5_cnt }}</span>
                        </td>
                        <td class="py-2 px-3 text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold bg-blue-50 text-blue-700">{{ b6_cnt }}</span>
                        </td>
                        <td class="py-2 px-3 text-center">
                            {% if b6_cnt > b5_cnt %}
                            <span class="text-red-500 font-semibold text-xs">&#9650; higher</span>
                            {% elif b6_cnt < b5_cnt %}
                            <span class="text-emerald-500 font-semibold text-xs">&#9660; lower</span>
                            {% else %}
                            <span class="text-gray-400 text-xs">&#8212; same</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- TOP DEFECT TYPES (per-cycle) -->
    {% if not is_all_view and top_defects %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Most Common Defect Types</h2>
        <p class="text-sm text-gray-500 mb-4">Top 10 defect descriptions by frequency.</p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">#</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Defect Description</th>
                        <th class="text-right py-2 px-3 text-gray-600 font-medium">Count</th>
                        <th class="text-right py-2 px-3 text-gray-600 font-medium">%</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium w-1/4">Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in top_defects %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3 text-gray-400 text-xs">{{ loop.index }}</td>
                        <td class="py-2 px-3">{{ d.description }}</td>
                        <td class="py-2 px-3 text-right font-semibold">{{ d.cnt }}</td>
                        <td class="py-2 px-3 text-right text-gray-500">{{ (d.cnt / summary.total_defects * 100)|round(1) }}%</td>
                        <td class="py-2 px-3">
                            <div class="w-full bg-gray-100 rounded-full h-2">
                                {% set max_cnt = top_defects[0].cnt if top_defects else 1 %}
                                <div class="h-2 rounded-full bg-red-400" style="width: {{ (d.cnt / max_cnt * 100)|round }}%;"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- UNIT SUMMARY (combined ranking + details, worst first) -->
    {% if unit_summary %}
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Unit Summary</h2>
        <p class="text-sm text-gray-500 mb-4">All units ranked by defect count (worst first) with status and defect rate.</p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Unit</th>
                        {% if is_all_view %}<th class="text-center py-2 px-3 text-gray-600 font-medium">Block</th>{% endif %}
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Floor</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Status</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium" colspan="1">Defects</th>
                    </tr>
                </thead>
                <tbody>
                    {% set max_defects = unit_summary[0].defect_count if unit_summary else 1 %}
                    {% for u in unit_summary %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3 font-medium">{{ u.unit_number }}</td>
                        {% if is_all_view %}<td class="py-2 px-3 text-center"><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold {% if u.block == 'Block 5' %}bg-amber-100 text-amber-700{% else %}bg-blue-100 text-blue-700{% endif %}">{{ u.block|replace('Block ', 'B') }}</span></td>{% endif %}
                        <td class="py-2 px-3 text-center text-gray-500">{{ floor_map.get(u.floor, u.floor) if u.floor is not none else '' }}</td>
                        <td class="py-2 px-3 text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold
                                {% if u.status == 'Issued to Site' %}bg-emerald-100 text-emerald-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                {{ u.status }}
                            </span>
                        </td>
                        <td class="py-2 px-3">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold tabular-nums w-8 text-right {% if u.defect_count > 30 %}text-red-600{% elif u.defect_count > 20 %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ u.defect_count }}</span>
                                <div class="flex-1 bg-gray-100 rounded-full h-2">
                                    <div class="h-2 rounded-full {% if u.defect_count > 30 %}bg-red-400{% elif u.defect_count > 20 %}bg-amber-400{% else %}bg-emerald-400{% endif %}" style="width: {{ (u.defect_count / max_defects * 100)|round }}%;"></div>
                                </div>
                                <span class="text-xs tabular-nums text-gray-400 w-12 text-right">{{ u.defect_rate }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- EXTENDED ANALYTICS -->
    <div class="border-t-2 border-gray-200 pt-4 mt-2">
        <p class="text-xs font-medium text-gray-400 uppercase tracking-wider mb-4">Extended Analytics</p>
    </div>

    <!-- 5. HEATMAP: AREA x UNIT (sortable) -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Heatmap: Defects by Unit &amp; Area</h2>
        <p class="text-xs text-gray-400 mb-4">Click any column header to sort.</p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="heatmapTable">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-2 text-gray-600 font-medium sticky left-0 bg-white cursor-pointer select-none hover:text-gray-900 transition-colors"
                            onclick="sortHeatmap(-1)" data-col="-1">
                            Unit <span class="sort-arrow text-xs"></span>
                        </th>
                        {% for area in all_areas %}
                        <th class="text-center py-2 px-2 text-gray-600 font-medium text-xs cursor-pointer select-none hover:text-gray-900 transition-colors"
                            onclick="sortHeatmap({{ loop.index0 }})" data-col="{{ loop.index0 }}">
                            {{ area }} <span class="sort-arrow text-xs"></span>
                        </th>
                        {% endfor %}
                        <th class="text-center py-2 px-2 text-gray-900 font-bold cursor-pointer select-none hover:text-blue-600 transition-colors"
                            onclick="sortHeatmap({{ all_areas|length }})" data-col="{{ all_areas|length }}">
                            Total <span class="sort-arrow text-xs"></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="heatmapBody">
                    {% for unit_num in all_units_sorted %}
                    <tr class="border-b border-gray-100 heatmap-row" data-unit="{{ unit_num }}" data-total="{{ unit_totals.get(unit_num, 0) }}"
                        {% for area in all_areas %}data-area-{{ loop.index0 }}="{{ heatmap.get(unit_num, {}).get(area, 0) }}"{% endfor %}>
                        <td class="py-2 px-2 font-medium sticky left-0 bg-white">{{ unit_num }}</td>
                        {% for area in all_areas %}
                        {% set val = heatmap.get(unit_num, {}).get(area, 0) %}
                        <td class="text-center py-2 px-2">
                            {% if val == 0 %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-emerald-50 text-emerald-400">0</span>
                            {% elif val <= 2 %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-yellow-100 text-yellow-700 font-medium">{{ val }}</span>
                            {% elif val <= 4 %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-orange-100 text-orange-700 font-semibold">{{ val }}</span>
                            {% else %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-red-100 text-red-700 font-bold">{{ val }}</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="text-center py-2 px-2 font-bold text-gray-900">{{ unit_totals.get(unit_num, 0) }}</td>
                    </tr>
                    {% endfor %}
                    <!-- Column totals (pinned to bottom) -->
                    <tr class="border-t-2 border-gray-300 bg-gray-50" id="heatmapTotals">
                        <td class="py-2 px-2 font-bold sticky left-0 bg-gray-50">Total</td>
                        {% for area in all_areas %}
                        <td class="text-center py-2 px-2 font-bold text-gray-900">{{ area_totals.get(area, 0) }}</td>
                        {% endfor %}
                        <td class="text-center py-2 px-2 font-bold text-gray-900">{{ summary.total_defects }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 6. SYSTEMIC / RECURRING DEFECTS -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Systemic Issues (Recurring Defects)</h2>
        <p class="text-sm text-gray-500 mb-4">Defects appearing in 3 or more units - address these project-wide, not unit-by-unit.</p>
        {% if recurring %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Defect Description</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Count</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Category</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Affected Units</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in recurring %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3">{{ r.original_comment }}</td>
                        <td class="py-2 px-3 text-center font-semibold text-red-600">{{ r.cnt }}</td>
                        <td class="py-2 px-3 text-gray-600">{{ r.category_name }}</td>
                        <td class="py-2 px-3 text-gray-500 text-xs">{{ r.affected_units }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-sm text-gray-400">No recurring defects found across 3+ units.</p>
        {% endif %}
    </div>

    <!-- 7. INSPECTOR PERFORMANCE -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Inspector Performance</h2>
        <p class="text-sm text-gray-500 mb-4">Variance may reflect unit quality or inspector thoroughness.</p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Inspector</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Units</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Total Defects</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Avg / Unit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in inspector_stats %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3 font-medium">{{ s.inspector_name }}</td>
                        <td class="py-2 px-3 text-center">{{ s.units_inspected }}</td>
                        <td class="py-2 px-3 text-center font-semibold">{{ s.total_defects }}</td>
                        <td class="py-2 px-3 text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold
                                {% if s.avg_per_unit >= 25 %}bg-red-100 text-red-700
                                {% elif s.avg_per_unit >= 20 %}bg-orange-100 text-orange-700
                                {% else %}bg-emerald-100 text-emerald-700{% endif %}">
                                {{ s.avg_per_unit }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if has_data %}
<script>
// --- Area Donut Chart ---
const areaCtx = document.getElementById('areaChart').getContext('2d');
const centerLabelPlugin = {
    id: 'centerLabel',
    afterDraw(chart) {
        const { ctx, chartArea: { left, right, top, bottom } } = chart;
        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        const cx = (left + right) / 2;
        const cy = (top + bottom) / 2;
        ctx.save();
        ctx.font = 'bold 28px sans-serif';
        ctx.fillStyle = '#1a1a1a';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(total, cx, cy + 4);
        ctx.font = '12px sans-serif';
        ctx.fillStyle = '#6b6b6b';
        ctx.textBaseline = 'top';
        ctx.fillText('defects', cx, cy + 6);
        ctx.restore();
    }
};
new Chart(areaCtx, {
    type: 'doughnut',
    data: {
        labels: {{ area_data.labels | tojson }},
        datasets: [{
            data: {{ area_data.counts | tojson }},
            backgroundColor: {{ area_data.colours | tojson }},
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 10,
                    usePointStyle: true,
                    pointStyle: 'circle',
                    font: { size: 11 }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(ctx) {
                        const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                        const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                        return ctx.label + ': ' + ctx.raw + ' (' + pct + '%)';
                    }
                }
            }
        }
    },
    plugins: [centerLabelPlugin]
});

// --- Area Comparison Grouped Bar (Phase 2) ---
{% if is_all_view and area_compare_data and area_compare_data.datasets %}
const areaCompCtx = document.getElementById("areaCompareChart").getContext("2d");
new Chart(areaCompCtx, {
    type: "bar",
    data: {
        labels: {{ area_compare_data.labels | tojson }},
        datasets: [
            {% for ds in area_compare_data.datasets %}
            {
                label: {{ ds.label | tojson }},
                data: {{ ds.data | tojson }},
                backgroundColor: {{ ds.colour | tojson }},
                borderRadius: 4
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    },
    options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: "top", labels: { padding: 16, font: { size: 12 } } }
        },
        scales: {
            x: { beginAtZero: true, grid: { color: "#f3f4f6" } },
            y: { grid: { display: false }, ticks: { font: { size: 12, weight: "bold" } } }
        }
    }
});
{% endif %}
</script>

<!-- Heatmap sort logic -->
<script>
(function() {
    var currentCol = -1;  // default: Unit column
    var currentDir = 'asc';
    var numAreas = {{ all_areas|length }};

    function getVal(row, col) {
        if (col === -1) return row.getAttribute('data-unit');
        if (col === numAreas) return parseInt(row.getAttribute('data-total')) || 0;
        return parseInt(row.getAttribute('data-area-' + col)) || 0;
    }

    window.sortHeatmap = function(col) {
        if (col === currentCol) {
            currentDir = currentDir === 'desc' ? 'asc' : 'desc';
        } else {
            currentCol = col;
            currentDir = (col === -1) ? 'asc' : 'desc';
        }

        var tbody = document.getElementById('heatmapBody');
        var rows = Array.from(tbody.querySelectorAll('.heatmap-row'));
        var totalsRow = document.getElementById('heatmapTotals');

        rows.sort(function(a, b) {
            var va = getVal(a, col);
            var vb = getVal(b, col);
            var cmp;
            if (col === -1) {
                cmp = va.localeCompare(vb);
            } else {
                cmp = va - vb;
            }
            return currentDir === 'desc' ? -cmp : cmp;
        });

        rows.forEach(function(row) { tbody.appendChild(row); });
        tbody.appendChild(totalsRow);

        // Update arrows
        var arrows = document.querySelectorAll('#heatmapTable .sort-arrow');
        arrows.forEach(function(a) { a.textContent = ''; });

        var activeHeader = document.querySelector('#heatmapTable th[data-col="' + col + '"] .sort-arrow');
        if (activeHeader) {
            activeHeader.textContent = currentDir === 'desc' ? ' \u25BC' : ' \u25B2';
        }

        // Highlight active column header
        var headers = document.querySelectorAll('#heatmapTable th');
        headers.forEach(function(h) { h.classList.remove('text-blue-600'); });
        var activeTh = document.querySelector('#heatmapTable th[data-col="' + col + '"]');
        if (activeTh) activeTh.classList.add('text-blue-600');
    };

    // Auto-sort on load: Unit ascending
    sortHeatmap(-1);
})();
</script>
{% endif %}
{% endblock %}
