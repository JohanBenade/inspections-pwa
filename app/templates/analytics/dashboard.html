{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- Header + Cycle Selector -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h1 class="text-2xl font-bold text-gray-900">Analytics Dashboard</h1>
        {% if cycles %}
        <form method="GET" action="{{ url_for('analytics.dashboard') }}" class="flex items-center gap-2">
            <label for="cycle" class="text-sm text-gray-600 whitespace-nowrap">Cycle:</label>
            <select name="cycle" id="cycle" onchange="this.form.submit()"
                    class="block rounded-lg border-gray-300 shadow-sm text-sm px-3 py-2 bg-white border focus:ring-2 focus:ring-primary focus:border-primary">
                {% for c in cycles %}
                <option value="{{ c.id }}" {% if c.id == selected_cycle_id %}selected{% endif %}>
                    Cycle {{ c.cycle_number }} ({{ c.unit_start }}-{{ c.unit_end }}) {% if c.status == 'active' %} - Active{% endif %}
                </option>
                {% endfor %}
            </select>
        </form>
        {% endif %}
    </div>

    {% if not has_data %}
    <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
        No inspection data available for the selected cycle.
    </div>
    {% else %}

    <!-- 1. SUMMARY CARDS -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold text-gray-900">{{ summary.total_units }}</div>
            <div class="text-sm text-gray-500 mt-1">units inspected</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold {% if summary.total_defects > 0 %}text-red-600{% else %}text-emerald-600{% endif %}">{{ summary.total_defects }}</div>
            <div class="text-sm text-gray-500 mt-1">open defects</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold text-gray-900">{{ summary.avg_defects }}</div>
            <div class="text-sm text-gray-500 mt-1">avg per unit ({{ summary.min_defects }}-{{ summary.max_defects }})</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-3xl font-bold text-red-600">{{ summary.worst_unit }}</div>
            <div class="text-sm text-gray-500 mt-1">worst unit ({{ summary.worst_count }} defects)</div>
        </div>
    </div>

    <!-- Charts Row: Area Donut + Category Bars -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- 2. DEFECTS BY AREA (Donut) -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Defects by Area</h2>
            <div class="relative" style="height: 300px;">
                <canvas id="areaChart"></canvas>
            </div>
        </div>

        <!-- 3. DEFECTS BY CATEGORY (Horizontal Bar) -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Defects by Category (Trade)</h2>
            <div class="relative" style="max-height: 320px;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 4. UNIT RANKING -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Unit Ranking (worst first)</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Unit</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Inspector</th>
                        <th class="text-right py-2 px-3 text-gray-600 font-medium">Defects</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium w-1/2">Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in unit_ranking %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3 font-medium">{{ u.unit_number }}</td>
                        <td class="py-2 px-3 text-gray-600">{{ u.inspector_name }}</td>
                        <td class="py-2 px-3 text-right font-semibold">{{ u.cnt }}</td>
                        <td class="py-2 px-3">
                            <div class="w-full bg-gray-100 rounded-full h-5 relative">
                                {% set pct = (u.cnt / summary.worst_count * 100) if summary.worst_count > 0 else 0 %}
                                {% set r = ((pct / 100) * 220)|int %}
                                {% set g = (((100 - pct) / 100) * 180)|int %}
                                <div class="h-5 rounded-full flex items-center justify-end pr-2"
                                     style="width: {{ pct }}%; background-color: rgb({{ r }}, {{ g }}, 80); min-width: 2rem;">
                                    <span class="text-xs font-medium text-white">{{ u.cnt }}</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 5. HEATMAP: AREA x UNIT -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Heatmap: Defects by Unit &amp; Area</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-2 text-gray-600 font-medium sticky left-0 bg-white">Unit</th>
                        {% for area in all_areas %}
                        <th class="text-center py-2 px-2 text-gray-600 font-medium text-xs">{{ area }}</th>
                        {% endfor %}
                        <th class="text-center py-2 px-2 text-gray-900 font-bold">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for unit_num in all_units_sorted %}
                    <tr class="border-b border-gray-100">
                        <td class="py-2 px-2 font-medium sticky left-0 bg-white">{{ unit_num }}</td>
                        {% for area in all_areas %}
                        {% set val = heatmap.get(unit_num, {}).get(area, 0) %}
                        <td class="text-center py-2 px-2">
                            {% if val == 0 %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-emerald-50 text-emerald-400">0</span>
                            {% elif val <= 2 %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-yellow-100 text-yellow-700 font-medium">{{ val }}</span>
                            {% elif val <= 4 %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-orange-100 text-orange-700 font-semibold">{{ val }}</span>
                            {% else %}
                            <span class="inline-block w-8 h-8 leading-8 rounded text-xs bg-red-100 text-red-700 font-bold">{{ val }}</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="text-center py-2 px-2 font-bold text-gray-900">{{ unit_totals.get(unit_num, 0) }}</td>
                    </tr>
                    {% endfor %}
                    <!-- Column totals -->
                    <tr class="border-t-2 border-gray-300 bg-gray-50">
                        <td class="py-2 px-2 font-bold sticky left-0 bg-gray-50">Total</td>
                        {% for area in all_areas %}
                        <td class="text-center py-2 px-2 font-bold text-gray-900">{{ area_totals.get(area, 0) }}</td>
                        {% endfor %}
                        <td class="text-center py-2 px-2 font-bold text-gray-900">{{ summary.total_defects }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 6. SYSTEMIC / RECURRING DEFECTS -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Systemic Issues (Recurring Defects)</h2>
        <p class="text-sm text-gray-500 mb-4">Defects appearing in 3 or more units - address these project-wide, not unit-by-unit.</p>
        {% if recurring %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Defect Description</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Count</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Category</th>
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Affected Units</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in recurring %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3">{{ r.original_comment }}</td>
                        <td class="py-2 px-3 text-center font-semibold text-red-600">{{ r.cnt }}</td>
                        <td class="py-2 px-3 text-gray-600">{{ r.category_name }}</td>
                        <td class="py-2 px-3 text-gray-500 text-xs">{{ r.affected_units }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-sm text-gray-400">No recurring defects found across 3+ units.</p>
        {% endif %}
    </div>

    <!-- 7. INSPECTOR PERFORMANCE -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Inspector Performance</h2>
        <p class="text-sm text-gray-500 mb-4">Variance may reflect unit quality or inspector thoroughness.</p>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-gray-600 font-medium">Inspector</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Units</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Total Defects</th>
                        <th class="text-center py-2 px-3 text-gray-600 font-medium">Avg / Unit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in inspector_stats %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-3 font-medium">{{ s.inspector_name }}</td>
                        <td class="py-2 px-3 text-center">{{ s.units_inspected }}</td>
                        <td class="py-2 px-3 text-center font-semibold">{{ s.total_defects }}</td>
                        <td class="py-2 px-3 text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold
                                {% if s.avg_per_unit >= 25 %}bg-red-100 text-red-700
                                {% elif s.avg_per_unit >= 20 %}bg-orange-100 text-orange-700
                                {% else %}bg-emerald-100 text-emerald-700{% endif %}">
                                {{ s.avg_per_unit }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if has_data %}
<script>
// --- Area Donut Chart ---
const areaCtx = document.getElementById('areaChart').getContext('2d');
new Chart(areaCtx, {
    type: 'doughnut',
    data: {
        labels: {{ area_data.labels | tojson }},
        datasets: [{
            data: {{ area_data.counts | tojson }},
            backgroundColor: {{ area_data.colours | tojson }},
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    padding: 12,
                    usePointStyle: false,
                    font: { size: 12 },
                    generateLabels: function(chart) {
                        const data = chart.data;
                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                        return data.labels.map((label, i) => {
                            const val = data.datasets[0].data[i];
                            const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                            return {
                                text: label + ' (' + val + ', ' + pct + '%)',
                                fillStyle: data.datasets[0].backgroundColor[i],
                                hidden: false,
                                index: i,
                                pointStyle: 'circle',
                                strokeStyle: data.datasets[0].backgroundColor[i]
                            };
                        });
                    }
                }
            }
        }
    }
});

// --- Category Horizontal Bar Chart ---
const catCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(catCtx, {
    type: 'bar',
    data: {
        labels: {{ category_data.labels | tojson }},
        datasets: [{
            data: {{ category_data.counts | tojson }},
            backgroundColor: '#ef4444',
            borderRadius: 4
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: { color: '#f3f4f6' }
            },
            y: {
                grid: { display: false },
                ticks: { font: { size: 12, weight: 'bold' } }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
