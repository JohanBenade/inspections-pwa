<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Combined Inspection Report - {{ report_date }}</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap');

@page {
    size: A4;
    margin: 18mm 16mm 20mm 16mm;
    @bottom-center {
        content: "Page " counter(page) " of " counter(pages);
        font-family: 'DM Sans', Helvetica, Arial, sans-serif;
        font-size: 8pt;
        color: #9A9A9A;
    }
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'DM Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: #1A1A1A;
    background: #FAFAF8;
    font-size: 11px;
    line-height: 1.5;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}

.page { max-width: 800px; margin: 0 auto; padding: 0; }
.clearfix::after { content: ""; display: table; clear: both; }

/* -- TOOLBAR (HTML view only) -- */
.toolbar {
    position: fixed;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 8px;
    z-index: 100;
}
.toolbar a, .toolbar button, .toolbar select {
    padding: 8px 16px;
    font-family: 'DM Sans', Helvetica, Arial, sans-serif;
    font-size: 12px;
    font-weight: 600;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}
.btn-pdf { background: #C8963E; color: white; }
.btn-pdf:hover { background: #D4A94F; }
.btn-print { background: #F5F3EE; color: #1A1A1A; border: 1px solid #E8E6E1; }
.btn-print:hover { background: #E8E6E1; }
.btn-back { background: #F5F3EE; color: #1A1A1A; border: 1px solid #E8E6E1; }
.btn-back:hover { background: #E8E6E1; }
.btn-select { background: #FAFAF8; color: #1A1A1A; border: 1px solid #E8E6E1; font-size: 12px; }
@media print { .toolbar { display: none !important; } }

/* -- HEADER -- */
.report-header {
    padding-bottom: 16px;
    border-bottom: 3px solid #0A0A0A;
    margin-bottom: 20px;
}
.header-top { margin-bottom: 20px; }
.header-top::after { content: ""; display: table; clear: both; }
.logo-area { float: left; }
.logo-area img { height: 36px; width: auto; }
.logo-fallback {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 22px;
    font-weight: 300;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: #0A0A0A;
}
.logo-sub {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 12px;
    font-weight: 300;
    letter-spacing: 3px;
    color: #6B6B6B;
    margin-left: 8px;
}
.header-meta {
    float: right;
    text-align: right;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: #6B6B6B;
}
.header-meta .date {
    font-size: 11px;
    letter-spacing: 0;
    text-transform: none;
    color: #1A1A1A;
    margin-top: 2px;
}
.report-title {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 32px;
    font-weight: 300;
    color: #0A0A0A;
    letter-spacing: 1px;
    margin-bottom: 6px;
}
.report-subtitle {
    font-size: 13px;
    color: #6B6B6B;
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* -- SECTION HEADERS -- */
.section { margin-bottom: 28px; page-break-inside: avoid; }
.section-header { margin-bottom: 14px; border-bottom: 1px solid #C8963E; padding-bottom: 8px; }
.section-number {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 3px;
    color: #C8963E;
    text-transform: uppercase;
    margin-right: 10px;
}
.section-title {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 22px;
    font-weight: 300;
    letter-spacing: 0.5px;
    color: #0A0A0A;
}

/* -- KPI CARDS -- */
.kpi-table { width: 100%; border-collapse: separate; border-spacing: 8px 0; margin-bottom: 20px; }
.kpi-cell {
    background: #F5F3EE;
    border-left: 3px solid #C8963E;
    padding: 12px 14px;
    vertical-align: top;
    width: 20%;
}
.kpi-value {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 28px;
    font-weight: 300;
    color: #0A0A0A;
    line-height: 1;
}
.kpi-value-red { color: #C44D3F; }
.kpi-value-green { color: #4A7C59; }
.kpi-sub {
    font-size: 9px;
    color: #9A9A9A;
    margin-top: 3px;
}
.kpi-label {
    font-size: 9px;
    color: #6B6B6B;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
}
.kpi-trend {
    font-size: 9px;
    margin-top: 3px;
    letter-spacing: 0;
    text-transform: none;
}
.trend-up { color: #C44D3F; }
.trend-down { color: #4A7C59; }
.trend-neutral { color: #9A9A9A; }

/* -- BATCH COMPARISON CARDS -- */
.batch-table { width: 100%; border-collapse: separate; border-spacing: 10px 0; margin-bottom: 10px; }
.batch-cell {
    background: #F5F3EE;
    padding: 16px 18px;
    vertical-align: top;
}
.batch-block-label {
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 700;
    color: #6B6B6B;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 10px;
}
.batch-stats-table { width: 100%; border-collapse: collapse; }
.batch-stats-table td { padding: 2px 0; }
.batch-stat-value {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 22px;
    font-weight: 300;
    color: #0A0A0A;
    line-height: 1.1;
}
.batch-stat-label {
    font-size: 9px;
    color: #9A9A9A;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* -- CALLOUT BOXES -- */
.callout {
    padding: 10px 14px;
    margin: 12px 0;
    font-size: 11px;
    line-height: 1.5;
}
.callout-gold { border-left: 3px solid #C8963E; background: rgba(200,150,62,0.08); }
.callout-blue { border-left: 3px solid #3D6B8E; background: rgba(61,107,142,0.08); }
.callout-red { border-left: 3px solid #C44D3F; background: rgba(196,77,63,0.08); }
.callout-green { border-left: 3px solid #4A7C59; background: rgba(74,124,89,0.08); }

/* -- GROUPED BAR CHART (CSS) -- */
.grouped-bar-table { width: 100%; border-collapse: collapse; }
.grouped-bar-table td { padding: 2px 0; vertical-align: middle; }
.bar-label-cell { width: 110px; text-align: left; padding-right: 12px; font-size: 11px; color: #1A1A1A; white-space: nowrap; }
.bar-track { padding: 0; white-space: nowrap; }
.bar-fill {
    display: inline-block;
    height: 10px;
    border-radius: 2px;
    vertical-align: middle;
}
.bar-count-label {
    display: inline-block;
    font-size: 9px;
    font-weight: 600;
    color: #6B6B6B;
    margin-left: 4px;
    vertical-align: middle;
}

/* -- DATA TABLES -- */
.data-table { width: 100%; border-collapse: collapse; font-size: 10px; }
.data-table th {
    padding: 7px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 8px;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: #6B6B6B;
    border-bottom: 2px solid #0A0A0A;
}
.data-table th.text-right { text-align: right; }
.data-table th.text-center { text-align: center; }
.data-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #F0F0F0;
    vertical-align: middle;
}
.data-table tbody tr:nth-child(even) td { background: #F5F3EE; }
.data-table tfoot td {
    padding: 7px 8px;
    font-weight: 600;
    border-top: 2px solid #0A0A0A;
}
.text-right { text-align: right; }
.text-center { text-align: center; }
.font-bold { font-weight: 700; }

/* -- RANK CIRCLE -- */
.rank-circle {
    display: inline-block;
    width: 20px;
    height: 20px;
    line-height: 20px;
    border-radius: 50%;
    text-align: center;
    font-size: 9px;
    font-weight: 700;
    color: #FAFAF8;
}
.rank-gold { background: #C8963E; }
.rank-gray { background: #9A9A9A; }

/* -- UNIT BAR CHART (vertical, CSS table) -- */
.unit-bar-table { width: 100%; border-collapse: collapse; }
.unit-bar-table td { vertical-align: bottom; text-align: center; padding: 0 2px; }
.unit-bar {
    display: inline-block;
    width: 36px;
    border-radius: 3px 3px 0 0;
    min-height: 2px;
}
.unit-bar-label {
    font-size: 8px;
    font-weight: 600;
    color: #FAFAF8;
    display: block;
    padding-top: 3px;
}
.unit-name-label {
    font-size: 8px;
    color: #6B6B6B;
    padding-top: 4px;
    transform: rotate(-45deg);
    display: inline-block;
    white-space: nowrap;
}

/* -- COLOUR BADGES (dynamic) -- */
.batch-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 8px;
    font-weight: 600;
}

/* -- TREND ARROWS -- */
.arrow-up { color: #C44D3F; font-weight: 700; }
.arrow-down { color: #4A7C59; font-weight: 700; }
.arrow-same { color: #9A9A9A; }

/* -- LEGEND -- */
.legend-table { border-collapse: collapse; margin: 8px 0; }
.legend-swatch {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 2px;
    vertical-align: middle;
    margin-right: 4px;
}
.legend-text { font-size: 10px; color: #6B6B6B; vertical-align: middle; }

/* -- SIGNATURE -- */
.signature-block {
    margin-top: 40px;
    page-break-inside: avoid;
}
.sig-label {
    font-size: 10px;
    color: #9A9A9A;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}
.sig-line { border-bottom: 1px solid #1A1A1A; padding-bottom: 3px; margin-bottom: 3px; }
.sig-name { font-size: 12px; font-weight: 500; color: #0A0A0A; }
.sig-company { font-size: 10px; color: #6B6B6B; }
.sig-date { font-size: 10px; color: #9A9A9A; }

/* -- FOOTER -- */
.report-footer {
    margin-top: 28px;
    padding-top: 14px;
    border-top: 3px solid #0A0A0A;
    page-break-inside: avoid;
}
.report-footer::after { content: ""; display: table; clear: both; }
.footer-left { float: left; }
.footer-right { float: right; text-align: right; font-size: 9px; color: #9A9A9A; line-height: 1.7; }
.footer-disclaimer {
    margin-top: 14px;
    padding: 8px 12px;
    background: #F5F3EE;
    font-size: 9px;
    color: #9A9A9A;
    text-align: center;
    letter-spacing: 0.3px;
}

/* -- DONUT (SVG) -- */
.donut-container { text-align: center; margin: 10px 0; }
.donut-legend { margin-top: 10px; font-size: 9px; text-align: center; line-height: 2; }
.legend-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 3px;
    vertical-align: middle;
}
.legend-item { margin-right: 8px; white-space: nowrap; }
.donut-label-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
.donut-label-table td { padding: 2px 6px; font-size: 10px; }
.donut-swatch {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    vertical-align: middle;
    margin-right: 4px;
}
</style>
</head>
<body>

{% if not is_pdf %}
<div class="toolbar">
    <a href="{{ url_for('analytics.reports') }}" class="btn-back">Back</a>
    <select onchange="if(this.value) window.location.href=this.value" class="btn-select">
        {% for opt in cycle_options %}
        <option value="{{ url_for('analytics.report_view', cycle_id=opt.id) }}">{{ opt.label }}</option>
        {% endfor %}
        <option value="{{ url_for('analytics.combined_report_view') }}" selected>All (Project Overview)</option>
    </select>
    <button onclick="window.print()" class="btn-print">Print</button>
    <a href="{{ url_for('analytics.combined_report_pdf') }}" class="btn-pdf">Download PDF</a>
</div>
{% endif %}

<div class="page" style="padding: 20px 10px;">

<!-- ============ HEADER ============ -->
<div class="report-header">
    <div class="header-top clearfix">
        <div class="logo-area">
            {% if logo_b64 %}
            <img src="data:image/jpeg;base64,{{ logo_b64 }}" alt="Monograph Architects">
            {% else %}
            <span class="logo-fallback">MONOGRAPH</span>
            <span class="logo-sub">architects</span>
            {% endif %}
        </div>
        <div class="header-meta">
            <div>BI-WEEKLY INSPECTION REPORT</div>
            <div class="date">{{ report_date }}</div>
        </div>
    </div>
    <div class="report-title">Power Park Student Housing - Phase 3</div>
    <div class="report-subtitle">Combined Project Report &bull; {{ batches|length }} Batches &bull; {{ total_units }} Units Inspected</div>
</div>

<!-- ============ KPI CARDS ============ -->
<table class="kpi-table"><tr>
    <td class="kpi-cell">
        <div class="kpi-label">Units Inspected</div>
        <div class="kpi-value">{{ total_units }}</div>
        <div class="kpi-sub">{% for b in batches %}{{ b.short_label }}: {{ b.total_units }}{% if not loop.last %} + {% endif %}{% endfor %}</div>
    </td>
    <td class="kpi-cell">
        <div class="kpi-label">Total Defects</div>
        <div class="kpi-value kpi-value-red">{{ total_defects }}</div>
        <div class="kpi-sub">across all areas</div>
    </td>
    <td class="kpi-cell">
        <div class="kpi-label">Avg Defects / Unit</div>
        <div class="kpi-value">{{ avg_defects }}</div>
        <div class="kpi-sub">median: {{ median_defects }}</div>
    </td>
    <td class="kpi-cell">
        <div class="kpi-label">Defect Rate</div>
        <div class="kpi-value">{{ defect_rate }}%</div>
        <div class="kpi-sub">items flagged</div>
    </td>
    <td class="kpi-cell">
        <div class="kpi-label">Certified</div>
        <div class="kpi-value">{{ certified_count }}</div>
        <div class="kpi-sub">of {{ total_units }} total</div>
    </td>
</tr></table>

<!-- ============ 01: BATCH COMPARISON ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">01</span>
        <span class="section-title">Batch Comparison</span>
    </div>
    <table class="batch-table">
    <tr>
        {% for batch in batches %}
        <td class="batch-cell" style="border-left: 4px solid {{ batch.colour }}; width: {{ (100 / batches|length)|int }}%;">
            <div class="batch-block-label">{{ batch.label }}</div>
            <table class="batch-stats-table">
            <tr>
                <td style="width:33%"><div class="batch-stat-value">{{ batch.total_units }}</div><div class="batch-stat-label">Units</div></td>
                <td style="width:33%"><div class="batch-stat-value" style="color:#C44D3F;">{{ batch.total_defects }}</div><div class="batch-stat-label">Defects</div></td>
                <td style="width:33%"><div class="batch-stat-value">{{ batch.avg_defects }}</div><div class="batch-stat-label">Avg / Unit</div></td>
            </tr>
            <tr>
                <td><div class="batch-stat-value">{{ batch.defect_rate }}%</div><div class="batch-stat-label">Defect Rate</div></td>
                <td><div class="batch-stat-value">{{ batch.unit_range }}</div><div class="batch-stat-label">Unit Range</div></td>
                <td><div class="batch-stat-value">{{ batch.inspection_date or '-' }}</div><div class="batch-stat-label">Inspected</div></td>
            </tr>
            </table>
        </td>
        {% endfor %}
    </tr>
    </table>

    {% set avg_values = batches | map(attribute='avg_defects') | list %}
    {% set min_avg = avg_values | min %}
    {% set max_avg = avg_values | max %}
    {% set min_batch = batches | selectattr('avg_defects', 'equalto', min_avg) | first %}
    {% set max_batch = batches | selectattr('avg_defects', 'equalto', max_avg) | first %}
    {% if max_avg - min_avg > 5 %}
    <div class="callout callout-gold">
        <strong>Note:</strong> Average defects per unit range from {{ min_avg }} ({{ min_batch.label }}) to {{ max_avg }} ({{ max_batch.label }}), a spread of {{ (max_avg - min_avg)|round(1) }} defects.
    </div>
    {% else %}
    <div class="callout callout-gold">
        <strong>Note:</strong> Average defects per unit are consistent across batches, ranging from {{ min_avg }} to {{ max_avg }}.
    </div>
    {% endif %}
</div>

<!-- ============ 02: DEFECT DENSITY GRID ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">02</span>
        <span class="section-title">Defect Density: Block &times; Floor</span>
    </div>

    {% if grid_blocks %}
    <table class="data-table" style="font-size: 11px;">
    <thead>
    <tr>
        <th style="width: 100px;">Floor</th>
        {% for blk in grid_blocks %}
        <th class="text-center">{{ blk }}</th>
        {% endfor %}
    </tr>
    </thead>
    <tbody>
    {% for flr in grid_floors %}
    <tr>
        <td style="font-weight: 600; color: #6B6B6B;">{{ floor_map.get(flr, 'Floor ' ~ flr) }}</td>
        {% for blk in grid_blocks %}
        {% if block_floor_grid.get(blk, {}).get(flr) %}
        {% set cell = block_floor_grid[blk][flr] %}
        {% if cell.avg > grid_median %}
        <td class="text-center" style="background: rgba(196,77,63,0.10); padding: 10px 8px;">
            <div style="font-family: 'Cormorant Garamond', Georgia, serif; font-size: 22px; font-weight: 300; color: #C44D3F;">{{ cell.avg }}</div>
            <div style="font-size: 9px; color: #6B6B6B;">{{ cell.defects }} defects</div>
            <div style="font-size: 9px; color: #9A9A9A;">{{ cell.units }} units &middot; {{ cell.defect_rate }}%</div>
        </td>
        {% elif cell.avg == grid_median %}
        <td class="text-center" style="background: rgba(200,150,62,0.10); padding: 10px 8px;">
            <div style="font-family: 'Cormorant Garamond', Georgia, serif; font-size: 22px; font-weight: 300; color: #C8963E;">{{ cell.avg }}</div>
            <div style="font-size: 9px; color: #6B6B6B;">{{ cell.defects }} defects</div>
            <div style="font-size: 9px; color: #9A9A9A;">{{ cell.units }} units &middot; {{ cell.defect_rate }}%</div>
        </td>
        {% else %}
        <td class="text-center" style="background: rgba(74,124,89,0.10); padding: 10px 8px;">
            <div style="font-family: 'Cormorant Garamond', Georgia, serif; font-size: 22px; font-weight: 300; color: #4A7C59;">{{ cell.avg }}</div>
            <div style="font-size: 9px; color: #6B6B6B;">{{ cell.defects }} defects</div>
            <div style="font-size: 9px; color: #9A9A9A;">{{ cell.units }} units &middot; {{ cell.defect_rate }}%</div>
        </td>
        {% endif %}
        {% else %}
        <td class="text-center" style="background: #F5F3EE; padding: 10px 8px;">
            <div style="font-family: 'Cormorant Garamond', Georgia, serif; font-size: 22px; font-weight: 300; color: #9A9A9A;">&mdash;</div>
            <div style="font-size: 9px; color: #9A9A9A;">No data</div>
        </td>
        {% endif %}
        {% endfor %}
    </tr>
    {% endfor %}
    </tbody>
    </table>

    <table class="legend-table">
    <tr>
        <td><span class="legend-swatch" style="background: rgba(74,124,89,0.25);"></span><span class="legend-text">Below median ({{ grid_median }})</span></td>
        <td style="padding-left: 10px;"><span class="legend-swatch" style="background: rgba(200,150,62,0.25);"></span><span class="legend-text">At median</span></td>
        <td style="padding-left: 10px;"><span class="legend-swatch" style="background: rgba(196,77,63,0.25);"></span><span class="legend-text">Above median</span></td>
    </tr>
    </table>

    <div class="callout callout-gold">
        <strong>Median average: {{ grid_median }} defects per unit.</strong> Values are coloured relative to this benchmark across all block/floor combinations.
    </div>
    {% else %}
    <div class="callout callout-gold">
        Density grid requires multiple block/floor combinations.
    </div>
    {% endif %}
</div>

<!-- ============ 03: DEFECTS BY AREA - BATCH COMPARISON ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">03</span>
        <span class="section-title">Defect Distribution by Area: Batch Comparison</span>
    </div>

    <div class="clearfix" style="margin-bottom: 16px;">
        <div style="float: left; width: 62%;">
            <!-- Grouped horizontal bars (one bar per batch per area) -->
            <table class="grouped-bar-table">
            {% for area in area_compare %}
            {% for bd in area.batches %}
            <tr>
                {% if loop.first %}
                <td class="bar-label-cell" rowspan="{{ batches|length }}">{{ area.name }}</td>
                {% endif %}
                <td class="bar-track">
                    <div class="bar-fill" style="width: {{ bd.pct }}%; background: {{ batches[loop.index0].colour }};"></div>
                    <span class="bar-count-label">{{ bd.count }}</span>
                </td>
            </tr>
            {% endfor %}
            <tr><td colspan="2" style="height: 10px;"></td></tr>
            {% endfor %}
            </table>
        </div>
        <div style="float: right; width: 34%;">
            <!-- Donut: combined totals -->
            <div class="donut-container">
                <svg viewBox="0 0 200 200" width="160" height="160">
                    {% for a in area_data %}
                    <circle cx="100" cy="100" r="70" fill="none"
                            stroke="{{ area_colours[loop.index0 % area_colours|length] }}"
                            stroke-width="30"
                            stroke-dasharray="{{ a.dash }} {{ 439.82 - a.dash }}"
                            stroke-dashoffset="{{ -a.offset }}"
                            transform="rotate(-90 100 100)"/>
                    {% endfor %}
                    {% for a in area_data %}
                    {% if a.pct >= 5 %}
                    <text x="{{ a.pct_x }}" y="{{ a.pct_y + 3 }}" text-anchor="middle"
                          font-family="'DM Sans', Helvetica, sans-serif" font-size="8" font-weight="600"
                          fill="white">{{ a.pct }}%</text>
                    {% endif %}
                    {% endfor %}
                    <circle cx="100" cy="100" r="52" fill="#FAFAF8" />
                    <text x="100" y="95" text-anchor="middle" font-family="'Cormorant Garamond', Georgia, serif" font-size="26" font-weight="300" fill="#0A0A0A">{{ total_defects }}</text>
                    <text x="100" y="112" text-anchor="middle" font-family="'DM Sans', Helvetica, sans-serif" font-size="9" fill="#9A9A9A">defects</text>
                </svg>
            </div>
            <div class="donut-legend">
                {% for a in area_data %}
                <span class="legend-item">
                    <span class="legend-dot" style="background: {{ area_colours[loop.index0 % area_colours|length] }};"></span>{{ a.area }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Batch legend -->
    <table class="legend-table">
    <tr>
        {% for batch in batches %}
        <td {% if not loop.first %}style="padding-left: 16px;"{% endif %}><span class="legend-swatch" style="background: {{ batch.colour }};"></span><span class="legend-text">{{ batch.label }}</span></td>
        {% endfor %}
    </tr>
    </table>

    {% if area_compare %}
    {% set max_area = area_compare[0] %}
    <div class="callout callout-gold">
        <strong>{{ max_area.name }}</strong> accounts for the highest defect concentration across all batches ({% for bd in max_area.batches %}{{ batches[loop.index0].short_label }}: {{ bd.count }}{% if not loop.last %}, {% endif %}{% endfor %}).
    </div>
    {% endif %}
</div>

<!-- ============ 04: AREA DEEP DIVE ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">04</span>
        <span class="section-title">Area Deep Dive</span>
    </div>
    <div class="clearfix">
        {% for area_info in combined_area_dive %}
        {% set outer_idx = loop.index0 %}
        <div style="float: {% if loop.first %}left{% else %}right{% endif %}; width: 48%;">
            <div style="background: #F5F3EE; border-left: 3px solid {{ area_colours[outer_idx % area_colours|length] }}; padding: 14px 16px;">
                <div style="font-size: 8px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: #6B6B6B; margin-bottom: 2px;">{{ area_info.area }}</div>
                <div style="margin-bottom: 10px;">
                    <span style="font-family: 'Cormorant Garamond', Georgia, serif; font-size: 24px; font-weight: 300; color: #0A0A0A;">{{ area_info.total }}</span>
                    <span style="font-size: 10px; color: #9A9A9A; margin-left: 4px;">of {{ total_defects }} defects ({{ area_info.pct }}%)</span>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    {% for d in area_info.defects %}
                    <tr>
                        <td style="width: 18px; vertical-align: top; padding: 4px 0;">
                            <div style="width: 18px; height: 18px; border-radius: 50%; background: {% if loop.first %}{{ area_colours[outer_idx % area_colours|length] }}{% else %}#F5F3EE; border: 1px solid #E8E6E1{% endif %}; color: {% if loop.first %}white{% else %}#6B6B6B{% endif %}; text-align: center; line-height: 18px; font-size: 8px; font-weight: 600;">{{ loop.index }}</div>
                        </td>
                        <td style="padding: 4px 8px; vertical-align: top;">
                            <div style="font-size: 10px; color: #1A1A1A; margin-bottom: 3px;">{{ d.description }}</div>
                            <div style="height: 3px; background: #E8E6E1; border-radius: 2px; overflow: hidden;">
                                <div style="height: 3px; border-radius: 2px; width: {{ d.bar_pct }}%; background: {{ area_colours[outer_idx % area_colours|length] }};"></div>
                            </div>
                        </td>
                        <td style="width: 90px; text-align: right; vertical-align: top; padding: 4px 0;">
                            <div style="font-size: 10px; font-weight: 600; color: #0A0A0A;">{{ d.total }}</div>
                            <div style="font-size: 8px; color: #9A9A9A;">
                                {% for cnt in d.batch_counts %}
                                <span style="color: {{ batches[loop.index0].colour }};">{{ batches[loop.index0].short_label }}: {{ cnt }}</span>{% if not loop.last %} {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if combined_area_dive|length >= 2 and combined_area_dive[0].defects and combined_area_dive[1].defects %}
    <div class="callout callout-gold" style="margin-top: 12px;">
        <strong>Key finding:</strong>
        The most frequent defect in {{ combined_area_dive[0].area }} is {{ combined_area_dive[0].defects[0].description|lower }} ({{ combined_area_dive[0].defects[0].total }} total).
        In {{ combined_area_dive[1].area }}, {{ combined_area_dive[1].defects[0].description|lower }} leads with {{ combined_area_dive[1].defects[0].total }}.
    </div>
    {% endif %}
</div>

<!-- ============ 05: MOST COMMON DEFECT TYPES ============ -->
<div class="section" style="page-break-before: always;">
    <div class="section-header">
        <span class="section-number">05</span>
        <span class="section-title">Most Common Defect Types: Batch Analysis</span>
    </div>

    <table class="data-table">
    <thead>
    <tr>
        <th style="width: 30px;">#</th>
        <th>Description</th>
        <th class="text-center" style="width: 50px;">Total</th>
        {% for batch in batches %}
        <th class="text-center" style="width: 50px;">{{ batch.short_label }}</th>
        {% endfor %}
        <th style="width: 100px;">Distribution</th>
    </tr>
    </thead>
    <tbody>
    {% for d in top_defects_compare %}
    <tr>
        <td class="text-center">
            {% if loop.index <= 3 %}
            <span class="rank-circle rank-gold">{{ loop.index }}</span>
            {% else %}
            <span class="rank-circle rank-gray">{{ loop.index }}</span>
            {% endif %}
        </td>
        <td>{{ d.description }}</td>
        <td class="text-center font-bold">{{ d.total }}</td>
        {% for cnt in d.batch_counts %}
        <td class="text-center">
            <span class="batch-badge" style="background: {{ batches[loop.index0].colour_bg }}; color: {{ batches[loop.index0].colour }};">{{ cnt }}</span>
        </td>
        {% endfor %}
        <td>
            <div style="display: inline-block; width: {{ d.bar_pct }}%; height: 10px; background: #C8963E; border-radius: 2px; vertical-align: middle;"></div>
        </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>

    {% set zero_in_first = [] %}
    {% for d in top_defects_compare %}
        {% if d.batch_counts[0] == 0 %}
            {% if zero_in_first.append(d) %}{% endif %}
        {% endif %}
    {% endfor %}
    {% if zero_in_first %}
    <div class="callout callout-blue">
        <strong>New patterns:</strong> {{ zero_in_first|length }} defect type(s) in the top 15 do not appear in {{ batches[0].label }}, suggesting new quality issues in later batches: {% for d in zero_in_first[:3] %}<em>{{ d.description }}</em>{% if not loop.last %}, {% endif %}{% endfor %}.
    </div>
    {% endif %}
</div>

<!-- ============ 06: DEFECTS BY CATEGORY (TRADE) ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">06</span>
        <span class="section-title">Defects by Category (Trade): Batch Comparison</span>
    </div>

    <div class="clearfix">
        <div style="float: left; width: 100%;">
            <table class="grouped-bar-table">
            {% for trade in trade_compare %}
            {% for bd in trade.batches %}
            <tr>
                {% if loop.first %}
                <td class="bar-label-cell" rowspan="{{ batches|length }}">{{ trade.name }}</td>
                {% endif %}
                <td class="bar-track">
                    <div class="bar-fill" style="width: {{ bd.pct }}%; background: {{ batches[loop.index0].colour }};"></div>
                    <span class="bar-count-label">{{ bd.count }}</span>
                </td>
            </tr>
            {% endfor %}
            <tr><td colspan="2" style="height: 10px;"></td></tr>
            {% endfor %}
            </table>
        </div>
    </div>

    <table class="legend-table">
    <tr>
        {% for batch in batches %}
        <td {% if not loop.first %}style="padding-left: 16px;"{% endif %}><span class="legend-swatch" style="background: {{ batch.colour }};"></span><span class="legend-text">{{ batch.label }}</span></td>
        {% endfor %}
    </tr>
    </table>

    {% if trade_compare %}
    <div class="callout callout-gold">
        <strong>{{ trade_compare[0].name }}</strong> accounts for the highest trade concentration with {{ trade_compare[0].total }} defects across all batches.
    </div>
    {% endif %}
</div>

<!-- ============ 07: SYSTEMIC ISSUES ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">07</span>
        <span class="section-title">Systemic Issues (Recurring Defects)</span>
    </div>

    {% if recurring %}
    <div style="font-size: 10px; color: #6B6B6B; margin-bottom: 12px;">
        Defects appearing in 3 or more units &mdash; address these project-wide, not unit-by-unit.
    </div>

    <table class="data-table">
    <thead>
    <tr>
        <th style="width: 30px;">#</th>
        <th>Defect Description</th>
        <th class="text-center" style="width: 50px;">Count</th>
        <th style="width: 90px;">Category</th>
        <th>Affected Units</th>
    </tr>
    </thead>
    <tbody>
    {% for r in recurring %}
    <tr>
        <td class="text-center">
            {% if loop.index <= 3 %}
            <span class="rank-circle rank-gold">{{ loop.index }}</span>
            {% else %}
            <span class="rank-circle rank-gray">{{ loop.index }}</span>
            {% endif %}
        </td>
        <td>{{ r.original_comment }}</td>
        <td class="text-center font-bold" style="color: #C44D3F;">{{ r.cnt }}</td>
        <td style="font-size: 9px; color: #6B6B6B;">{{ r.category_name }}</td>
        <td style="font-size: 9px; color: #9A9A9A;">{{ r.affected_units }}</td>
    </tr>
    {% endfor %}
    </tbody>
    </table>

    <div class="callout callout-red">
        <strong>{{ recurring|length }} systemic issue{{ 's' if recurring|length != 1 else '' }}</strong> identified across the project. These defects appear in 3 or more units, indicating patterns that may require trade-wide intervention rather than unit-by-unit rectification.
    </div>
    {% else %}
    <div class="callout callout-green">
        No recurring defects found across 3 or more units.
    </div>
    {% endif %}
</div>

<!-- ============ 08: DEFECT COUNT BY UNIT ============ -->
<div class="section">
    <div class="section-header">
        <span class="section-number">08</span>
        <span class="section-title">Defect Count by Unit</span>
    </div>

    {% for batch in batches %}
    <div style="margin-{% if loop.first %}bottom{% else %}top{% endif %}: {% if loop.first %}0{% else %}24{% endif %}px; margin-bottom: 0;">
        <div style="font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: {{ batch.colour }}; margin-bottom: 12px;">{{ batch.label }} &mdash; Units {{ batch.unit_range }}</div>
        <div style="position: relative; overflow-x: auto;">
            <!-- Average line -->
            {% set avg_line_h = (batch.avg_defects / max_defects * 140)|int if max_defects > 0 else 0 %}
            <div style="position: absolute; left: 0; right: 40px; bottom: {{ avg_line_h + 38 }}px; border-top: 2px dashed {{ batch.colour }}; opacity: 0.5; z-index: 1;"></div>
            <table class="unit-bar-table" style="height: 180px; position: relative; z-index: 2;">
            <tr>
            {% for u in batch.unit_defects %}
                <td style="height: 160px; vertical-align: bottom;">
                    {% set bar_height = (u.defect_count / max_defects * 140)|int if max_defects > 0 else 2 %}
                    {% if u.defect_count > 30 %}{% set bar_colour = '#C44D3F' %}{% elif u.defect_count > 20 %}{% set bar_colour = '#C8963E' %}{% else %}{% set bar_colour = '#4A7C59' %}{% endif %}
                    <div class="unit-bar" style="height: {{ bar_height }}px; background: {{ bar_colour }};">
                        <span class="unit-bar-label">{{ u.defect_count }}</span>
                    </div>
                </td>
            {% endfor %}
            </tr>
            <tr style="border-top: 1px solid #E5E5E5;">
            {% for u in batch.unit_defects %}<td style="padding-top: 4px;"><span class="unit-name-label">{{ u.unit_number }}</span></td>{% endfor %}
            </tr>
            </table>
        </div>
        <div class="callout {% if loop.index0 == 0 %}callout-gold{% elif loop.index0 == 1 %}callout-blue{% else %}callout-gold{% endif %}" style="margin-top: 8px; margin-bottom: 0;">
            <strong>{{ batch.label }} average: {{ batch.avg_defects }} defects/unit.</strong>
            {{ batch.high_defect_count }} of {{ batch.total_units }} units exceed 30 defects.
            {% if batch.worst_unit.defect_count > 0 %}Worst: {{ batch.worst_unit.unit_number }} with {{ batch.worst_unit.defect_count }}.{% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Legend -->
    <table class="legend-table" style="margin-top: 14px;">
    <tr>
        <td><span class="legend-swatch" style="background: #4A7C59;"></span><span class="legend-text">&le;20 defects</span></td>
        <td style="padding-left: 10px;"><span class="legend-swatch" style="background: #C8963E;"></span><span class="legend-text">21-30</span></td>
        <td style="padding-left: 10px;"><span class="legend-swatch" style="background: #C44D3F;"></span><span class="legend-text">&gt;30</span></td>
        <td style="padding-left: 16px;"><span style="display: inline-block; width: 16px; height: 0; border-top: 2px dashed #6B6B6B; vertical-align: middle;"></span><span class="legend-text" style="padding-left: 4px;">Batch average</span></td>
    </tr>
    </table>

    <div class="callout callout-gold">
        <strong>Project average: {{ avg_defects }} defects per unit</strong> across {{ total_units }} units. {{ high_defect_units }} ({{ high_defect_pct }}%) exceed 30 defects.
    </div>
</div>

<!-- ============ 09: UNIT SUMMARY TABLE ============ -->
<div class="section" style="page-break-before: always;">
    <div class="section-header">
        <span class="section-number">09</span>
        <span class="section-title">Unit Summary Table</span>
    </div>

    <table class="data-table">
    <thead>
    <tr>
        <th>Unit</th>
        <th>Batch</th>
        <th>Floor</th>
        <th class="text-right">Defects</th>
        <th class="text-right">Defect Rate</th>
        <th class="text-center">Status</th>
    </tr>
    </thead>
    <tbody>
    {% for u in unit_table %}
    <tr>
        <td class="font-bold">{{ u.unit_number }}</td>
        <td>
            <span class="batch-badge" style="background: {{ u.batch_colour_bg }}; color: {{ u.batch_colour }};">{{ u.batch_short }}</span>
        </td>
        <td>{{ floor_map.get(u.floor, u.floor) if u.floor is not none else '' }}</td>
        <td class="text-right font-bold">{{ u.defect_count }}</td>
        <td class="text-right">{{ u.defect_rate }}%</td>
        <td class="text-center">
            {% if u.insp_status in ['approved', 'certified', 'pending_followup'] %}
            <span class="status-badge badge-approved">Issued to Site</span>
            {% else %}
            <span class="status-badge badge-reviewed">Inspected</span>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
    <tfoot>
    <tr>
        <td colspan="3" class="font-bold">TOTAL / AVERAGE</td>
        <td class="text-right font-bold">{{ total_defects }}</td>
        <td class="text-right font-bold">{{ defect_rate }}%</td>
        <td class="text-center">
            <span class="batch-badge" style="background: rgba(61,107,142,0.12); color: #3D6B8E;">{{ total_units }} units</span>
        </td>
    </tr>
    </tfoot>
    </table>
</div>

<!-- ============ SIGNATURE BLOCK ============ -->
<div class="signature-block">
    <div class="sig-label">Prepared by</div>
    <div class="sig-line">
        <span class="sig-name">Kevin Coetzee</span>
    </div>
    <div class="sig-company">PrArch, MD</div>
    <div class="sig-company">Monograph Architects</div>
    <div class="sig-date">{{ report_date }}</div>
</div>

<!-- ============ FOOTER ============ -->
<div class="report-footer clearfix">
    <div class="footer-left">
        {% if logo_b64 %}
        <img src="data:image/jpeg;base64,{{ logo_b64 }}" alt="Monograph" style="height: 24px; width: auto;">
        {% else %}
        <span class="logo-fallback" style="font-size: 16px;">MONOGRAPH</span>
        {% endif %}
        <div style="font-size: 9px; color: #9A9A9A; margin-top: 4px;">
            Power Park Student Housing - Phase 3 &middot; Combined Report
        </div>
    </div>
    <div class="footer-right">
        Generated {{ report_date }}
    </div>
</div>
<div class="footer-disclaimer">
    This report is generated from live inspection data. All figures are as recorded at time of generation.
    For queries, contact Monograph Architects.
</div>

</div><!-- /.page -->
</body>
</html>
