{% extends "base.html" %}

{% block title %}Approvals{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header with cycle progress -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Approvals</h1>
            {% if summary.closed_count > 0 %}
            <p class="text-sm text-gray-500 mt-1">
                {{ summary.closed_count }} of {{ summary.total }} units closed
                <span class="text-gray-400">({{ ((summary.closed_count / summary.total) * 100) | int }}%)</span>
            </p>
            {% endif %}
        </div>
        
        <!-- Cycle Filter -->
        <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Cycle:</label>
            <select onchange="window.location.href='?cycle=' + this.value" 
                    class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                <option value="">All Cycles</option>
                {% for cycle in active_cycles %}
                <option value="{{ cycle.id }}" {% if cycle_filter == cycle.id %}selected{% endif %}>
                    Cycle {{ cycle.cycle_number }} - {{ cycle.phase_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Cycle progress bar - only show when there's progress -->
    {% if summary.closed_count > 0 and summary.total > 0 %}
    <div class="mb-6">
        <div class="w-full bg-gray-200 rounded-full h-2.5">
            {% set close_pct = ((summary.closed_count / summary.total) * 100) | int %}
            <div class="h-2.5 rounded-full {% if close_pct == 100 %}bg-green-500{% elif close_pct > 50 %}bg-blue-500{% else %}bg-blue-400{% endif %}" 
                 style="width: {{ close_pct }}%"></div>
        </div>
    </div>
    {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="p-3 rounded-lg border {% if category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-green-50 border-green-200 text-green-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Status Groups -->
    {% set display_order = ['awaiting_review', 'awaiting_approval', 'approved', 'in_progress', 'not_started', 'certified', 'pending_followup'] %}
    
    {% for status_key in display_order %}
    {% set units = grouped[status_key] %}
    {% set info = status_info[status_key] %}
    {% if units %}
    <div class="mb-6">
        
        {% if status_key == 'not_started' %}
        <!-- NOT STARTED: Collapsed by default, simple unit list -->
        <a href="javascript:void(0)"
           onclick="var c=document.getElementById('not-started-content');var ch=this.querySelector('.ns-chevron');c.classList.toggle('hidden');ch.classList.toggle('rotate-90');return false"
           ontouchend="event.preventDefault();this.click()"
           class="flex items-center gap-2 mb-1 select-none"
           style="text-decoration:none">
            <svg class="ns-chevron w-4 h-4 text-gray-400 transform transition-transform duration-200 flex-shrink-0"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <h2 class="text-lg font-semibold text-gray-800">{{ info.title }}</h2>
            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700">
                {{ units|length }}
            </span>
            <span class="text-sm text-gray-400">units waiting for inspection</span>
        </a>
        <div id="not-started-content" class="hidden mt-3">
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex flex-wrap gap-2">
                    {% for unit in units %}
                    <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}"
                       class="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-200 rounded hover:bg-blue-50 hover:text-blue-700 hover:border-blue-200 transition-colors">
                        Unit {{ unit.unit_number }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        {% elif status_key == 'in_progress' %}
        <!-- IN PROGRESS: Compact view - inspector is still working -->
        <div class="flex items-center gap-2 mb-1">
            <h2 class="text-lg font-semibold text-gray-800">{{ info.title }}</h2>
            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700">
                {{ units|length }}
            </span>
        </div>
        <p class="text-sm text-gray-500 mb-3">{{ info.description }}</p>
        
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Inspector</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for unit in units %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            {% if status_key == 'awaiting_approval' and user_role not in ['manager', 'admin'] %}
                            <span class="font-medium text-gray-800">Unit {{ unit.unit_number }}</span>
                            {% else %}
                            <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}" 
                               class="font-medium text-blue-600 hover:text-blue-800">
                                Unit {{ unit.unit_number }}
                            </a>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ unit.last_inspector or '-' }}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.total_items and unit.total_items > 0 %}
                            {% set checkable = unit.total_items - (unit.excluded_items or 0) %}
                            {% set done = (unit.completed_items or 0) - (unit.excluded_items or 0) %}
                            {% set pct = (done * 100 / checkable) | int if checkable > 0 else 0 %}
                            <div class="flex items-center gap-2">
                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full {% if pct == 100 %}bg-green-500{% elif pct > 50 %}bg-blue-500{% else %}bg-yellow-500{% endif %}" 
                                         style="width: {{ pct }}%"></div>
                                </div>
                                <span class="text-xs text-gray-500">{{ done }}/{{ checkable }}</span>
                            </div>
                            {% else %}
                            <span class="text-gray-400 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}"
                               class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100">
                                Open
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% else %}
        <!-- ACTIONABLE SECTIONS: Full table with all details -->
        <div class="flex items-center gap-2 mb-1">
            <h2 class="text-lg font-semibold text-gray-800">{{ info.title }}</h2>
            <span class="px-2 py-0.5 text-xs font-medium rounded-full
                {% if info.color == 'purple' %}bg-purple-100 text-purple-700
                {% elif info.color == 'indigo' %}bg-indigo-100 text-indigo-700
                {% elif info.color == 'emerald' %}bg-emerald-100 text-emerald-700
                {% elif info.color == 'green' %}bg-green-100 text-green-700
                {% elif info.color == 'orange' %}bg-orange-100 text-orange-700
                {% elif info.color == 'red' %}bg-red-100 text-red-700
                {% else %}bg-gray-100 text-gray-700{% endif %}">
                {{ units|length }}
            </span>
        </div>
        <p class="text-sm text-gray-500 mb-3">{{ info.description }}</p>
        
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Inspector</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Defects</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cycle</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for unit in units %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            {% if status_key == 'awaiting_approval' and user_role not in ['manager', 'admin'] %}
                            <span class="font-medium text-gray-800">Unit {{ unit.unit_number }}</span>
                            {% else %}
                            <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}" 
                               class="font-medium text-blue-600 hover:text-blue-800">
                                Unit {{ unit.unit_number }}
                            </a>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ unit.last_inspector or '-' }}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.total_items and unit.total_items > 0 %}
                            {% set checkable = unit.total_items - (unit.excluded_items or 0) %}
                            {% set done = (unit.completed_items or 0) - (unit.excluded_items or 0) %}
                            {% set pct = (done * 100 / checkable) | int if checkable > 0 else 0 %}
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2">
                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full {% if pct == 100 %}bg-green-500{% elif pct > 50 %}bg-blue-500{% else %}bg-yellow-500{% endif %}" 
                                             style="width: {{ pct }}%"></div>
                                    </div>
                                    <span class="text-xs text-gray-500">{{ done }}/{{ checkable }}</span>
                                </div>
                                {% if unit.excluded_items and unit.excluded_items > 0 %}
                                <span class="text-xs text-orange-500">{{ unit.excluded_items }} excl</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-gray-400 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.defect_items and unit.defect_items > 0 %}
                            <span class="text-red-600 font-medium">{{ unit.defect_items }}</span>
                            {% elif unit.open_defects and unit.open_defects > 0 %}
                            <span class="text-red-600 font-medium">{{ unit.open_defects }}</span>
                            {% elif unit.cleared_defects and unit.cleared_defects > 0 %}
                            <span class="text-green-600">{{ unit.cleared_defects }} cleared</span>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {% if unit.current_cycle %}{{ unit.current_cycle }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2 flex-wrap">
                                <!-- Open inspection -->
                                {% if not (status_key == 'awaiting_approval' and user_role not in ['manager', 'admin']) %}
                                <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}"
                                   class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100">
                                    {% if status_key == 'awaiting_review' %}Review{% elif status_key in ['certified', 'pending_followup'] %}View{% else %}Open{% endif %}
                                </a>
                                {% endif %}
                                
                                {% if status_key == 'awaiting_review' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>






                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.approve_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-sm">
                                            Approve
                                        </button>
                                    </form>
                                    {% else %}
                                    <form action="{{ url_for('certification.review_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-4 py-2 text-sm font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 shadow-sm">
                                            Send to Manager
                                        </button>
                                    </form>
                                    {% endif %}
                                
                                {% elif status_key == 'awaiting_approval' %}
                                    {% if user_role in ['manager', 'admin'] %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    <form action="{{ url_for('certification.approve_and_close', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 shadow-sm">
                                            Approve &amp; Close
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="text-sm text-gray-400 italic">Reviewed - Manager will approve</span>
                                    {% endif %}
                                
                                {% elif status_key == 'approved' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    {% if user_role in ['manager', 'admin'] %}
                                        {% if unit.open_defects == 0 or unit.open_defects is none %}
                                        <form action="{{ url_for('certification.certify_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                            <button type="submit" 
                                                    class="px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 shadow-sm">
                                                Sign Off Complete
                                            </button>
                                        </form>
                                        {% else %}
                                        <form action="{{ url_for('certification.close_with_defects', unit_id=unit.id) }}" method="POST" class="inline">
                                            <button type="submit" 
                                                    class="px-4 py-2 text-sm font-semibold text-white bg-orange-500 rounded-lg hover:bg-orange-600 shadow-sm">
                                                Close Unit - Defects Remain
                                            </button>
                                        </form>
                                        {% endif %}
                                    {% endif %}
                                
                                {% elif status_key == 'certified' %}
                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.reopen_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200">
                                            Reopen
                                        </button>
                                    </form>
                                    {% endif %}
                                
                                {% elif status_key == 'pending_followup' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.reopen_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200">
                                            Reopen
                                        </button>
                                    </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% endfor %}

    {% if summary.total == 0 %}
    <div class="text-center py-12 bg-white rounded-lg border border-gray-200">
        <p class="text-gray-500">No units found for the selected cycle.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if request.args.get('download') %}
<script>
window.addEventListener('load', function() {
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = '/pdf/defects/' + '{{ request.args.get("download") }}';
    document.body.appendChild(iframe);
});
</script>
{% endif %}
{% endblock %}
