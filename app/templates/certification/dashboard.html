{% extends "base.html" %}

{% block title %}Approvals{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header with cycle progress -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Approvals</h1>
            <p class="text-sm text-gray-500 mt-1">
                {{ summary.closed_count }} of {{ summary.total }} units closed
                {% if summary.total > 0 %}
                <span class="text-gray-400">({{ ((summary.closed_count / summary.total) * 100) | int }}%)</span>
                {% endif %}
            </p>
        </div>
        
        <!-- Cycle Filter -->
        <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Cycle:</label>
            <select onchange="window.location.href='?cycle=' + this.value" 
                    class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                <option value="">All Cycles</option>
                {% for cycle in active_cycles %}
                <option value="{{ cycle.id }}" {% if cycle_filter == cycle.id %}selected{% endif %}>
                    Cycle {{ cycle.cycle_number }} - {{ cycle.phase_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Cycle progress bar -->
    {% if summary.total > 0 %}
    <div class="mb-6">
        <div class="w-full bg-gray-200 rounded-full h-2.5">
            {% set close_pct = ((summary.closed_count / summary.total) * 100) | int %}
            <div class="h-2.5 rounded-full {% if close_pct == 100 %}bg-green-500{% elif close_pct > 50 %}bg-blue-500{% else %}bg-gray-400{% endif %}" 
                 style="width: {{ close_pct }}%"></div>
        </div>
    </div>
    {% endif %}

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3 mb-6">
        <div class="bg-white rounded-lg p-3 border border-gray-200 text-center">
            <div class="text-2xl font-bold text-gray-900">{{ summary.total }}</div>
            <div class="text-xs text-gray-500">Total</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-3 border border-purple-200 text-center">
            <div class="text-2xl font-bold text-purple-700">{{ summary.awaiting_review }}</div>
            <div class="text-xs text-purple-600">Needs Review</div>
        </div>
        <div class="bg-indigo-50 rounded-lg p-3 border border-indigo-200 text-center">
            <div class="text-2xl font-bold text-indigo-700">{{ summary.awaiting_approval }}</div>
            <div class="text-xs text-indigo-600">Needs Sign-off</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-3 border border-emerald-200 text-center">
            <div class="text-2xl font-bold text-emerald-700">{{ summary.approved }}</div>
            <div class="text-xs text-emerald-600">Ready to Close</div>
        </div>
        <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200 text-center">
            <div class="text-2xl font-bold text-yellow-700">{{ summary.in_progress }}</div>
            <div class="text-xs text-yellow-600">Inspecting</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 text-center">
            <div class="text-2xl font-bold text-gray-400">{{ summary.not_started }}</div>
            <div class="text-xs text-gray-400">Queued</div>
        </div>
        <div class="bg-green-50 rounded-lg p-3 border border-green-200 text-center">
            <div class="text-2xl font-bold text-green-700">{{ summary.certified }}</div>
            <div class="text-xs text-green-600">Done</div>
        </div>
        <div class="bg-orange-50 rounded-lg p-3 border border-orange-200 text-center">
            <div class="text-2xl font-bold text-orange-700">{{ summary.pending_followup }}</div>
            <div class="text-xs text-orange-600">Has Defects</div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="p-3 rounded-lg border {% if category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-green-50 border-green-200 text-green-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Status Groups -->
    {% set display_order = ['awaiting_review', 'awaiting_approval', 'approved', 'in_progress', 'not_started', 'certified', 'pending_followup'] %}
    
    {% for status_key in display_order %}
    {% set units = grouped[status_key] %}
    {% set info = status_info[status_key] %}
    {% if units %}
    <div class="mb-6">
        <div class="flex items-center gap-2 mb-1">
            <h2 class="text-lg font-semibold text-gray-800">{{ info.title }}</h2>
            <span class="px-2 py-0.5 text-xs font-medium rounded-full
                {% if info.color == 'purple' %}bg-purple-100 text-purple-700
                {% elif info.color == 'indigo' %}bg-indigo-100 text-indigo-700
                {% elif info.color == 'emerald' %}bg-emerald-100 text-emerald-700
                {% elif info.color == 'green' %}bg-green-100 text-green-700
                {% elif info.color == 'orange' %}bg-orange-100 text-orange-700
                {% elif info.color == 'yellow' %}bg-yellow-100 text-yellow-700
                {% elif info.color == 'red' %}bg-red-100 text-red-700
                {% else %}bg-gray-100 text-gray-700{% endif %}">
                {{ units|length }}
            </span>
        </div>
        <p class="text-sm text-gray-500 mb-3">{{ info.description }}</p>
        
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Inspector</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Defects</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cycle</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for unit in units %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}" 
                               class="font-medium text-blue-600 hover:text-blue-800">
                                Unit {{ unit.unit_number }}
                            </a>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ unit.last_inspector or '-' }}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.total_items and unit.total_items > 0 %}
                            {% set checkable = unit.total_items - (unit.excluded_items or 0) %}
                            {% set done = (unit.completed_items or 0) - (unit.excluded_items or 0) %}
                            {% set pct = (done * 100 / checkable) | int if checkable > 0 else 0 %}
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2">
                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full {% if pct == 100 %}bg-green-500{% elif pct > 50 %}bg-blue-500{% else %}bg-yellow-500{% endif %}" 
                                             style="width: {{ pct }}%"></div>
                                    </div>
                                    <span class="text-xs text-gray-500">{{ done }}/{{ checkable }}</span>
                                </div>
                                {% if unit.excluded_items and unit.excluded_items > 0 %}
                                <span class="text-xs text-orange-500">{{ unit.excluded_items }} excl</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-gray-400 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if unit.defect_items and unit.defect_items > 0 %}
                            <span class="text-red-600 font-medium">{{ unit.defect_items }}</span>
                            {% elif unit.open_defects and unit.open_defects > 0 %}
                            <span class="text-red-600 font-medium">{{ unit.open_defects }}</span>
                            {% elif unit.cleared_defects and unit.cleared_defects > 0 %}
                            <span class="text-green-600">{{ unit.cleared_defects }} cleared</span>
                            {% else %}
                            <span class="text-green-600">0</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {% if unit.current_cycle %}{{ unit.current_cycle }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2 flex-wrap">
                                <!-- Open inspection - always visible -->
                                <a href="{{ url_for('certification.view_unit', unit_id=unit.id) }}"
                                   class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100">
                                    Open
                                </a>
                                
                                {% if status_key == 'awaiting_review' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    <form action="{{ url_for('certification.review_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-white bg-purple-600 rounded hover:bg-purple-700">
                                            Confirm Reviewed
                                        </button>
                                    </form>
                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.approve_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700">
                                            Approve
                                        </button>
                                    </form>
                                    {% endif %}
                                
                                {% elif status_key == 'awaiting_approval' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.approve_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700">
                                            Approve
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="text-xs text-gray-400 italic">Waiting for Architect</span>
                                    {% endif %}
                                
                                {% elif status_key == 'approved' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    {% if user_role in ['manager', 'admin'] %}
                                        {% if unit.open_defects == 0 or unit.open_defects is none %}
                                        <form action="{{ url_for('certification.certify_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                            <button type="submit" 
                                                    class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700">
                                                Sign Off Complete
                                            </button>
                                        </form>
                                        {% else %}
                                        <form action="{{ url_for('certification.close_with_defects', unit_id=unit.id) }}" method="POST" class="inline">
                                            <button type="submit" 
                                                    class="px-3 py-1.5 text-xs font-medium text-white bg-orange-500 rounded hover:bg-orange-600">
                                                Close Unit - Defects Remain
                                            </button>
                                        </form>
                                        {% endif %}
                                    {% endif %}
                                
                                {% elif status_key == 'certified' %}
                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.reopen_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200">
                                            Reopen
                                        </button>
                                    </form>
                                    {% endif %}
                                
                                {% elif status_key == 'pending_followup' %}
                                    <a href="{{ url_for('pdf.preview_defects_pdf', unit_id=unit.id) }}"
                                       class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                        PDF
                                    </a>
                                    {% if user_role in ['manager', 'admin'] %}
                                    <form action="{{ url_for('certification.reopen_unit', unit_id=unit.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200">
                                            Reopen
                                        </button>
                                    </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endfor %}

    {% if summary.total == 0 %}
    <div class="text-center py-12 bg-white rounded-lg border border-gray-200">
        <p class="text-gray-500">No units found for the selected cycle.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
