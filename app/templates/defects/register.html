{% extends "base.html" %}
{% block title %}Defects Register{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="text-xl font-bold text-gray-800">Defects Register</h1>
    {% if project and phase %}
    <p class="text-sm text-gray-500">{{ project.project_name }} | {{ phase.phase_name }}</p>
    {% endif %}
</div>

<!-- Stats -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-gray-800">{{ stats.total or 0 }}</div>
        <div class="text-xs text-gray-500">Total Defects</div>
    </div>
    <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-danger">{{ stats.open_count or 0 }}</div>
        <div class="text-xs text-gray-500">Open</div>
    </div>
    <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-success">{{ stats.cleared_count or 0 }}</div>
        <div class="text-xs text-gray-500">Cleared</div>
    </div>
    <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-gray-600">{{ stats.units_with_defects or 0 }}</div>
        <div class="text-xs text-gray-500">Units Affected</div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <form method="get" class="flex flex-wrap gap-3 items-center">
        <select name="status" class="px-3 py-2 border rounded text-sm" onchange="this.form.submit()">
            <option value="open" {% if filters.status == 'open' %}selected{% endif %}>Open Only</option>
            <option value="cleared" {% if filters.status == 'cleared' %}selected{% endif %}>Cleared Only</option>
            <option value="all" {% if filters.status == 'all' %}selected{% endif %}>All</option>
        </select>
        
        {% if blocks %}
        <select name="block" class="px-3 py-2 border rounded text-sm" onchange="this.form.submit()">
            <option value="">All Blocks</option>
            {% for b in blocks %}
            <option value="{{ b.block }}" {% if filters.block == b.block %}selected{% endif %}>
                Block {{ b.block }}
            </option>
            {% endfor %}
        </select>
        {% endif %}
        
        {% if today %}
        <span class="text-sm text-gray-500 ml-auto">
            Generated: {{ today }}
        </span>
        {% endif %}
    </form>
</div>

<!-- Defects Grouped by Unit -> Area -> Category -->
{% if grouped_defects %}
    {% for unit_code, unit_data in grouped_defects.items() %}
    <details class="bg-white rounded-lg shadow mb-4 overflow-hidden" open>
        <!-- Unit Header -->
        <summary class="bg-blue-800 text-white px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-blue-700">
            <div class="flex items-center gap-3">
                <span class="font-semibold">Unit {{ unit_code }}</span>
                {% if unit_data.raised_cycle %}
                <span class="text-xs bg-white/20 px-2 py-0.5 rounded">Cycle {{ unit_data.raised_cycle }}</span>
                {% endif %}
            </div>
            <span class="text-sm bg-white/20 px-2 py-1 rounded">{{ unit_data.defect_count }} defect{% if unit_data.defect_count != 1 %}s{% endif %}</span>
        </summary>
        
        <!-- Areas and Categories -->
        <div class="divide-y divide-gray-200">
            {% for area_name, area_data in unit_data.areas.items() %}
                {% for cat_name, cat_data in area_data.categories.items() %}
                <!-- Category Header -->
                <div class="bg-gray-100 px-4 py-2 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-semibold text-gray-800">{{ area_name }}</span>
                            <span class="text-gray-500 mx-2">&rsaquo;</span>
                            <span class="text-gray-700">{{ cat_name }}</span>
                        </div>
                        <span class="text-xs text-gray-500">{{ cat_data.defects|length }} item{% if cat_data.defects|length != 1 %}s{% endif %}</span>
                    </div>
                    {% if cat_data.note %}
                    <div class="text-sm text-amber-700 mt-1 italic">Note: {{ cat_data.note }}</div>
                    {% endif %}
                </div>
                
                <!-- Defects in this category -->
                <table class="min-w-full">
                    <tbody class="divide-y divide-gray-100">
                        {% for d in cat_data.defects %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-sm text-gray-900 w-1/3">
                                {% if d.parent_description %}
                                <span class="text-xs text-gray-500">{{ d.parent_description }} &rsaquo;</span><br>
                                {% endif %}
                                {{ d.item_description }}
                            </td>
                            <td class="px-4 py-2 text-sm text-red-700">
                                {{ d.defect_comment or '-' }}
                            </td>
                            <td class="px-4 py-2 text-xs text-gray-500 w-24">
                                {{ d.created_at[:10] if d.created_at else '' }}<br>
                                <span class="text-gray-400">{{ d.inspector_name or '' }}</span>
                            </td>
                            <td class="px-4 py-2 text-center w-16">
                                {% set status = d.defect_status if d.defect_status else d.status %}
                                {% if status == 'open' %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-800">Open</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-800">Cleared</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endfor %}
            {% endfor %}
        </div>
    </details>
    {% endfor %}
{% else %}
<div class="bg-white rounded-lg shadow p-8 text-center">
    <p class="text-gray-500">No defects match the selected filters.</p>
</div>
{% endif %}
{% endblock %}
